<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股專業分析系統 | Professional Stock Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a2332;
            --bg-hover: #243044;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-up: #ef4444;          /* 漲 - 紅色 */
            --accent-up-glow: rgba(239, 68, 68, 0.3);
            --accent-down: #10b981;        /* 跌 - 綠色 */
            --accent-down-glow: rgba(16, 185, 129, 0.3);
            --accent-yellow: #f59e0b;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-cyan: #06b6d4;
            --border-color: #2d3a4f;
            --gradient-gold: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Input Section */
        .input-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stock-input {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 25px;
            font-size: 1.2rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            width: 200px;
            transition: all 0.3s ease;
        }

        .stock-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .analyze-btn {
            background: var(--gradient-blue);
            border: none;
            border-radius: 12px;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Market Selector */
        .market-selector {
            display: flex;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .market-btn {
            background: transparent;
            border: none;
            padding: 15px 20px;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .market-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .market-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        .market-btn:first-child {
            border-right: 1px solid var(--border-color);
        }

        /* Date Inputs */
        .date-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 20px;
        }

        .date-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .date-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .date-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.95rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .date-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .date-separator {
            color: var(--text-muted);
            font-size: 1.2rem;
            margin-top: 15px;
        }

        .date-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .date-info span {
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Quick Date Buttons */
        .quick-date-btns {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 18px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .quick-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Watchlist Add Button */
        .watchlist-add-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            border-radius: 12px;
            padding: 15px 20px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .watchlist-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
        }

        /* Watchlist Section */
        .watchlist-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .watchlist-header h3 {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin: 0;
        }

        .watchlist-actions {
            display: flex;
            gap: 10px;
        }

        .watchlist-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .watchlist-btn:hover {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .watchlist-btn.danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .watchlist-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .watchlist-market-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .watchlist-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.95rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .watchlist-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .watchlist-quick-add {
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1.2rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watchlist-quick-add:hover {
            background: #2563eb;
        }

        .watchlist-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .watchlist-tag {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .watchlist-tag:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }

        .watchlist-tag .tag-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .watchlist-tag .tag-code {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan);
        }

        .watchlist-tag .tag-market {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .watchlist-tag .tag-market.tpex {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .watchlist-tag .tag-remove {
            color: var(--text-muted);
            font-size: 1.1rem;
            line-height: 1;
        }

        .watchlist-tag .tag-remove:hover {
            color: #ef4444;
        }

        /* Watchlist Table */
        .watchlist-table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
        }

        .watchlist-table th,
        .watchlist-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .watchlist-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .watchlist-table td {
            font-family: 'JetBrains Mono', monospace;
        }

        .watchlist-table tr:hover {
            background: var(--bg-hover);
        }

        .watchlist-table .stock-name {
            font-family: 'Noto Sans TC', sans-serif;
            color: var(--text-primary);
        }

        .watchlist-table .stock-code {
            color: var(--accent-cyan);
            font-size: 0.85rem;
        }

        .watchlist-table .price-up {
            color: var(--accent-up);
        }

        .watchlist-table .price-down {
            color: var(--accent-down);
        }

        .watchlist-table .price-flat {
            color: var(--text-secondary);
        }

        .watchlist-table .analyze-link {
            color: var(--accent-blue);
            cursor: pointer;
            text-decoration: none;
        }

        .watchlist-table .analyze-link:hover {
            text-decoration: underline;
        }

        .watchlist-table .remove-btn {
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
        }

        .watchlist-table .remove-btn:hover {
            color: #ef4444;
        }

        .watchlist-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 30px;
            color: var(--text-secondary);
        }

        .spinner-small {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .watchlist-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
        }

        /* Toast Animation */
        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes toastOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
        }

        /* Responsive for Watchlist */
        @media (max-width: 768px) {
            .watchlist-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .watchlist-input-row {
                flex-direction: column;
            }

            .watchlist-market-select {
                width: 100%;
            }

            .watchlist-table th,
            .watchlist-table td {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            .watchlist-add-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Results Container */
        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        /* Stock Header Card */
        .stock-header {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
        }

        .stock-info h2 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stock-code {
            color: var(--accent-blue);
            font-family: 'JetBrains Mono', monospace;
        }

        .market-tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
            margin-left: 10px;
            vertical-align: middle;
        }

        .market-tag.twse {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .market-tag.tpex {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .stock-price {
            text-align: right;
        }

        .current-price {
            font-size: 3rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .price-up {
            color: var(--accent-up);
        }

        .price-down {
            color: var(--accent-down);
        }

        .price-change {
            font-size: 1.2rem;
            margin-top: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px 24px;
            font-size: 1rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-3px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-icon {
            font-size: 1.5rem;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .card-subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        /* Alert Section */
        .alerts-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .alert-summary {
            display: flex;
            gap: 20px;
        }

        .alert-count {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-count.bullish {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-up);
        }

        .alert-count.bearish {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-down);
        }

        .alert-count.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-yellow);
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            background: var(--bg-secondary);
            border-left: 4px solid;
        }

        .alert-item.priority-1 {
            border-left-color: #ef4444;
        }

        .alert-item.priority-2 {
            border-left-color: var(--accent-yellow);
        }

        .alert-item.priority-3 {
            border-left-color: var(--accent-cyan);
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .alert-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .alert-tag {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .tag-bullish {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-up);
        }

        .tag-bearish {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-down);
        }

        .tag-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        .tag-neutral {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }

        /* Score Display */
        .score-display {
            text-align: center;
            padding: 30px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .score-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .score-value {
            font-size: 4rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .score-range {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 10px;
        }

        /* AI Analysis Section */
        .ai-analysis {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .ai-analysis h3 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-content {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1rem;
        }

        .analysis-section {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .analysis-section h4 {
            color: var(--accent-blue);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        /* Technical Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            font-family: 'JetBrains Mono', monospace;
        }

        .data-table tr:hover {
            background: var(--bg-hover);
        }

        /* Legend */
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 20px;
            height: 4px;
            border-radius: 2px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .input-section {
                flex-direction: column;
            }

            .market-selector {
                width: 100%;
            }

            .market-btn {
                flex: 1;
            }

            .date-inputs {
                width: 100%;
                justify-content: center;
            }

            .stock-input {
                width: 100%;
            }

            .analyze-btn {
                width: 100%;
                justify-content: center;
            }

            .stock-header {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .stock-price {
                text-align: center;
            }

            .current-price {
                font-size: 2.5rem;
            }

            .chart-wrapper {
                height: 300px;
            }

            .tabs {
                justify-content: center;
            }

            .market-tag {
                display: block;
                margin: 10px auto 0;
                width: fit-content;
            }
        }

        @media (max-width: 480px) {
            .date-inputs {
                flex-direction: column;
                gap: 15px;
            }

            .date-separator {
                display: none;
            }

            .date-group {
                width: 100%;
            }

            .date-input {
                width: 100%;
            }
        }

        /* Copy Button for AI Analysis */
        .copy-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--accent-blue);
            color: white;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Key Levels */
        .key-levels {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .level-item {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 10px;
            text-align: center;
        }

        .level-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .level-value {
            font-size: 1.3rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .level-resistance {
            color: var(--accent-down);
        }

        .level-support {
            color: var(--accent-up);
        }

        /* Error Display */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: var(--accent-red);
            margin: 20px 0;
            white-space: pre-line;
            line-height: 1.8;
        }

        /* Ranking Section */
        .ranking-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .ranking-section.collapsed .ranking-content {
            display: none;
        }
        
        .ranking-section.collapsed .ranking-header {
            margin-bottom: 0;
        }
        
        .ranking-toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px 10px;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .ranking-toggle-btn:hover {
            color: var(--text-primary);
        }
        
        .ranking-section.collapsed .ranking-toggle-btn {
            transform: rotate(-90deg);
        }
        
        .ranking-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .ranking-header h3 {
            font-size: 1.3rem;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .ranking-select {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .ranking-tab-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ranking-tab-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .ranking-tab-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .ranking-refresh-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ranking-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .ranking-update-time {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 15px;
        }

        .ranking-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 40px;
            color: var(--text-secondary);
        }

        .ranking-table-container {
            overflow-x: auto;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table th,
        .ranking-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .ranking-table th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            position: sticky;
            top: 0;
        }

        .ranking-table td {
            font-family: 'JetBrains Mono', monospace;
        }

        .ranking-table tr:hover {
            background: var(--bg-hover);
        }

        .ranking-rank {
            display: inline-flex;
            width: 28px;
            height: 28px;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .ranking-rank.top3 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #000;
        }

        .ranking-rank.normal {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        /* Elliott Wave Section */
        .elliott-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .elliott-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .elliott-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .elliott-card.main-wave {
            grid-column: span 2;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .elliott-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .elliott-icon {
            font-size: 1.2rem;
        }

        .elliott-wave-position {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }

        .elliott-wave-desc {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .elliott-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .elliott-chart-container {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .elliott-chart-container h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .elliott-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .elliott-theory-box,
        .elliott-analysis-box,
        .fibonacci-box,
        .wave-prediction-box {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .elliott-theory-box h4,
        .elliott-analysis-box h4,
        .fibonacci-box h4,
        .wave-prediction-box h4 {
            color: var(--accent-yellow);
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .wave-rules {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .wave-rule {
            padding: 12px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .wave-label {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .wave-label.impulse {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-up);
        }

        .wave-label.corrective {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-down);
        }

        .wave-rule p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        .fibonacci-levels {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .fib-level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .fib-level.important {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .fib-level.extension {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .fib-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .fib-price {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        #elliottAnalysis, #wavePrediction {
            line-height: 1.8;
            color: var(--text-secondary);
        }

        #elliottAnalysis strong, #wavePrediction strong {
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .elliott-card.main-wave {
                grid-column: span 1;
            }
            
            .ranking-controls {
                width: 100%;
                justify-content: center;
            }
            
            .ranking-header {
                flex-direction: column;
                text-align: center;
            }
        }

        /* ===== AI 三方票決樣式 ===== */
        .ai-voting-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .api-settings {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .api-settings h4 {
            color: var(--accent-yellow);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .api-input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .api-input-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .api-input-item label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .api-input-item label .api-logo {
            width: 18px;
            height: 18px;
        }

        .api-input-item input {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 0.9rem;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.3s ease;
        }

        .api-input-item input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }

        .api-input-item input::placeholder {
            color: var(--text-muted);
        }

        .api-note {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 10px;
            padding: 10px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 8px;
            line-height: 1.6;
        }

        /* API 測試連線相關樣式 */
        .api-test-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .api-test-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .api-key-status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .api-key-status.testing {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
            animation: pulse 1s infinite;
        }

        .api-key-status.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .api-key-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .connection-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .conn-status {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .conn-status.untested {
            background: var(--bg-hover);
            color: var(--text-muted);
        }

        .conn-status.testing {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
            animation: pulse 1s infinite;
        }

        .conn-status.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .conn-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .ai-voting-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border: none;
            border-radius: 12px;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 15px;
        }

        .ai-voting-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        .ai-voting-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-results-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 900px) {
            .ai-results-container {
                grid-template-columns: 1fr;
            }
        }

        .ai-result-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .ai-result-card.loading {
            opacity: 0.7;
        }

        .ai-result-card.claude {
            border-color: rgba(214, 137, 70, 0.5);
        }

        .ai-result-card.gemini {
            border-color: rgba(66, 133, 244, 0.5);
        }

        .ai-result-card.openai {
            border-color: rgba(16, 163, 127, 0.5);
        }

        .ai-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .ai-card-header .ai-icon {
            font-size: 1.5rem;
        }

        .ai-card-header .ai-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .ai-card-header .ai-status {
            margin-left: auto;
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--bg-card);
            color: var(--text-muted);
        }

        .ai-card-header .ai-status.ready {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .ai-card-header .ai-status.analyzing {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
            animation: pulse 1.5s infinite;
        }

        .ai-card-header .ai-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .ai-verdict {
            text-align: center;
            padding: 15px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .ai-verdict-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .ai-verdict-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .ai-verdict-value.buy {
            color: var(--accent-up);
        }

        .ai-verdict-value.sell {
            color: var(--accent-down);
        }

        .ai-verdict-value.hold {
            color: var(--accent-yellow);
        }

        .ai-confidence {
            text-align: center;
            margin-bottom: 15px;
        }

        .ai-confidence-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .ai-confidence-bar {
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .ai-confidence-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .ai-analysis-text {
            font-size: 0.9rem;
            line-height: 1.7;
            color: var(--text-secondary);
            max-height: 350px;
            overflow-y: auto;
            padding-right: 5px;
            white-space: pre-wrap;
        }

        .ai-analysis-text::-webkit-scrollbar {
            width: 4px;
        }

        .ai-analysis-text::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 2px;
        }

        .ai-analysis-text::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        /* 最終票決結果 */
        .final-verdict-section {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border-radius: 16px;
            padding: 30px;
            text-align: center;
            border: 2px solid rgba(139, 92, 246, 0.3);
        }

        .final-verdict-title {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .final-verdict-result {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 0 30px currentColor;
        }

        .final-verdict-result.buy {
            color: var(--accent-up);
        }

        .final-verdict-result.sell {
            color: var(--accent-down);
        }

        .final-verdict-result.hold {
            color: var(--accent-yellow);
        }

        .voting-summary {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .vote-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-card);
            border-radius: 10px;
        }

        .vote-item .vote-icon {
            font-size: 1.2rem;
        }

        .vote-item .vote-count {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .vote-item.buy .vote-count {
            color: var(--accent-up);
        }

        .vote-item.sell .vote-count {
            color: var(--accent-down);
        }

        .vote-item.hold .vote-count {
            color: var(--accent-yellow);
        }

        .final-verdict-note {
            margin-top: 20px;
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .ai-loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        /* ===== 熱力圖樣式 ===== */
        .heatmap-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .heatmap-section h3 {
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
        }

        .heatmap-cell {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
        }

        .heatmap-cell .name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .heatmap-cell .change {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .heat-up-3 { background: rgba(239, 68, 68, 0.9); }
        .heat-up-2 { background: rgba(239, 68, 68, 0.7); }
        .heat-up-1 { background: rgba(239, 68, 68, 0.5); }
        .heat-flat { background: rgba(128, 128, 128, 0.5); }
        .heat-down-1 { background: rgba(16, 185, 129, 0.5); }
        .heat-down-2 { background: rgba(16, 185, 129, 0.7); }
        .heat-down-3 { background: rgba(16, 185, 129, 0.9); }

        .heatmap-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 20px;
            height: 12px;
            border-radius: 2px;
        }

        /* ===== ETF 樣式 ===== */
        .etf-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .etf-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .etf-section h3 {
            font-size: 1.2rem;
        }

        .etf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .etf-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }

        .etf-card:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .etf-card.up {
            border-left-color: var(--accent-up);
        }

        .etf-card.down {
            border-left-color: var(--accent-down);
        }

        .etf-card .name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .etf-card .code {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 10px;
        }

        .etf-card .price {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .etf-card .change {
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* ===== 即時股價總覽樣式 ===== */
        .realtime-section {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .realtime-section.active {
            display: block;
        }

        .realtime-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .realtime-stock-info {
            flex: 1;
        }

        .realtime-stock-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .realtime-stock-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent-cyan);
        }

        .realtime-stock-name {
            font-size: 2rem;
            font-weight: 700;
        }

        .realtime-market-tag {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            background: var(--accent-blue);
            color: white;
        }

        .realtime-market-tag.tpex {
            background: var(--accent-purple);
        }

        .realtime-update-info {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .realtime-price-section {
            text-align: right;
        }

        .realtime-current-price {
            font-size: 4rem;
            font-weight: 900;
            line-height: 1;
        }

        .realtime-price-change {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 8px;
        }

        .realtime-price-up {
            color: var(--accent-up);
        }

        .realtime-price-down {
            color: var(--accent-down);
        }

        .realtime-price-flat {
            color: var(--text-secondary);
        }

        .realtime-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .realtime-detail-item {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .realtime-detail-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .realtime-detail-value {
            font-size: 1.3rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .realtime-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .realtime-refresh-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .realtime-refresh-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .realtime-refresh-btn.refreshing {
            opacity: 0.7;
            pointer-events: none;
        }

        .realtime-refresh-btn .spinner {
            animation: spin 1s linear infinite;
        }

        .realtime-auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .realtime-auto-refresh input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-blue);
        }

        .realtime-five-price {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .five-price-panel {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
        }

        .five-price-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .five-price-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .five-price-row.ask {
            color: var(--accent-down);
        }

        .five-price-row.bid {
            color: var(--accent-up);
        }

        /* 價格更新閃爍動畫 */
        @keyframes priceFlash {
            0% { background-color: transparent; }
            25% { background-color: rgba(245, 158, 11, 0.3); }
            50% { background-color: transparent; }
            75% { background-color: rgba(245, 158, 11, 0.3); }
            100% { background-color: transparent; }
        }

        .price-flash {
            animation: priceFlash 1s ease-out;
        }

        @keyframes updatePulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        .update-pulse {
            animation: updatePulse 0.5s ease-out;
        }

        /* ===== 多股監控樣式 ===== */
        .multi-monitor-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .multi-monitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .multi-monitor-header h3 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .multi-monitor-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .multi-monitor-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .multi-monitor-input input {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            width: 80px;
        }

        .multi-monitor-input select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .multi-monitor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 900px) {
            .multi-monitor-grid {
                grid-template-columns: 1fr;
            }
        }

        .monitor-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            border: 2px solid var(--border-color);
            position: relative;
            transition: all 0.3s;
        }

        .monitor-card:hover {
            border-color: var(--accent-blue);
        }

        .monitor-card.up {
            border-left: 4px solid var(--accent-up);
        }

        .monitor-card.down {
            border-left: 4px solid var(--accent-down);
        }

        .monitor-card.flat {
            border-left: 4px solid var(--text-muted);
        }

        .monitor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .monitor-stock-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .monitor-stock-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--accent-cyan);
        }

        .monitor-stock-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .monitor-market-tag {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--accent-blue);
            color: white;
        }

        .monitor-market-tag.tpex {
            background: var(--accent-purple);
        }

        .monitor-remove-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 5px;
            transition: color 0.3s;
        }

        .monitor-remove-btn:hover {
            color: var(--accent-down);
        }

        .monitor-price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .monitor-current-price {
            font-size: 2.2rem;
            font-weight: 900;
            font-family: 'JetBrains Mono', monospace;
        }

        .monitor-price-change {
            font-size: 1rem;
            font-weight: 700;
        }

        .monitor-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            padding: 8px 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        .monitor-detail-item {
            text-align: center;
        }

        .monitor-detail-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--text-primary);
        }

        .monitor-holding {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .monitor-holding input {
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            width: 85px;
        }

        .monitor-profit {
            display: flex;
            gap: 15px;
            margin-left: auto;
        }

        .monitor-profit-item {
            text-align: right;
        }

        .monitor-profit-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .monitor-profit-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .monitor-update-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 8px;
        }

        .monitor-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .monitor-add-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            border: 2px dashed var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 200px;
            color: var(--text-muted);
        }

        .monitor-add-card:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        .monitor-add-card .add-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .price-up {
            color: var(--accent-up) !important;
        }

        .price-down {
            color: var(--accent-down) !important;
        }

        /* ===== iPad 12.9吋 平板專用模式 ===== */
        .tablet-mode .container {
            max-width: 100%;
            padding: 10px;
        }

        .tablet-mode .header {
            padding: 10px 15px;
            margin-bottom: 10px;
        }

        .tablet-mode .header h1 {
            font-size: 1.3rem;
        }

        /* 平板模式隱藏其他區塊，只保留監控 */
        .tablet-mode .search-section,
        .tablet-mode .realtime-section,
        .tablet-mode .heatmap-section,
        .tablet-mode .etf-section,
        .tablet-mode .watchlist-section,
        .tablet-mode .ranking-section,
        .tablet-mode .results-section,
        .tablet-mode .ai-section {
            display: none !important;
        }

        .tablet-mode .multi-monitor-section {
            display: block !important;
            margin: 0;
            padding: 10px;
            border-radius: 0;
            height: calc(100vh - 80px);
            overflow: hidden;
        }

        .tablet-mode .multi-monitor-header {
            padding: 10px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tablet-mode .multi-monitor-header h3 {
            font-size: 1.1rem;
        }

        .tablet-mode .multi-monitor-controls {
            flex-wrap: wrap;
            gap: 8px;
        }

        .tablet-mode .multi-monitor-grid {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            height: calc(100% - 70px);
        }

        .tablet-mode .monitor-card {
            padding: 15px;
            min-height: unset;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tablet-mode .monitor-card-header {
            margin-bottom: 8px;
        }

        .tablet-mode .monitor-stock-code {
            font-size: 1.6rem;
        }

        .tablet-mode .monitor-stock-name {
            font-size: 1.2rem;
        }

        .tablet-mode .monitor-market-tag {
            font-size: 0.75rem;
            padding: 3px 10px;
        }

        .tablet-mode .monitor-price-row {
            margin-bottom: 8px;
            flex: 1;
            display: flex;
            align-items: center;
        }

        .tablet-mode .monitor-price-row > div:first-child {
            gap: 12px !important;
        }

        .tablet-mode .monitor-price-row > div:first-child > div:first-child {
            /* 昨收 */
        }

        .tablet-mode .monitor-price-row > div:first-child > div:first-child > div:last-child {
            font-size: 1.4rem !important;
        }

        .tablet-mode .monitor-current-price {
            font-size: 2.8rem !important;
        }

        .tablet-mode .monitor-price-change {
            font-size: 1.2rem;
        }

        .tablet-mode .monitor-details {
            font-size: 0.95rem;
            padding: 10px 0;
            gap: 5px;
        }

        .tablet-mode .monitor-detail-item {
            padding: 5px 10px;
        }

        .tablet-mode .monitor-detail-value {
            font-size: 1.15rem;
        }

        .tablet-mode .monitor-holding {
            padding: 8px 0;
            gap: 10px;
        }

        .tablet-mode .monitor-holding input {
            width: 95px !important;
            font-size: 1rem;
            padding: 10px 12px;
        }

        .tablet-mode .monitor-profit-value {
            font-size: 1.25rem;
        }

        .tablet-mode .monitor-update-time {
            font-size: 0.85rem;
            margin-top: auto;
        }

        .tablet-mode .monitor-add-card {
            min-height: unset;
            height: 100%;
            font-size: 1.2rem;
        }

        .tablet-mode .monitor-add-card .add-icon {
            font-size: 4rem;
        }

        .tablet-mode .monitor-remove-btn {
            font-size: 1.4rem;
            padding: 5px 10px;
        }

        /* 平板模式切換按鈕 */
        .tablet-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--gradient-blue);
            color: white;
            border: none;
            padding: 14px 22px;
            border-radius: 30px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .tablet-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        .tablet-mode .tablet-mode-toggle {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
        }

        /* 隱藏桌面模式的header */
        .tablet-mode .header {
            display: none;
        }

        /* iPad 12.9" 橫向自動偵測 (1024px ~ 1400px) */
        @media screen and (min-width: 1024px) and (max-width: 1400px) and (min-height: 700px) and (orientation: landscape) {
            .auto-tablet .container {
                max-width: 100%;
                padding: 10px;
            }
        }

        /* iPad 直向模式 */
        @media screen and (max-width: 1024px) and (orientation: portrait) {
            .tablet-mode .multi-monitor-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .tablet-mode .monitor-card {
                padding: 12px;
            }
            
            .tablet-mode .monitor-stock-code {
                font-size: 1.4rem;
            }
            
            .tablet-mode .monitor-current-price {
                font-size: 2.2rem !important;
            }
            
            .tablet-mode .monitor-holding input {
                width: 80px !important;
                padding: 8px 10px;
            }
        }

        /* 小螢幕平板（如 iPad mini）*/
        @media screen and (max-width: 850px) {
            .tablet-mode .multi-monitor-grid {
                grid-template-columns: 1fr;
                grid-template-rows: unset;
                overflow-y: auto;
                height: calc(100% - 70px);
            }
            
            .tablet-mode .monitor-card {
                min-height: 200px;
                height: auto;
            }
        }

        /* ===== iPad 12.9吋專用模式 ===== */
        body.ipad-mode {
            font-size: 18px;
        }

        body.ipad-mode .container {
            max-width: 100%;
            padding: 15px;
        }

        body.ipad-mode .header h1 {
            font-size: 1.8rem;
        }

        /* iPad模式 - 搜尋區塊 */
        body.ipad-mode .search-section {
            flex-wrap: wrap;
            gap: 15px;
            padding: 20px;
        }

        body.ipad-mode .search-section input,
        body.ipad-mode .search-section select,
        body.ipad-mode .search-section button {
            font-size: 1.1rem;
            padding: 15px 20px;
            min-height: 50px;
        }

        body.ipad-mode .market-btn {
            padding: 15px 25px;
            font-size: 1.1rem;
        }

        /* iPad模式 - 即時報價區塊 */
        body.ipad-mode .realtime-section {
            padding: 25px;
        }

        body.ipad-mode .realtime-stock-code {
            font-size: 2.5rem;
        }

        body.ipad-mode .realtime-stock-name {
            font-size: 2rem;
        }

        body.ipad-mode .realtime-current-price {
            font-size: 5rem;
        }

        body.ipad-mode .realtime-price-change {
            font-size: 1.8rem;
        }

        body.ipad-mode .realtime-detail-item {
            padding: 20px;
        }

        body.ipad-mode .realtime-detail-value {
            font-size: 1.5rem;
        }

        /* iPad模式 - 多股監控 4宮格優化 */
        body.ipad-mode .multi-monitor-section {
            padding: 20px;
        }

        body.ipad-mode .multi-monitor-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        body.ipad-mode .monitor-card {
            padding: 20px;
            min-height: 280px;
        }

        body.ipad-mode .monitor-stock-code {
            font-size: 1.8rem;
        }

        body.ipad-mode .monitor-stock-name {
            font-size: 1.4rem;
        }

        body.ipad-mode .monitor-current-price {
            font-size: 2.8rem !important;
        }

        body.ipad-mode .monitor-price-change {
            font-size: 1.3rem;
        }

        body.ipad-mode .monitor-details {
            font-size: 1rem;
            padding: 12px 0;
        }

        body.ipad-mode .monitor-detail-value {
            font-size: 1.2rem;
        }

        body.ipad-mode .monitor-holding {
            gap: 12px;
            padding: 10px 0;
        }

        body.ipad-mode .monitor-holding input {
            font-size: 1.1rem;
            padding: 12px 15px;
            width: 110px !important;
        }

        body.ipad-mode .monitor-holding input[style*="width: 55px"] {
            width: 70px !important;
        }

        body.ipad-mode .monitor-profit-value {
            font-size: 1.3rem;
        }

        body.ipad-mode .monitor-add-card {
            min-height: 280px;
            font-size: 1.2rem;
        }

        body.ipad-mode .monitor-add-card .add-icon {
            font-size: 4rem;
        }

        /* iPad模式 - 按鈕觸控優化 */
        body.ipad-mode .quick-btn,
        body.ipad-mode button {
            min-height: 48px;
            min-width: 48px;
            font-size: 1rem;
        }

        body.ipad-mode .monitor-remove-btn {
            font-size: 1.5rem;
            padding: 5px 10px;
        }

        /* iPad模式 - 五檔報價 */
        body.ipad-mode .five-price-row {
            font-size: 1.1rem;
            padding: 10px 0;
        }

        /* iPad模式 - 隱藏非必要區塊 */
        body.ipad-mode .heatmap-section,
        body.ipad-mode .etf-section,
        body.ipad-mode .watchlist-section,
        body.ipad-mode .ranking-section {
            display: none;
        }

        /* iPad模式切換按鈕 */
        .ipad-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
            z-index: 1000;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ipad-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.5);
        }

        .ipad-mode-toggle.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
        }

        /* iPad模式 - 全螢幕監控 */
        body.ipad-mode .header,
        body.ipad-mode .search-section {
            display: none;
        }

        body.ipad-mode .multi-monitor-section {
            margin-top: 0;
            border-radius: 0;
            min-height: calc(100vh - 40px);
        }

        body.ipad-mode .multi-monitor-header {
            position: sticky;
            top: 0;
            background: var(--bg-card);
            padding: 15px 0;
            z-index: 10;
            border-bottom: 1px solid var(--border-color);
        }

        /* iPad橫向模式特別優化 */
        @media screen and (min-width: 1024px) and (max-width: 1400px) and (min-height: 700px) {
            body.ipad-mode .multi-monitor-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(2, 1fr);
                height: calc(100vh - 180px);
            }

            body.ipad-mode .monitor-card,
            body.ipad-mode .monitor-add-card {
                height: 100%;
                min-height: unset;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🏆 台股專業分析系統 專家版</h1>
            <p>整合技術分析、籌碼面、AI 三方票決 | 支援上市 (TWSE) 及上櫃 (TPEx) 股票</p>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">📌 證交所/櫃買中心資料約於每日 18:00 後更新，當日資料請於盤後查詢</p>
        </header>

        <div class="input-section">
            <div class="market-selector">
                <button class="market-btn active" data-market="twse" onclick="selectMarket('twse')">上市 TWSE</button>
                <button class="market-btn" data-market="tpex" onclick="selectMarket('tpex')">上櫃 TPEx</button>
            </div>
            <input type="text" class="stock-input" id="stockCode" placeholder="輸入股票代號" maxlength="6">
            <div class="date-inputs">
                <div class="date-group">
                    <label for="startDate">起始日</label>
                    <input type="date" class="date-input" id="startDate">
                </div>
                <span class="date-separator">～</span>
                <div class="date-group">
                    <label for="endDate">終止日</label>
                    <input type="date" class="date-input" id="endDate">
                </div>
            </div>
            <button class="quick-btn" style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; padding: 12px 20px;" onclick="quickFetchRealtime()">
                <span>⚡</span>
                <span>即時報價</span>
            </button>
            <button class="analyze-btn" id="analyzeBtn" onclick="startAnalysis()">
                <span>🔍</span>
                <span>歷史分析</span>
            </button>
            <button class="watchlist-add-btn" onclick="addToWatchlist()">
                <span>⭐</span>
                <span>加入自選</span>
            </button>
        </div>

        <!-- 即時股價總覽 -->
        <div class="realtime-section" id="realtimeSection">
            <div class="realtime-header">
                <div class="realtime-stock-info">
                    <div class="realtime-stock-title">
                        <span class="realtime-stock-code" id="rtCode">----</span>
                        <span class="realtime-stock-name" id="rtName">股票名稱</span>
                        <span class="realtime-market-tag" id="rtMarket">上市</span>
                    </div>
                    <div class="realtime-update-info">
                        🕐 更新時間：<span id="rtUpdateTime">--:--:--</span>
                        <span id="rtTradeStatus"></span>
                        <span id="rtUpdateFlash" style="display: none; margin-left: 10px; color: var(--accent-yellow);">🔔 已更新</span>
                    </div>
                </div>
                <div class="realtime-price-section">
                    <div style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px;">⚡ 即時價</div>
                    <div class="realtime-current-price" id="rtPrice">---</div>
                    <div class="realtime-price-change" id="rtChange">--- (---%)</div>
                    <!-- 昨收價 vs 即時價 + 持有價損益 - 橫向一行 -->
                    <div style="margin-top: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">📊 昨收</div>
                                <div id="rtPrevDisplay" style="font-size: 1.2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-secondary);">---</div>
                            </div>
                            <div style="color: var(--text-muted);">→</div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">⚡ 即時</div>
                                <div id="rtCurrentDisplay" style="font-size: 1.2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;">---</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">📈 價差</div>
                                <div id="rtDiffDisplay" style="font-size: 1.2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;">---</div>
                            </div>
                        </div>
                        <div style="width: 1px; height: 40px; background: var(--border-color);"></div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 0.85rem; color: var(--text-muted);">💰 持有價</span>
                            <input type="number" id="rtHoldPrice" placeholder="買入價" step="0.01" min="0" 
                                style="padding: 8px 10px; border: 2px solid var(--border-color); border-radius: 6px; background: var(--bg-card); color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 1rem; width: 90px;"
                                onchange="calculateHoldingProfit()" oninput="calculateHoldingProfit()">
                            <span style="font-size: 0.85rem; color: var(--text-muted);">×</span>
                            <input type="number" id="rtHoldShares" placeholder="張" step="1" min="0" value="1"
                                style="padding: 8px 10px; border: 2px solid var(--border-color); border-radius: 6px; background: var(--bg-card); color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 1rem; width: 60px;"
                                onchange="calculateHoldingProfit()" oninput="calculateHoldingProfit()">
                            <span style="font-size: 0.85rem; color: var(--text-muted);">張</span>
                        </div>
                        <div style="width: 1px; height: 40px; background: var(--border-color);"></div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">📊 每股損益</div>
                                <div id="rtProfitPerShare" style="font-size: 1.3rem; font-weight: 900; font-family: 'JetBrains Mono', monospace;">---</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">💵 總損益</div>
                                <div id="rtTotalProfit" style="font-size: 1.3rem; font-weight: 900; font-family: 'JetBrains Mono', monospace;">---</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.75rem; color: var(--text-muted);">🏦 市值</div>
                                <div id="rtTotalValue" style="font-size: 1rem; font-weight: 600; font-family: 'JetBrains Mono', monospace; color: var(--text-secondary);">---</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="realtime-details">
                <div class="realtime-detail-item">
                    <div class="realtime-detail-label">📈 開盤價</div>
                    <div class="realtime-detail-value" id="rtOpen">---</div>
                </div>
                <div class="realtime-detail-item">
                    <div class="realtime-detail-label">🔺 最高價</div>
                    <div class="realtime-detail-value" id="rtHigh" style="color: var(--accent-up);">---</div>
                </div>
                <div class="realtime-detail-item">
                    <div class="realtime-detail-label">🔻 最低價</div>
                    <div class="realtime-detail-value" id="rtLow" style="color: var(--accent-down);">---</div>
                </div>
                <div class="realtime-detail-item">
                    <div class="realtime-detail-label">📊 昨收價</div>
                    <div class="realtime-detail-value" id="rtPrevClose">---</div>
                </div>
                <div class="realtime-detail-item">
                    <div class="realtime-detail-label">📦 成交量</div>
                    <div class="realtime-detail-value" id="rtVolume">---</div>
                </div>
                <div class="realtime-detail-item">
                    <div class="realtime-detail-label">💰 成交金額</div>
                    <div class="realtime-detail-value" id="rtTurnover">---</div>
                </div>
                <div class="realtime-detail-item">
                    <div class="realtime-detail-label">🎯 漲停價</div>
                    <div class="realtime-detail-value" id="rtLimitUp" style="color: var(--accent-up);">---</div>
                </div>
                <div class="realtime-detail-item">
                    <div class="realtime-detail-label">⬇️ 跌停價</div>
                    <div class="realtime-detail-value" id="rtLimitDown" style="color: var(--accent-down);">---</div>
                </div>
            </div>

            <div class="realtime-five-price" id="rtFivePrice">
                <div class="five-price-panel">
                    <div class="five-price-title">📗 五檔買價</div>
                    <div id="rtBidPrices">
                        <div class="five-price-row bid"><span>買1</span><span>---</span><span>---</span></div>
                        <div class="five-price-row bid"><span>買2</span><span>---</span><span>---</span></div>
                        <div class="five-price-row bid"><span>買3</span><span>---</span><span>---</span></div>
                        <div class="five-price-row bid"><span>買4</span><span>---</span><span>---</span></div>
                        <div class="five-price-row bid"><span>買5</span><span>---</span><span>---</span></div>
                    </div>
                </div>
                <div class="five-price-panel">
                    <div class="five-price-title">📕 五檔賣價</div>
                    <div id="rtAskPrices">
                        <div class="five-price-row ask"><span>賣1</span><span>---</span><span>---</span></div>
                        <div class="five-price-row ask"><span>賣2</span><span>---</span><span>---</span></div>
                        <div class="five-price-row ask"><span>賣3</span><span>---</span><span>---</span></div>
                        <div class="five-price-row ask"><span>賣4</span><span>---</span><span>---</span></div>
                        <div class="five-price-row ask"><span>賣5</span><span>---</span><span>---</span></div>
                    </div>
                </div>
            </div>

            <div class="realtime-actions">
                <button class="realtime-refresh-btn" id="rtRefreshBtn" onclick="refreshRealtimeQuote()">
                    <span id="rtRefreshIcon">🔄</span> 更新報價
                </button>
                <label class="realtime-auto-refresh">
                    <input type="checkbox" id="rtAutoRefresh" onchange="toggleAutoRefresh()">
                    🔄 自動更新報價（每 15 秒）
                </label>
                <button class="quick-btn" onclick="addCurrentToMonitor()" style="background: var(--accent-purple);">
                    📊 加入監控
                </button>
                <button class="quick-btn" onclick="startHistoricalAnalysis()" style="margin-left: auto;">
                    📈 開始歷史數據分析
                </button>
            </div>
        </div>

        <!-- 多股即時監控 -->
        <div class="multi-monitor-section" id="multiMonitorSection">
            <div class="multi-monitor-header">
                <h3>📊 多股即時監控 <span style="font-size: 0.8rem; color: var(--text-muted);">(最多8檔)</span>
                    <span id="tradingStatusText" style="font-size: 0.8rem; margin-left: 10px;">🟢 交易中</span>
                </h3>
                <div class="multi-monitor-controls">
                    <div class="multi-monitor-input">
                        <select id="monitorMarket">
                            <option value="twse">上市</option>
                            <option value="tpex">上櫃</option>
                        </select>
                        <input type="text" id="monitorCode" placeholder="代碼" maxlength="6">
                        <button class="quick-btn" onclick="addMonitorStock()">➕ 新增</button>
                    </div>
                    <button class="quick-btn" style="background: var(--accent-blue);" onclick="refreshAllMonitorStaggered()">🔄 全部更新</button>
                    <select id="monitorInterval" onchange="updateMonitorInterval()" style="padding: 6px 10px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.85rem;">
                        <option value="15">15秒</option>
                        <option value="30" selected>30秒</option>
                        <option value="45">45秒</option>
                        <option value="60">60秒</option>
                    </select>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 0.85rem; color: var(--text-secondary);" title="手動開啟自動更新">
                        <input type="checkbox" id="monitorAutoRefresh" onchange="toggleMonitorAutoRefresh()">
                        自動更新
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; font-size: 0.85rem; color: var(--accent-cyan); background: var(--bg-secondary); padding: 5px 10px; border-radius: 6px; cursor: pointer;" title="交易時間(09:00~13:30)自動啟動，收盤後自動停止">
                        <input type="checkbox" id="monitorSmartAuto" onchange="toggleSmartAutoMode()">
                        🧠 智能模式
                    </label>
                </div>
            </div>
            <div class="monitor-status" id="monitorStatus" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px; display: none;">
                <span id="monitorStatusText">⏳ 更新中...</span>
            </div>
            <div class="multi-monitor-grid" id="monitorGrid">
                <div class="monitor-add-card" onclick="document.getElementById('monitorCode').focus()">
                    <div class="add-icon">➕</div>
                    <div>點擊新增監控股票</div>
                </div>
            </div>
        </div>

        <!-- 類股熱力圖 -->
        <div class="heatmap-section" id="heatmapSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>🔥 類股熱力圖</h3>
                <button class="quick-btn" onclick="loadHeatmapData()">🔄 更新</button>
            </div>
            <div class="heatmap-grid" id="heatmapGrid"></div>
            <div class="heatmap-legend">
                <div class="legend-item"><div class="legend-color heat-up-3"></div>漲 >3%</div>
                <div class="legend-item"><div class="legend-color heat-up-2"></div>漲 1~3%</div>
                <div class="legend-item"><div class="legend-color heat-up-1"></div>漲 0~1%</div>
                <div class="legend-item"><div class="legend-color heat-flat"></div>平盤</div>
                <div class="legend-item"><div class="legend-color heat-down-1"></div>跌 0~1%</div>
                <div class="legend-item"><div class="legend-color heat-down-2"></div>跌 1~3%</div>
                <div class="legend-item"><div class="legend-color heat-down-3"></div>跌 >3%</div>
            </div>
        </div>

        <!-- 熱門 ETF -->
        <div class="etf-section" id="etfSection">
            <div class="etf-section-header">
                <h3>📈 台灣熱門 ETF 20</h3>
                <button class="quick-btn" onclick="loadETFData()">🔄 更新報價</button>
            </div>
            <div class="etf-grid" id="etfGrid"></div>
        </div>

        <!-- 自選股區塊 -->
        <div class="watchlist-section" id="watchlistSection">
            <div class="watchlist-header">
                <h3>⭐ 我的自選股</h3>
                <div class="watchlist-actions">
                    <button class="watchlist-btn" onclick="fetchAllWatchlist()">📊 更新報價</button>
                    <button class="watchlist-btn danger" onclick="clearWatchlist()">🗑️ 清空</button>
                </div>
            </div>
            <div class="watchlist-input-row">
                <select id="watchlistMarket" class="watchlist-market-select">
                    <option value="twse">上市</option>
                    <option value="tpex">上櫃</option>
                </select>
                <input type="text" class="watchlist-input" id="watchlistCode" placeholder="輸入代號快速加入" maxlength="6">
                <button class="watchlist-quick-add" onclick="quickAddWatchlist()">+</button>
            </div>
            <div class="watchlist-tags" id="watchlistTags">
                <!-- 自選股標籤會動態生成 -->
            </div>
            <div class="watchlist-table-container" id="watchlistTableContainer" style="display: none;">
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>股票</th>
                            <th>市場</th>
                            <th>成交價</th>
                            <th>昨收</th>
                            <th>漲跌</th>
                            <th>漲跌幅</th>
                            <th>成交量</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="watchlistBody">
                    </tbody>
                </table>
            </div>
            <div class="watchlist-loading" id="watchlistLoading" style="display: none;">
                <div class="spinner-small"></div>
                <span>正在更新報價...</span>
            </div>
        </div>
        <div class="date-info" id="dateInfo"></div>
        
        <div class="quick-date-btns">
            <button class="quick-btn" onclick="setDateRange(30)">近30日</button>
            <button class="quick-btn active" onclick="setDateRange(60)">近60日</button>
            <button class="quick-btn" onclick="setDateRange(90)">近90日</button>
            <button class="quick-btn" onclick="setDateRange(180)">近半年</button>
            <button class="quick-btn" onclick="setDateRange(365)">近一年</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">正在獲取股票數據...</p>
        </div>

        <div class="error-message" id="errorMessage" style="display: none;"></div>

        <div class="results" id="results">
            <!-- Stock Header -->
            <div class="stock-header" id="stockHeader">
                <div class="stock-info">
                    <h2><span id="stockName">-</span> <span class="stock-code" id="displayCode">-</span> <span class="market-tag" id="marketTag">上市</span></h2>
                    <p id="stockDate">最後更新：-</p>
                </div>
                <div class="stock-price">
                    <div class="current-price" id="currentPrice">-</div>
                    <div class="price-change" id="priceChange">-</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('overview')">📈 總覽</button>
                <button class="tab-btn" onclick="showTab('technical')">📊 技術分析</button>
                <button class="tab-btn" onclick="showTab('kd-chart')">📉 KD 線圖</button>
                <button class="tab-btn" onclick="showTab('macd-chart')">📊 MACD 圖表</button>
                <button class="tab-btn" onclick="showTab('elliott-wave')">🌊 波浪理論</button>
                <button class="tab-btn" onclick="showTab('alerts')">🚨 智能警示</button>
                <button class="tab-btn" onclick="showTab('institutional')">📊 籌碼面</button>
                <button class="tab-btn" onclick="showTab('ai-report')">🤖 AI 分析報告</button>
                <button class="tab-btn" onclick="showTab('ai-voting')" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.3));">🗳️ AI 三方票決</button>
            </div>

            <!-- 排行榜區塊（獨立於個股分析） -->
            <div class="ranking-section" id="rankingSection">
                <div class="ranking-header">
                    <div class="ranking-header-left">
                        <button class="ranking-toggle-btn" onclick="toggleRankingSection()" title="展開/收合">▼</button>
                        <h3>🏆 台股排行榜</h3>
                    </div>
                    <div class="ranking-controls">
                        <select id="rankingMarket" class="ranking-select">
                            <option value="tse">上市</option>
                            <option value="otc">上櫃</option>
                        </select>
                        <button class="ranking-tab-btn active" data-type="gainers" onclick="switchRankingType('gainers')">📈 漲幅</button>
                        <button class="ranking-tab-btn" data-type="losers" onclick="switchRankingType('losers')">📉 跌幅</button>
                        <button class="ranking-tab-btn" data-type="volume" onclick="switchRankingType('volume')">📊 成交量</button>
                        <button class="ranking-tab-btn" data-type="value" onclick="switchRankingType('value')">💰 成交值</button>
                        <button class="ranking-refresh-btn" onclick="fetchRankingData()">🔄 更新</button>
                    </div>
                </div>
                <div class="ranking-content">
                    <div class="ranking-update-time" id="rankingUpdateTime">點擊「更新」獲取最新排行榜</div>
                    <div class="ranking-loading" id="rankingLoading" style="display: none;">
                        <div class="spinner-small"></div>
                        <span>正在載入排行榜...</span>
                    </div>
                    <div class="ranking-table-container" id="rankingTableContainer" style="display: none;">
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>代號</th>
                                    <th>名稱</th>
                                    <th>成交價</th>
                                    <th>漲跌</th>
                                    <th>漲跌幅</th>
                                    <th id="rankingValueHeader">成交量(張)</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="rankingBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: Overview -->
            <div class="tab-content active" id="tab-overview">
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">技術評分</span>
                            <span class="card-icon">📈</span>
                        </div>
                        <div class="card-value" id="techScore">-</div>
                        <div class="card-subtitle">綜合技術面指標</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="techProgress" style="width: 0%; background: var(--accent-blue);"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">RSI (14)</span>
                            <span class="card-icon">📊</span>
                        </div>
                        <div class="card-value" id="rsiValue">-</div>
                        <div class="card-subtitle" id="rsiStatus">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">KD 指標</span>
                            <span class="card-icon">📉</span>
                        </div>
                        <div class="card-value" id="kdValue">-</div>
                        <div class="card-subtitle" id="kdStatus">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">成交量比</span>
                            <span class="card-icon">📶</span>
                        </div>
                        <div class="card-value" id="volumeRatio">-</div>
                        <div class="card-subtitle" id="volumeStatus">-</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 class="chart-title">📈 價格走勢與均線 <span id="priceChartDays" style="font-weight: normal; color: var(--text-secondary);"></span></h3>
                    <div class="chart-wrapper">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>收盤價</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>MA5</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8b5cf6;"></div>
                            <span>MA10</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>MA20</span>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <h4 style="margin-bottom: 15px; color: var(--accent-blue);">📍 關鍵價位</h4>
                        <div class="key-levels">
                            <div class="level-item">
                                <div class="level-label">壓力位 (20日高)</div>
                                <div class="level-value level-resistance" id="resistanceLevel">-</div>
                            </div>
                            <div class="level-item">
                                <div class="level-label">支撐位 (20日低)</div>
                                <div class="level-value level-support" id="supportLevel">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h4 style="margin-bottom: 15px; color: var(--accent-blue);">📊 均線狀態</h4>
                        <div class="key-levels">
                            <div class="level-item">
                                <div class="level-label">MA5</div>
                                <div class="level-value" id="ma5Value">-</div>
                            </div>
                            <div class="level-item">
                                <div class="level-label">MA20</div>
                                <div class="level-value" id="ma20Value">-</div>
                            </div>
                        </div>
                        <p id="maStatus" style="text-align: center; margin-top: 15px; color: var(--text-secondary);"></p>
                    </div>
                </div>
            </div>

            <!-- Tab: Technical Analysis -->
            <div class="tab-content" id="tab-technical">
                <div class="chart-container">
                    <h3 class="chart-title">📊 技術指標數據表</h3>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="technicalTable">
                            <thead>
                                <tr>
                                    <th>日期</th>
                                    <th>收盤</th>
                                    <th>漲跌</th>
                                    <th>成交量</th>
                                    <th>MA5</th>
                                    <th>MA10</th>
                                    <th>MA20</th>
                                    <th>RSI</th>
                                    <th>K</th>
                                    <th>D</th>
                                </tr>
                            </thead>
                            <tbody id="technicalBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab: KD Chart -->
            <div class="tab-content" id="tab-kd-chart">
                <div class="chart-container">
                    <h3 class="chart-title">📉 KD 隨機指標 <span id="kdChartDays" style="font-weight: normal; color: var(--text-secondary);"></span></h3>
                    <div class="chart-wrapper">
                        <canvas id="kdChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>K 值</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>D 值</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: rgba(16, 185, 129, 0.3);"></div>
                            <span>超買區 (80)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: rgba(239, 68, 68, 0.3);"></div>
                            <span>超賣區 (20)</span>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">當前 K 值</span>
                            <span class="card-icon">📊</span>
                        </div>
                        <div class="card-value" id="currentK">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">當前 D 值</span>
                            <span class="card-icon">📊</span>
                        </div>
                        <div class="card-value" id="currentD">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">KD 狀態</span>
                            <span class="card-icon">🎯</span>
                        </div>
                        <div class="card-value" id="kdSignal" style="font-size: 1.5rem;">-</div>
                    </div>
                </div>
            </div>

            <!-- Tab: MACD Chart -->
            <div class="tab-content" id="tab-macd-chart">
                <div class="chart-container">
                    <h3 class="chart-title">📊 MACD 指標 <span id="macdChartDays" style="font-weight: normal; color: var(--text-secondary);"></span></h3>
                    <div class="chart-wrapper">
                        <canvas id="macdChart"></canvas>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>DIF</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f59e0b;"></div>
                            <span>MACD (Signal)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ef4444;"></div>
                            <span>柱狀體 (正)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>柱狀體 (負)</span>
                        </div>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">DIF 值</span>
                            <span class="card-icon">📈</span>
                        </div>
                        <div class="card-value" id="currentDIF">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">MACD 值</span>
                            <span class="card-icon">📉</span>
                        </div>
                        <div class="card-value" id="currentMACD">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">柱狀體</span>
                            <span class="card-icon">📊</span>
                        </div>
                        <div class="card-value" id="currentOSC">-</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">MACD 狀態</span>
                            <span class="card-icon">🎯</span>
                        </div>
                        <div class="card-value" id="macdSignal" style="font-size: 1.5rem;">-</div>
                    </div>
                </div>
            </div>

            <!-- Tab: Alerts -->
            <div class="tab-content" id="tab-alerts">
                <div class="alerts-section">
                    <div class="alerts-header">
                        <h3 class="chart-title">🚨 智能警示報告</h3>
                        <div class="alert-summary">
                            <div class="alert-count bullish">
                                <span>🟢</span>
                                <span id="bullishCount">0</span> 看漲
                            </div>
                            <div class="alert-count bearish">
                                <span>🔴</span>
                                <span id="bearishCount">0</span> 看跌
                            </div>
                            <div class="alert-count warning">
                                <span>🟡</span>
                                <span id="warningCount">0</span> 警告
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI 綜合燈號 (AI分析後更新) -->
                    <div id="aiAlertLightsPanel" style="display: none; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.15)); border-radius: 15px; border: 2px solid rgba(139, 92, 246, 0.4);">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">🤖</span>
                                <span style="font-weight: 600; color: var(--accent-purple);">AI 三方綜合研判</span>
                            </div>
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <div class="ai-light-indicator" id="aiLightBullish" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4);">
                                    <span style="font-size: 1.8rem;" id="aiLightBullishIcon">⚫</span>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">低風險</div>
                                        <div style="font-weight: 700; color: #10b981;" id="aiLightBullishCount">0</div>
                                    </div>
                                </div>
                                <div class="ai-light-indicator" id="aiLightWarning" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4);">
                                    <span style="font-size: 1.8rem;" id="aiLightWarningIcon">⚫</span>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">中風險</div>
                                        <div style="font-weight: 700; color: #f59e0b;" id="aiLightWarningCount">0</div>
                                    </div>
                                </div>
                                <div class="ai-light-indicator" id="aiLightBearish" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4);">
                                    <span style="font-size: 1.8rem;" id="aiLightBearishIcon">⚫</span>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">高風險</div>
                                        <div style="font-weight: 700; color: #ef4444;" id="aiLightBearishCount">0</div>
                                    </div>
                                </div>
                            </div>
                            <div id="aiFinalLightResult" style="padding: 10px 20px; border-radius: 25px; font-weight: 700; font-size: 1.1rem; background: var(--bg-secondary);">
                                等待分析...
                            </div>
                        </div>
                        <div id="aiFinalLightSummary" style="margin-top: 15px; padding: 12px; background: var(--bg-primary); border-radius: 10px; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;"></div>
                    </div>

                    <div class="score-display">
                        <div class="score-label">綜合評分</div>
                        <div class="score-value" id="alertScore">0</div>
                        <div class="score-range">評分範圍：-100 至 +100</div>
                    </div>

                    <div id="alertsList">
                        <!-- Alerts will be populated here -->
                    </div>
                    
                    <!-- AI 三方解析智能警示 -->
                    <div class="ai-analysis-panel" style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(245, 158, 11, 0.1)); border-radius: 15px; border: 1px solid rgba(239, 68, 68, 0.3);">
                        <h4 style="color: var(--accent-yellow); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>🤖</span> AI 三方智能警示解析
                        </h4>
                        <button class="ai-voting-btn" id="startAlertAiBtn" onclick="startAlertAiAnalysis()" style="margin-bottom: 20px; background: linear-gradient(135deg, #ef4444 0%, #f59e0b 100%);">
                            🚀 啟動 AI 三方解析智能警示
                        </button>
                        
                        <!-- AI 解析卡片 -->
                        <div class="ai-results-container" id="alertAiResults">
                            <div class="ai-result-card claude" id="alertClaudeCard">
                                <div class="ai-card-header">
                                    <span class="ai-icon">🤖</span>
                                    <span class="ai-name">Claude</span>
                                    <span class="ai-status" id="alertClaudeStatus">待命</span>
                                </div>
                                <div class="ai-verdict">
                                    <div class="ai-verdict-label">風險評估</div>
                                    <div class="ai-verdict-value" id="alertClaudeVerdict">-</div>
                                </div>
                                <div class="ai-confidence">
                                    <div class="ai-confidence-label">信心度</div>
                                    <div class="ai-confidence-bar">
                                        <div class="ai-confidence-fill" id="alertClaudeConfidence" style="width: 0%; background: #d68946;"></div>
                                    </div>
                                </div>
                                <div class="ai-analysis-text" id="alertClaudeAnalysis">等待分析...</div>
                            </div>
                            <div class="ai-result-card gemini" id="alertGeminiCard">
                                <div class="ai-card-header">
                                    <span class="ai-icon">✨</span>
                                    <span class="ai-name">Gemini</span>
                                    <span class="ai-status" id="alertGeminiStatus">待命</span>
                                </div>
                                <div class="ai-verdict">
                                    <div class="ai-verdict-label">風險評估</div>
                                    <div class="ai-verdict-value" id="alertGeminiVerdict">-</div>
                                </div>
                                <div class="ai-confidence">
                                    <div class="ai-confidence-label">信心度</div>
                                    <div class="ai-confidence-bar">
                                        <div class="ai-confidence-fill" id="alertGeminiConfidence" style="width: 0%; background: #4285f4;"></div>
                                    </div>
                                </div>
                                <div class="ai-analysis-text" id="alertGeminiAnalysis">等待分析...</div>
                            </div>
                            <div class="ai-result-card openai" id="alertOpenaiCard">
                                <div class="ai-card-header">
                                    <span class="ai-icon">🧠</span>
                                    <span class="ai-name">OpenAI</span>
                                    <span class="ai-status" id="alertOpenaiStatus">待命</span>
                                </div>
                                <div class="ai-verdict">
                                    <div class="ai-verdict-label">風險評估</div>
                                    <div class="ai-verdict-value" id="alertOpenaiVerdict">-</div>
                                </div>
                                <div class="ai-confidence">
                                    <div class="ai-confidence-label">信心度</div>
                                    <div class="ai-confidence-bar">
                                        <div class="ai-confidence-fill" id="alertOpenaiConfidence" style="width: 0%; background: #10a37f;"></div>
                                    </div>
                                </div>
                                <div class="ai-analysis-text" id="alertOpenaiAnalysis">等待分析...</div>
                            </div>
                        </div>
                        
                        <!-- 最終結論 -->
                        <div class="final-verdict-section" id="alertFinalVerdict" style="display: none; margin-top: 20px;">
                            <div class="final-verdict-title">🎯 AI 三方智能警示最終結論</div>
                            <div class="final-verdict-result" id="alertFinalResult">-</div>
                            <div class="voting-summary">
                                <div class="vote-item buy"><span class="vote-icon">🟢</span><span>低風險</span><span class="vote-count" id="alertLowRiskCount">0</span></div>
                                <div class="vote-item hold"><span class="vote-icon">🟡</span><span>中風險</span><span class="vote-count" id="alertMedRiskCount">0</span></div>
                                <div class="vote-item sell"><span class="vote-icon">🔴</span><span>高風險</span><span class="vote-count" id="alertHighRiskCount">0</span></div>
                            </div>
                            <div id="alertFinalSummary" style="margin-top: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 10px; white-space: pre-wrap; color: var(--text-secondary); line-height: 1.8;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Institutional (籌碼面) -->
            <div class="tab-content" id="tab-institutional">
                <div class="institutional-section">
                    <h3 class="chart-title">📊 籌碼面綜合評估</h3>
                    
                    <!-- 籌碼概覽卡片 -->
                    <div class="cards-grid" style="margin-bottom: 20px;">
                        <div class="card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.05));">
                            <div class="card-header">
                                <span class="card-title">外資買賣超</span>
                                <span class="card-icon">🏦</span>
                            </div>
                            <div class="card-value" id="foreignNet" style="font-size: 1.8rem;">+0 張</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.05));">
                            <div class="card-header">
                                <span class="card-title">投信買賣超</span>
                                <span class="card-icon">📈</span>
                            </div>
                            <div class="card-value" id="investmentNet" style="font-size: 1.8rem;">+0 張</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.05));">
                            <div class="card-header">
                                <span class="card-title">自營商買賣超</span>
                                <span class="card-icon">🏢</span>
                            </div>
                            <div class="card-value" id="dealerNet" style="font-size: 1.8rem;">+0 張</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.05));">
                            <div class="card-header">
                                <span class="card-title">三大法人合計</span>
                                <span class="card-icon">📊</span>
                            </div>
                            <div class="card-value" id="totalInstitutional" style="font-size: 1.8rem;">+0 張</div>
                        </div>
                    </div>
                    
                    <!-- 三大法人進出走勢圖 -->
                    <div class="chart-container">
                        <h3 class="chart-title">🏛️ 三大法人進出走勢</h3>
                        <div class="chart-wrapper">
                            <canvas id="institutionalChart"></canvas>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #3b82f6;"></div>
                                <span>外資</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ef4444;"></div>
                                <span>投信</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #a855f7;"></div>
                                <span>自營商</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #f59e0b;"></div>
                                <span>股價</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 籌碼分析說明 -->
                    <div class="analysis-card" style="margin-top: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--text-primary);">📝 籌碼分析說明</h4>
                        <div id="institutionalAnalysis" style="line-height: 1.8; color: var(--text-secondary);">
                            <p>載入股票數據後顯示籌碼分析...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: AI Report -->
            <div class="tab-content" id="tab-ai-report">
                <div class="ai-analysis">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 class="chart-title" style="margin-bottom: 0;">🤖 AI 專業分析報告</h3>
                        <button class="copy-btn" onclick="copyReport()">📋 複製報告</button>
                    </div>
                    <div id="aiReportContent">
                        <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                            AI 分析報告將在數據載入後自動生成...
                        </p>
                    </div>
                </div>
            </div>

            <!-- Tab: AI Voting (三方票決) -->
            <div class="tab-content" id="tab-ai-voting">
                <div class="ai-voting-section">
                    <h3 class="chart-title">🗳️ AI 三方智能票決系統</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        同時諮詢 Claude、Gemini、OpenAI 三大 AI，綜合分析後自動票決出最終投資建議
                    </p>

                    <!-- API 設定區 -->
                    <div class="api-settings">
                        <h4>🔑 API 金鑰設定</h4>
                        <div class="api-input-group">
                            <div class="api-input-item">
                                <label>
                                    <span style="color: #d68946;">🤖</span> Claude API Key (Anthropic)
                                    <span id="claudeKeyStatus" class="api-key-status"></span>
                                </label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="password" id="claudeApiKey" placeholder="sk-ant-api03-..." autocomplete="off" style="flex: 1;">
                                    <button class="api-test-btn" onclick="testSingleApi('claude')" title="測試連線">🔗</button>
                                </div>
                            </div>
                            <div class="api-input-item">
                                <label>
                                    <span style="color: #4285f4;">✨</span> Gemini API Key (Google)
                                    <span id="geminiKeyStatus" class="api-key-status"></span>
                                </label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="password" id="geminiApiKey" placeholder="AIzaSy..." autocomplete="off" style="flex: 1;">
                                    <button class="api-test-btn" onclick="testSingleApi('gemini')" title="測試連線">🔗</button>
                                </div>
                            </div>
                            <div class="api-input-item">
                                <label>
                                    <span style="color: #10a37f;">🧠</span> OpenAI API Key
                                    <span id="openaiKeyStatus" class="api-key-status"></span>
                                </label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="password" id="openaiApiKey" placeholder="sk-..." autocomplete="off" style="flex: 1;">
                                    <button class="api-test-btn" onclick="testSingleApi('openai')" title="測試連線">🔗</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 連線狀態總覽 -->
                        <div id="connectionStatusPanel" style="margin-top: 15px; padding: 15px; background: var(--bg-card); border-radius: 10px; display: none;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">📡 連線狀態</div>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div class="connection-item">
                                    <span style="color: #d68946;">🤖 Claude:</span>
                                    <span id="claudeConnectionStatus" class="conn-status">未測試</span>
                                </div>
                                <div class="connection-item">
                                    <span style="color: #4285f4;">✨ Gemini:</span>
                                    <span id="geminiConnectionStatus" class="conn-status">未測試</span>
                                </div>
                                <div class="connection-item">
                                    <span style="color: #10a37f;">🧠 OpenAI:</span>
                                    <span id="openaiConnectionStatus" class="conn-status">未測試</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="api-note">
                            ⚠️ <strong>注意：</strong>API 金鑰僅在本機瀏覽器中使用，不會上傳至任何伺服器。<br>
                            💡 至少需要輸入一個 API 金鑰才能進行分析。建議三個都輸入以獲得最完整的票決結果。<br>
                            📌 金鑰會儲存在瀏覽器 localStorage 中，下次開啟時自動載入。<br>
                            🔗 點擊「測試所有連線」確認金鑰是否有效。
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="quick-btn" onclick="saveApiKeys()" style="flex: 1; min-width: 120px;">💾 儲存金鑰</button>
                            <button class="quick-btn" onclick="testAllApiConnections()" style="flex: 1; min-width: 120px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3));">🔗 測試所有連線</button>
                            <button class="quick-btn" onclick="toggleApiKeyVisibility()" style="flex: 1; min-width: 120px;">👁️ 顯示/隱藏</button>
                            <button class="quick-btn" onclick="clearApiKeys()" style="flex: 1; min-width: 120px;">🗑️ 清除金鑰</button>
                        </div>
                    </div>

                    <!-- 股票數據狀態指示器 -->
                    <div id="stockDataStatus" style="margin-top: 20px; padding: 15px; border-radius: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">⚠️</span>
                            <div>
                                <div style="font-weight: 600; color: #ef4444;">尚未載入股票數據</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                                    請先在上方輸入股票代號（如 2330、2344、6770），點擊「分析」按鈕載入數據後，再回到此分頁進行 AI 分析。
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 開始分析按鈕 -->
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="ai-voting-btn" id="startAiVotingBtn" onclick="startAiVoting()" style="flex: 3;">
                            🚀 開始 AI 三方分析與票決
                        </button>
                        <button class="quick-btn" onclick="runDiagnostics()" style="flex: 1; padding: 15px;" title="檢查當前狀態">
                            🔍 診斷
                        </button>
                    </div>
                    
                    <!-- 診斷結果 -->
                    <div id="diagnosticsResult" style="display: none; margin-top: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 10px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></div>

                    <!-- AI 分析結果卡片 -->
                    <div class="ai-results-container" id="aiResultsContainer" style="margin-top: 25px;">
                        <!-- Claude -->
                        <div class="ai-result-card claude" id="claudeResultCard">
                            <div class="ai-card-header">
                                <span class="ai-icon">🤖</span>
                                <span class="ai-name">Claude</span>
                                <span class="ai-status" id="claudeStatus">待命</span>
                            </div>
                            <div class="ai-verdict">
                                <div class="ai-verdict-label">投資建議</div>
                                <div class="ai-verdict-value" id="claudeVerdict">-</div>
                            </div>
                            <div class="ai-confidence">
                                <div class="ai-confidence-label">信心度</div>
                                <div class="ai-confidence-bar">
                                    <div class="ai-confidence-fill" id="claudeConfidence" style="width: 0%; background: #d68946;"></div>
                                </div>
                            </div>
                            <div class="ai-analysis-text" id="claudeAnalysis">
                                等待分析...
                            </div>
                        </div>

                        <!-- Gemini -->
                        <div class="ai-result-card gemini" id="geminiResultCard">
                            <div class="ai-card-header">
                                <span class="ai-icon">✨</span>
                                <span class="ai-name">Gemini</span>
                                <span class="ai-status" id="geminiStatus">待命</span>
                            </div>
                            <div class="ai-verdict">
                                <div class="ai-verdict-label">投資建議</div>
                                <div class="ai-verdict-value" id="geminiVerdict">-</div>
                            </div>
                            <div class="ai-confidence">
                                <div class="ai-confidence-label">信心度</div>
                                <div class="ai-confidence-bar">
                                    <div class="ai-confidence-fill" id="geminiConfidence" style="width: 0%; background: #4285f4;"></div>
                                </div>
                            </div>
                            <div class="ai-analysis-text" id="geminiAnalysis">
                                等待分析...
                            </div>
                        </div>

                        <!-- OpenAI -->
                        <div class="ai-result-card openai" id="openaiResultCard">
                            <div class="ai-card-header">
                                <span class="ai-icon">🧠</span>
                                <span class="ai-name">OpenAI</span>
                                <span class="ai-status" id="openaiStatus">待命</span>
                            </div>
                            <div class="ai-verdict">
                                <div class="ai-verdict-label">投資建議</div>
                                <div class="ai-verdict-value" id="openaiVerdict">-</div>
                            </div>
                            <div class="ai-confidence">
                                <div class="ai-confidence-label">信心度</div>
                                <div class="ai-confidence-bar">
                                    <div class="ai-confidence-fill" id="openaiConfidence" style="width: 0%; background: #10a37f;"></div>
                                </div>
                            </div>
                            <div class="ai-analysis-text" id="openaiAnalysis">
                                等待分析...
                            </div>
                        </div>
                    </div>

                    <!-- 最終票決結果 -->
                    <div class="final-verdict-section" id="finalVerdictSection" style="display: none;">
                        <div class="final-verdict-title">
                            🏆 AI 三方票決最終結果
                        </div>
                        <div class="final-verdict-result" id="finalVerdictResult">-</div>
                        <div class="voting-summary">
                            <div class="vote-item buy">
                                <span class="vote-icon">📈</span>
                                <span>買進</span>
                                <span class="vote-count" id="buyVoteCount">0</span>
                            </div>
                            <div class="vote-item sell">
                                <span class="vote-icon">📉</span>
                                <span>賣出</span>
                                <span class="vote-count" id="sellVoteCount">0</span>
                            </div>
                            <div class="vote-item hold">
                                <span class="vote-icon">⏸️</span>
                                <span>觀望</span>
                                <span class="vote-count" id="holdVoteCount">0</span>
                            </div>
                        </div>
                        
                        <!-- 綜合結論區塊 -->
                        <div style="margin-top: 25px; padding: 20px; background: var(--bg-secondary); border-radius: 12px; text-align: left;">
                            <h4 style="color: var(--accent-cyan); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                📋 綜合結論分析
                            </h4>
                            <div id="finalSummaryContent" style="line-height: 1.8; color: var(--text-secondary); white-space: pre-wrap;">
                                等待分析完成...
                            </div>
                        </div>
                        
                        <!-- 平均信心度 -->
                        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;">
                            <div style="text-align: center; padding: 15px 25px; background: var(--bg-card); border-radius: 10px;">
                                <div style="font-size: 0.85rem; color: var(--text-muted);">平均信心度</div>
                                <div id="avgConfidence" style="font-size: 2rem; font-weight: 700; color: var(--accent-blue); font-family: 'JetBrains Mono', monospace;">0%</div>
                            </div>
                            <div style="text-align: center; padding: 15px 25px; background: var(--bg-card); border-radius: 10px;">
                                <div style="font-size: 0.85rem; color: var(--text-muted);">參與票決 AI</div>
                                <div id="votingAiCount" style="font-size: 2rem; font-weight: 700; color: var(--accent-purple); font-family: 'JetBrains Mono', monospace;">0/3</div>
                            </div>
                            <div style="text-align: center; padding: 15px 25px; background: var(--bg-card); border-radius: 10px;">
                                <div style="font-size: 0.85rem; color: var(--text-muted);">一致性</div>
                                <div id="consensusLevel" style="font-size: 2rem; font-weight: 700; color: var(--accent-yellow); font-family: 'JetBrains Mono', monospace;">-</div>
                            </div>
                        </div>
                        
                        <div class="final-verdict-note">
                            ⚠️ 以上分析僅供參考，不構成投資建議。投資有風險，請審慎評估後再做決定。<br>
                            📊 建議搭配其他技術指標與基本面分析，綜合判斷。<br>
                            🕐 分析時間：<span id="analysisTimestamp">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Elliott Wave Theory -->
            <div class="tab-content" id="tab-elliott-wave">
                <div class="elliott-section">
                    <h3 class="chart-title">🌊 艾略特波浪理論分析</h3>
                    
                    <div class="elliott-overview">
                        <div class="elliott-card main-wave">
                            <div class="elliott-card-header">
                                <span class="elliott-icon">🌊</span>
                                <span>當前波浪位置</span>
                            </div>
                            <div class="elliott-wave-position" id="currentWavePosition">-</div>
                            <div class="elliott-wave-desc" id="currentWaveDesc">載入股票數據後顯示</div>
                        </div>
                        <div class="elliott-card">
                            <div class="elliott-card-header">
                                <span class="elliott-icon">📈</span>
                                <span>趨勢方向</span>
                            </div>
                            <div class="elliott-value" id="elliottTrend">-</div>
                        </div>
                        <div class="elliott-card">
                            <div class="elliott-card-header">
                                <span class="elliott-icon">🎯</span>
                                <span>波浪強度</span>
                            </div>
                            <div class="elliott-value" id="elliottStrength">-</div>
                        </div>
                        <div class="elliott-card">
                            <div class="elliott-card-header">
                                <span class="elliott-icon">📊</span>
                                <span>費波納契位置</span>
                            </div>
                            <div class="elliott-value" id="fibonacciLevel">-</div>
                        </div>
                    </div>
                    
                    <!-- AI 波浪綜合燈號 (AI分析後更新) -->
                    <div id="aiWaveLightsPanel" style="display: none; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.15)); border-radius: 15px; border: 2px solid rgba(59, 130, 246, 0.4);">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">🌊</span>
                                <span style="font-weight: 600; color: var(--accent-cyan);">AI 三方波浪研判</span>
                            </div>
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <div class="ai-light-indicator" id="aiWaveLightUp" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.4);">
                                    <span style="font-size: 1.8rem;" id="aiWaveLightUpIcon">⚫</span>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">上升浪</div>
                                        <div style="font-weight: 700; color: #10b981;" id="aiWaveLightUpCount">0</div>
                                    </div>
                                </div>
                                <div class="ai-light-indicator" id="aiWaveLightNeutral" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4);">
                                    <span style="font-size: 1.8rem;" id="aiWaveLightNeutralIcon">⚫</span>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">整理浪</div>
                                        <div style="font-weight: 700; color: #f59e0b;" id="aiWaveLightNeutralCount">0</div>
                                    </div>
                                </div>
                                <div class="ai-light-indicator" id="aiWaveLightDown" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 20px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4);">
                                    <span style="font-size: 1.8rem;" id="aiWaveLightDownIcon">⚫</span>
                                    <div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">下降浪</div>
                                        <div style="font-weight: 700; color: #ef4444;" id="aiWaveLightDownCount">0</div>
                                    </div>
                                </div>
                            </div>
                            <div id="aiWaveFinalLightResult" style="padding: 10px 20px; border-radius: 25px; font-weight: 700; font-size: 1.1rem; background: var(--bg-secondary);">
                                等待分析...
                            </div>
                        </div>
                        <div id="aiWaveFinalLightSummary" style="margin-top: 15px; padding: 12px; background: var(--bg-primary); border-radius: 10px; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;"></div>
                    </div>

                    <div class="elliott-chart-container">
                        <h4>📉 波浪結構圖</h4>
                        <div class="chart-wrapper" style="height: 420px;">
                            <canvas id="elliottChart"></canvas>
                        </div>
                        <!-- 波浪標號圖例 -->
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 10px; justify-content: center;">
                            <div style="font-weight: 600; color: var(--text-primary); width: 100%; text-align: center; margin-bottom: 5px;">📊 波浪標號說明</div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #10b981; color: white; font-weight: bold; font-size: 12px;">1</span>
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">第1浪 (起漲)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #6366f1; color: white; font-weight: bold; font-size: 12px;">2</span>
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">第2浪 (回檔)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #10b981; color: white; font-weight: bold; font-size: 12px;">3</span>
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">第3浪 (主升)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #6366f1; color: white; font-weight: bold; font-size: 12px;">4</span>
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">第4浪 (整理)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #10b981; color: white; font-weight: bold; font-size: 12px;">5</span>
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">第5浪 (末升)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #ef4444; color: white; font-weight: bold; font-size: 12px;">A</span>
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">A浪 (修正開始)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #f59e0b; color: white; font-weight: bold; font-size: 12px;">B</span>
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">B浪 (反彈陷阱)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; background: #ef4444; color: white; font-weight: bold; font-size: 12px;">C</span>
                                <span style="color: var(--text-secondary); font-size: 0.85rem;">C浪 (修正結束)</span>
                            </div>
                        </div>
                    </div>

                    <div class="elliott-details">
                        <div class="elliott-theory-box">
                            <h4>📚 波浪理論說明</h4>
                            <div class="wave-rules">
                                <div class="wave-rule">
                                    <span class="wave-label impulse">推動浪 (1-2-3-4-5)</span>
                                    <p>順應主趨勢方向，由5個子浪組成。第3浪通常最長且最強勁。</p>
                                </div>
                                <div class="wave-rule">
                                    <span class="wave-label corrective">修正浪 (A-B-C)</span>
                                    <p>逆主趨勢方向，由3個子浪組成。用於修正前一個推動浪。</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="elliott-analysis-box">
                            <h4>🔍 當前分析</h4>
                            <div id="elliottAnalysis">
                                <p style="color: var(--text-secondary);">請先載入股票數據...</p>
                            </div>
                        </div>

                        <div class="fibonacci-box">
                            <h4>📐 費波納契回撤/延伸水平</h4>
                            <div class="fibonacci-levels" id="fibonacciLevels">
                                <div class="fib-level">
                                    <span class="fib-label">0%</span>
                                    <span class="fib-price" id="fib0">-</span>
                                </div>
                                <div class="fib-level">
                                    <span class="fib-label">23.6%</span>
                                    <span class="fib-price" id="fib236">-</span>
                                </div>
                                <div class="fib-level">
                                    <span class="fib-label">38.2%</span>
                                    <span class="fib-price" id="fib382">-</span>
                                </div>
                                <div class="fib-level important">
                                    <span class="fib-label">50%</span>
                                    <span class="fib-price" id="fib50">-</span>
                                </div>
                                <div class="fib-level important">
                                    <span class="fib-label">61.8%</span>
                                    <span class="fib-price" id="fib618">-</span>
                                </div>
                                <div class="fib-level">
                                    <span class="fib-label">78.6%</span>
                                    <span class="fib-price" id="fib786">-</span>
                                </div>
                                <div class="fib-level">
                                    <span class="fib-label">100%</span>
                                    <span class="fib-price" id="fib100">-</span>
                                </div>
                                <div class="fib-level extension">
                                    <span class="fib-label">161.8%</span>
                                    <span class="fib-price" id="fib1618">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="wave-prediction-box">
                            <h4>🔮 波浪預測</h4>
                            <div id="wavePrediction">
                                <p style="color: var(--text-secondary);">請先載入股票數據...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI 三方解析波浪理論 -->
                    <div class="ai-analysis-panel" style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 15px; border: 1px solid rgba(59, 130, 246, 0.3);">
                        <h4 style="color: var(--accent-cyan); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <span>🌊</span> AI 三方波浪理論解析
                        </h4>
                        <button class="ai-voting-btn" id="startWaveAiBtn" onclick="startWaveAiAnalysis()" style="margin-bottom: 20px; background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);">
                            🚀 啟動 AI 三方解析波浪理論
                        </button>
                        
                        <!-- AI 解析卡片 -->
                        <div class="ai-results-container" id="waveAiResults">
                            <div class="ai-result-card claude" id="waveClaudeCard">
                                <div class="ai-card-header">
                                    <span class="ai-icon">🤖</span>
                                    <span class="ai-name">Claude</span>
                                    <span class="ai-status" id="waveClaudeStatus">待命</span>
                                </div>
                                <div class="ai-verdict">
                                    <div class="ai-verdict-label">波浪判斷</div>
                                    <div class="ai-verdict-value" id="waveClaudeVerdict">-</div>
                                </div>
                                <div class="ai-confidence">
                                    <div class="ai-confidence-label">信心度</div>
                                    <div class="ai-confidence-bar">
                                        <div class="ai-confidence-fill" id="waveClaudeConfidence" style="width: 0%; background: #d68946;"></div>
                                    </div>
                                </div>
                                <div class="ai-analysis-text" id="waveClaudeAnalysis">等待分析...</div>
                            </div>
                            <div class="ai-result-card gemini" id="waveGeminiCard">
                                <div class="ai-card-header">
                                    <span class="ai-icon">✨</span>
                                    <span class="ai-name">Gemini</span>
                                    <span class="ai-status" id="waveGeminiStatus">待命</span>
                                </div>
                                <div class="ai-verdict">
                                    <div class="ai-verdict-label">波浪判斷</div>
                                    <div class="ai-verdict-value" id="waveGeminiVerdict">-</div>
                                </div>
                                <div class="ai-confidence">
                                    <div class="ai-confidence-label">信心度</div>
                                    <div class="ai-confidence-bar">
                                        <div class="ai-confidence-fill" id="waveGeminiConfidence" style="width: 0%; background: #4285f4;"></div>
                                    </div>
                                </div>
                                <div class="ai-analysis-text" id="waveGeminiAnalysis">等待分析...</div>
                            </div>
                            <div class="ai-result-card openai" id="waveOpenaiCard">
                                <div class="ai-card-header">
                                    <span class="ai-icon">🧠</span>
                                    <span class="ai-name">OpenAI</span>
                                    <span class="ai-status" id="waveOpenaiStatus">待命</span>
                                </div>
                                <div class="ai-verdict">
                                    <div class="ai-verdict-label">波浪判斷</div>
                                    <div class="ai-verdict-value" id="waveOpenaiVerdict">-</div>
                                </div>
                                <div class="ai-confidence">
                                    <div class="ai-confidence-label">信心度</div>
                                    <div class="ai-confidence-bar">
                                        <div class="ai-confidence-fill" id="waveOpenaiConfidence" style="width: 0%; background: #10a37f;"></div>
                                    </div>
                                </div>
                                <div class="ai-analysis-text" id="waveOpenaiAnalysis">等待分析...</div>
                            </div>
                        </div>
                        
                        <!-- 最終結論 -->
                        <div class="final-verdict-section" id="waveFinalVerdict" style="display: none; margin-top: 20px;">
                            <div class="final-verdict-title">🌊 AI 三方波浪理論最終結論</div>
                            <div class="final-verdict-result" id="waveFinalResult">-</div>
                            <div class="voting-summary">
                                <div class="vote-item buy"><span class="vote-icon">📈</span><span>上升浪</span><span class="vote-count" id="waveUpCount">0</span></div>
                                <div class="vote-item hold"><span class="vote-icon">↔️</span><span>整理浪</span><span class="vote-count" id="waveNeutralCount">0</span></div>
                                <div class="vote-item sell"><span class="vote-icon">📉</span><span>下降浪</span><span class="vote-count" id="waveDownCount">0</span></div>
                            </div>
                            <div id="waveFinalSummary" style="margin-top: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 10px; white-space: pre-wrap; color: var(--text-secondary); line-height: 1.8;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let stockData = [];
        let stockName = '';
        let currentStockCode = '';
        let currentMarket = 'twse'; // 'twse' for 上市, 'tpex' for 上櫃
        let technicalIndicators = {};
        let charts = {};
        let institutionalData = null;
        let institutionalHistory = [];
        let watchlist = []; // 自選股清單

        // Market selection
        function selectMarket(market) {
            currentMarket = market;
            document.querySelectorAll('.market-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.market-btn[data-market="${market}"]`).classList.add('active');
            
            // Update placeholder
            const placeholder = market === 'twse' ? '輸入上市股票代號' : '輸入上櫃股票代號';
            document.getElementById('stockCode').placeholder = placeholder;
        }

        // ===== 自選股功能 =====
        
        // 載入自選股
        function loadWatchlist() {
            try {
                const saved = localStorage.getItem('twstock_watchlist');
                if (saved) {
                    watchlist = JSON.parse(saved);
                }
            } catch (e) {
                watchlist = [];
            }
            renderWatchlistTags();
        }

        // 儲存自選股
        function saveWatchlist() {
            localStorage.setItem('twstock_watchlist', JSON.stringify(watchlist));
        }

        // 渲染自選股標籤
        function renderWatchlistTags() {
            const container = document.getElementById('watchlistTags');
            
            if (watchlist.length === 0) {
                container.innerHTML = '<div class="watchlist-empty">尚未添加自選股，請輸入股票代號後點擊「加入自選」</div>';
                return;
            }
            
            container.innerHTML = watchlist.map((item, index) => `
                <div class="watchlist-tag" onclick="analyzeFromWatchlist('${item.code}', '${item.market}')">
                    <span class="tag-name">${item.name || ''}</span>
                    <span class="tag-code">${item.code}</span>
                    <span class="tag-market ${item.market === 'tpex' ? 'tpex' : ''}">${item.market === 'twse' ? '上市' : '上櫃'}</span>
                    <span class="tag-remove" onclick="event.stopPropagation(); removeFromWatchlist(${index})">✕</span>
                </div>
            `).join('');
        }

        // 從主分析區加入自選股
        function addToWatchlist() {
            const code = document.getElementById('stockCode').value.trim();
            if (!code) {
                alert('請先輸入股票代號');
                return;
            }
            
            addStockToWatchlist(code, currentMarket);
        }

        // 快速加入自選股
        function quickAddWatchlist() {
            const code = document.getElementById('watchlistCode').value.trim();
            const market = document.getElementById('watchlistMarket').value;
            
            if (!code) {
                alert('請輸入股票代號');
                return;
            }
            
            addStockToWatchlist(code, market);
            document.getElementById('watchlistCode').value = '';
        }

        // 添加股票到自選股
        function addStockToWatchlist(code, market) {
            // 檢查是否已存在
            const exists = watchlist.some(item => item.code === code && item.market === market);
            if (exists) {
                alert(`${code} 已在自選股中`);
                return;
            }
            
            watchlist.push({ code, market, name: '' });
            saveWatchlist();
            renderWatchlistTags();
            
            // 顯示提示
            showToast(`✅ ${code} 已加入自選股`);
        }

        // 從自選股移除
        function removeFromWatchlist(index) {
            const removed = watchlist[index];
            watchlist.splice(index, 1);
            saveWatchlist();
            renderWatchlistTags();
            showToast(`🗑️ ${removed.code} 已移除`);
            
            // 如果表格有顯示，重新整理
            if (document.getElementById('watchlistTableContainer').style.display !== 'none') {
                fetchAllWatchlist();
            }
        }

        // 清空自選股
        function clearWatchlist() {
            if (watchlist.length === 0) return;
            
            if (confirm('確定要清空所有自選股嗎？')) {
                watchlist = [];
                saveWatchlist();
                renderWatchlistTags();
                document.getElementById('watchlistTableContainer').style.display = 'none';
                showToast('🗑️ 已清空自選股');
            }
        }

        // 從自選股進行分析
        function analyzeFromWatchlist(code, market) {
            document.getElementById('stockCode').value = code;
            selectMarket(market);
            startAnalysis();
        }

        // 批量更新自選股報價
        async function fetchAllWatchlist() {
            if (watchlist.length === 0) {
                alert('請先添加自選股');
                return;
            }
            
            document.getElementById('watchlistLoading').style.display = 'flex';
            document.getElementById('watchlistTableContainer').style.display = 'none';
            
            const results = [];
            
            for (const item of watchlist) {
                try {
                    const data = await fetchLatestQuote(item.code, item.market);
                    if (data) {
                        results.push({
                            ...item,
                            ...data
                        });
                    } else {
                        results.push({
                            ...item,
                            name: item.name || item.code,
                            price: '--',
                            change: '--',
                            changePercent: '--',
                            volume: '--',
                            error: true
                        });
                    }
                } catch (e) {
                    results.push({
                        ...item,
                        name: item.name || item.code,
                        price: '--',
                        change: '--',
                        changePercent: '--',
                        volume: '--',
                        error: true
                    });
                }
                
                // 短暫延遲
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            renderWatchlistTable(results);
            renderWatchlistTags(); // 重新渲染標籤以更新名稱
            document.getElementById('watchlistLoading').style.display = 'none';
            document.getElementById('watchlistTableContainer').style.display = 'block';
        }

        // 獲取單一股票最新報價 - 使用官方即時報價 API
        async function fetchLatestQuote(code, market) {
            try {
                // 使用證交所即時報價 API（盤中即時）
                // 上市: tse_代號.tw, 上櫃: otc_代號.tw
                const exch = market === 'tpex' ? 'otc' : 'tse';
                const url = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${exch}_${code}.tw&json=1&delay=0&_=${Date.now()}`;
                
                // 先嘗試直接請求（mis.twse.com.tw 支援 CORS）
                let data = null;
                try {
                    const response = await fetchWithTimeout(url, 5000);
                    data = await response.json();
                } catch (directError) {
                    console.log('Direct request failed, trying proxy...', directError);
                    // 若直接請求失敗，嘗試使用 proxy
                    data = await fetchWithProxy(url);
                }
                
                if (data && data.msgArray && data.msgArray.length > 0) {
                    const stock = data.msgArray[0];
                    
                    // 解析數據
                    // z: 成交價（可能是 "-" 表示無成交）
                    // y: 昨收, n: 股票名稱, c: 股票代號
                    // v: 成交量(張), o: 開盤, h: 最高, l: 最低
                    // pz: 試撮價, tv: 當盤成交量, d: 日期, t: 時間
                    
                    const name = stock.n || code;
                    const prevClose = parseFloat(stock.y) || 0;
                    const tradeDate = stock.d || ''; // 交易日期 yyyymmdd
                    const tradeTime = stock.t || ''; // 交易時間 hh:mm:ss
                    
                    // 成交價：優先用 z，若無則用試撮價 pz，再無則用昨收
                    let currentPrice = 0;
                    if (stock.z && stock.z !== '-') {
                        currentPrice = parseFloat(stock.z);
                    } else if (stock.pz && stock.pz !== '-') {
                        currentPrice = parseFloat(stock.pz);
                    } else {
                        currentPrice = prevClose; // 無成交時顯示昨收
                    }
                    
                    // 成交量（張）- 累積成交量
                    const volumeInLots = parseInt(stock.v) || 0;
                    
                    if (prevClose > 0) {
                        const change = currentPrice - prevClose;
                        const changePercent = (change / prevClose) * 100;
                        
                        // 更新 watchlist 中的名稱
                        const idx = watchlist.findIndex(w => w.code === code && w.market === market);
                        if (idx !== -1) {
                            watchlist[idx].name = name;
                            saveWatchlist();
                        }
                        
                        return {
                            name: name,
                            price: currentPrice,
                            change: change,
                            changePercent: changePercent,
                            volume: volumeInLots, // 保持「張」為單位
                            prevClose: prevClose,
                            hasTraded: stock.z && stock.z !== '-',
                            tradeDate: tradeDate,
                            tradeTime: tradeTime
                        };
                    }
                }
                
                // 如果官方即時 API 失敗，嘗試 Yahoo Finance 作為備用
                console.log(`Official API returned no data for ${code}, trying Yahoo...`);
                return await fetchLatestQuoteYahoo(code, market);
                
            } catch (e) {
                console.log(`Error fetching quote for ${code}:`, e);
                // 嘗試備用來源
                return await fetchLatestQuoteYahoo(code, market);
            }
        }
        
        // Yahoo Finance 備用報價（提供當日即時數據）
        async function fetchLatestQuoteYahoo(code, market) {
            try {
                const symbol = market === 'tpex' ? `${code}.TWO` : `${code}.TW`;
                // 使用較短的 range 和 interval 取得更即時的數據
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1m&range=1d&_=${Date.now()}`;
                
                const data = await fetchWithProxy(url);
                
                if (data && data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const meta = result.meta;
                    const quotes = result.indicators.quote[0];
                    const len = quotes.close ? quotes.close.length : 0;
                    
                    // 取最後一筆有效數據
                    let lastIndex = len - 1;
                    while (lastIndex >= 0 && (quotes.close[lastIndex] === null || isNaN(quotes.close[lastIndex]))) {
                        lastIndex--;
                    }
                    
                    if (lastIndex < 0) {
                        // 如果當日無數據，用 meta 中的資訊
                        const currentPrice = meta.regularMarketPrice || 0;
                        const prevClose = meta.chartPreviousClose || meta.previousClose || currentPrice;
                        
                        if (currentPrice > 0) {
                            return {
                                name: code,
                                price: currentPrice,
                                change: currentPrice - prevClose,
                                changePercent: prevClose > 0 ? ((currentPrice - prevClose) / prevClose) * 100 : 0,
                                volume: Math.round((meta.regularMarketVolume || 0) / 1000),
                                prevClose: prevClose,
                                hasTraded: true
                            };
                        }
                        return null;
                    }
                    
                    const currentPrice = quotes.close[lastIndex];
                    const prevClose = meta.chartPreviousClose || meta.previousClose || currentPrice;
                    const change = currentPrice - prevClose;
                    const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;
                    
                    // 計算當日總成交量
                    let totalVolume = 0;
                    for (let i = 0; i <= lastIndex; i++) {
                        totalVolume += (quotes.volume[i] || 0);
                    }
                    const volumeInLots = Math.round(totalVolume / 1000); // 轉成張
                    
                    return {
                        name: code, // Yahoo 無法取得中文名
                        price: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        volume: volumeInLots,
                        prevClose: prevClose,
                        hasTraded: true
                    };
                }
            } catch (e) {
                console.log(`Yahoo Finance fallback failed for ${code}:`, e);
            }
            return null;
        }

        // 渲染自選股表格
        function renderWatchlistTable(results) {
            const tbody = document.getElementById('watchlistBody');
            
            tbody.innerHTML = results.map(item => {
                const isUp = item.change > 0;
                const isDown = item.change < 0;
                const priceClass = item.error ? '' : (isUp ? 'price-up' : (isDown ? 'price-down' : 'price-flat'));
                const changeSymbol = isUp ? '+' : '';
                
                const priceDisplay = item.error ? '--' : parseFloat(item.price).toFixed(2);
                const prevCloseDisplay = item.error || !item.prevClose ? '--' : parseFloat(item.prevClose).toFixed(2);
                const changeDisplay = item.error ? '--' : `${changeSymbol}${parseFloat(item.change).toFixed(2)}`;
                const percentDisplay = item.error ? '--' : `${changeSymbol}${parseFloat(item.changePercent).toFixed(2)}%`;
                const volumeDisplay = item.error ? '--' : formatVolume(item.volume);
                
                // 顯示交易狀態
                let statusIndicator = '';
                if (!item.error && item.hasTraded === false) {
                    statusIndicator = ' <span style="color: var(--text-muted); font-size: 0.75rem;">(試撮)</span>';
                }
                
                return `
                    <tr>
                        <td>
                            <div class="stock-name">${item.name || item.code}</div>
                            <div class="stock-code">${item.code}</div>
                        </td>
                        <td>
                            <span class="tag-market ${item.market === 'tpex' ? 'tpex' : ''}">${item.market === 'twse' ? '上市' : '上櫃'}</span>
                        </td>
                        <td class="${priceClass}">${priceDisplay}${statusIndicator}</td>
                        <td class="price-flat">${prevCloseDisplay}</td>
                        <td class="${priceClass}">${changeDisplay}</td>
                        <td class="${priceClass}">${percentDisplay}</td>
                        <td>${volumeDisplay}</td>
                        <td>
                            <a class="analyze-link" onclick="analyzeFromWatchlist('${item.code}', '${item.market}')">📊 分析</a>
                            <button class="remove-btn" onclick="removeFromWatchlistByCode('${item.code}', '${item.market}')">✕</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 根據代號移除自選股
        function removeFromWatchlistByCode(code, market) {
            const index = watchlist.findIndex(w => w.code === code && w.market === market);
            if (index !== -1) {
                removeFromWatchlist(index);
            }
        }

        // 格式化成交量（以張為單位）
        function formatVolume(volume) {
            if (volume >= 10000) {
                return (volume / 10000).toFixed(2) + '萬張';
            } else if (volume >= 1000) {
                return (volume / 1000).toFixed(1) + '千張';
            }
            return volume.toLocaleString() + '張';
        }

        // 顯示提示訊息
        function showToast(message) {
            // 創建 toast 元素
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--bg-card);
                color: var(--text-primary);
                padding: 12px 24px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: toastIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Proxy URL for CORS - with fallback options
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?'
        ];
        let currentProxyIndex = 0;

        async function fetchWithTimeout(url, timeout = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, { 
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                    }
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        async function fetchWithProxy(url) {
            // 嘗試各個代理
            for (let i = 0; i < CORS_PROXIES.length; i++) {
                const proxyIndex = (currentProxyIndex + i) % CORS_PROXIES.length;
                const proxy = CORS_PROXIES[proxyIndex];
                try {
                    const proxyUrl = proxy + encodeURIComponent(url);
                    const response = await fetchWithTimeout(proxyUrl, 8000);
                    if (response.ok) {
                        const text = await response.text();
                        if (text && text.trim()) {
                            try {
                                const data = JSON.parse(text);
                                currentProxyIndex = proxyIndex;
                                return data;
                            } catch {
                                return { raw: text };
                            }
                        }
                    }
                } catch (e) {
                    console.log(`Proxy ${proxyIndex} failed:`, e.message);
                }
            }
            
            return { stat: 'ERROR', data: null };
        }

        // Initialize dates and event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeDates();
            loadWatchlist(); // 載入自選股
            initRankingState(); // 初始化排行榜摺疊狀態
            loadHeatmapData(); // 載入類股熱力圖
            loadETFData(); // 載入ETF報價
            initRealtimeQuickSearch(); // 初始化即時報價快速查詢
            loadMonitorList(); // 載入多股監控清單
            
            document.getElementById('stockCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') quickFetchRealtime(); // 按Enter先查即時報價
            });
            
            document.getElementById('watchlistCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') quickAddWatchlist();
            });
            
            document.getElementById('monitorCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addMonitorStock();
            });
            
            document.getElementById('startDate').addEventListener('change', updateDateInfo);
            document.getElementById('endDate').addEventListener('change', updateDateInfo);
        });

        function initializeDates() {
            const today = new Date();
            const sixtyDaysAgo = new Date(today);
            sixtyDaysAgo.setDate(today.getDate() - 60);
            
            // Format dates for input
            document.getElementById('endDate').value = formatDateForInput(today);
            document.getElementById('startDate').value = formatDateForInput(sixtyDaysAgo);
            
            // Set max date to today
            document.getElementById('endDate').max = formatDateForInput(today);
            document.getElementById('startDate').max = formatDateForInput(today);
            
            updateDateInfo();
        }

        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function updateDateInfo() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (startDate && endDate && !isNaN(startDate) && !isNaN(endDate)) {
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                document.getElementById('dateInfo').innerHTML = 
                    `📅 分析期間：<span>${document.getElementById('startDate').value}</span> 至 <span>${document.getElementById('endDate').value}</span>（約 <span>${diffDays}</span> 天）`;
            }
        }

        function setDateRange(days) {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - days);
            
            document.getElementById('endDate').value = formatDateForInput(today);
            document.getElementById('startDate').value = formatDateForInput(startDate);
            
            // Update active button
            document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateDateInfo();
        }

        async function startAnalysis() {
            const stockCode = document.getElementById('stockCode').value.trim();
            if (!stockCode) {
                showError('請輸入股票代號');
                return;
            }

            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            
            if (!startDateStr || !endDateStr) {
                showError('請選擇起訖日期');
                return;
            }

            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            if (startDate >= endDate) {
                showError('起始日必須早於終止日');
                return;
            }

            if (endDate > today) {
                showError('終止日不能超過今天');
                return;
            }

            currentStockCode = stockCode;
            
            // Reset UI
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.remove('active');
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;

            try {
                // Fetch stock data
                const marketName = currentMarket === 'twse' ? '上市' : '上櫃';
                updateLoadingText(`正在獲取${marketName}股票交易數據...`);
                await fetchStockData(stockCode);

                if (stockData.length === 0) {
                    throw new Error('無法獲取股票數據，請確認股票代號及市場類型是否正確');
                }

                // Fetch institutional data
                updateLoadingText(`正在獲取${marketName}三大法人數據...`);
                await fetchInstitutionalData(stockCode);

                // Calculate technical indicators
                updateLoadingText('正在計算技術指標...');
                calculateAllIndicators();

                // Update UI
                updateLoadingText('正在生成分析報告...');
                updateUI();

                // Show results
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').classList.add('active');
                
                // 更新 AI 票決頁面的股票數據狀態
                updateStockDataStatusForAI();

            } catch (error) {
                console.error('Analysis error:', error);
                showError(error.message || '分析過程發生錯誤，請稍後再試');
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        // 更新 AI 票決頁面的股票數據狀態
        function updateStockDataStatusForAI() {
            const statusEl = document.getElementById('stockDataStatus');
            if (!statusEl) return;
            
            if (stockData && stockData.length > 0 && stockName) {
                const latestData = stockData[stockData.length - 1];
                const price = parseFloat(latestData.close).toFixed(2);
                
                statusEl.style.background = 'rgba(16, 185, 129, 0.1)';
                statusEl.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                statusEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">✅</span>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #10b981;">股票數據已載入</div>
                            <div style="font-size: 0.9rem; color: var(--text-primary); margin-top: 5px;">
                                <strong>${stockName}</strong> (${currentStockCode}) - ${currentMarket === 'twse' ? '上市' : '上櫃'}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 3px;">
                                最新收盤價：${price} 元 | 數據筆數：${stockData.length} 天 | 最新日期：${latestData.date}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
                statusEl.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                statusEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">⚠️</span>
                        <div>
                            <div style="font-weight: 600; color: #ef4444;">尚未載入股票數據</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                                請先在上方輸入股票代號（如 2330、2344、6770），點擊「分析」按鈕載入數據後，再回到此分頁進行 AI 分析。
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // 診斷功能
        function runDiagnostics() {
            const resultEl = document.getElementById('diagnosticsResult');
            resultEl.style.display = 'block';
            
            let report = '=== 🔍 AI 三方票決診斷報告 ===\n\n';
            report += `時間: ${new Date().toLocaleString('zh-TW')}\n\n`;
            
            // 檢查股票數據
            report += '【股票數據狀態】\n';
            report += `- stockData 是否存在: ${stockData ? '是' : '否'}\n`;
            report += `- stockData 長度: ${stockData ? stockData.length : 0}\n`;
            report += `- stockName: ${stockName || '(空)'}\n`;
            report += `- currentStockCode: ${currentStockCode || '(空)'}\n`;
            report += `- currentMarket: ${currentMarket || '(空)'}\n`;
            
            if (stockData && stockData.length > 0) {
                const latest = stockData[stockData.length - 1];
                report += `- 最新數據日期: ${latest.date}\n`;
                report += `- 最新收盤價: ${latest.close}\n`;
            }
            
            // 檢查技術指標
            report += '\n【技術指標狀態】\n';
            report += `- RSI: ${technicalIndicators.rsi || 'N/A'}\n`;
            report += `- K: ${technicalIndicators.k || 'N/A'}\n`;
            report += `- D: ${technicalIndicators.d || 'N/A'}\n`;
            report += `- DIF: ${technicalIndicators.dif || 'N/A'}\n`;
            report += `- MACD: ${technicalIndicators.macd || 'N/A'}\n`;
            
            // 檢查 API 金鑰
            report += '\n【API 金鑰狀態】\n';
            const claudeKey = document.getElementById('claudeApiKey')?.value?.trim();
            const geminiKey = document.getElementById('geminiApiKey')?.value?.trim();
            const openaiKey = document.getElementById('openaiApiKey')?.value?.trim();
            report += `- Claude API Key: ${claudeKey ? '已輸入 (' + claudeKey.substring(0, 10) + '...)' : '未輸入'}\n`;
            report += `- Gemini API Key: ${geminiKey ? '已輸入 (' + geminiKey.substring(0, 10) + '...)' : '未輸入'}\n`;
            report += `- OpenAI API Key: ${openaiKey ? '已輸入 (' + openaiKey.substring(0, 10) + '...)' : '未輸入'}\n`;
            
            // 測試 prepareStockDataSummary
            report += '\n【prepareStockDataSummary 測試】\n';
            try {
                const summary = prepareStockDataSummary();
                if (summary) {
                    report += '- 結果: 成功\n';
                    report += `- 股票: ${summary.stockName} (${summary.stockCode})\n`;
                    report += `- 價格: ${summary.currentPrice}\n`;
                    report += `- 數據天數: ${summary.dataDays}\n`;
                } else {
                    report += '- 結果: 返回 null (數據未載入)\n';
                }
            } catch (err) {
                report += `- 結果: 錯誤 - ${err.message}\n`;
            }
            
            // 建議
            report += '\n【診斷建議】\n';
            if (!stockData || stockData.length === 0) {
                report += '❌ 股票數據未載入，請先在上方輸入股票代號並點擊「分析」按鈕\n';
            } else if (!claudeKey && !geminiKey && !openaiKey) {
                report += '❌ 沒有輸入任何 API 金鑰，請至少輸入一個\n';
            } else {
                report += '✅ 基本條件已滿足，可以開始分析\n';
            }
            
            resultEl.textContent = report;
            resultEl.style.color = 'var(--text-secondary)';
            
            // 也輸出到 console
            console.log(report);
            
            showToast('📋 診斷報告已生成');
        }

        function showError(message) {
            document.getElementById('loading').classList.remove('active');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        async function fetchStockData(stockCode) {
            stockData = [];
            
            if (currentMarket === 'twse') {
                await fetchTWSEData(stockCode);
                // 如果 TWSE 沒資料，嘗試 Yahoo Finance
                if (stockData.length === 0) {
                    console.log('TWSE API failed, trying Yahoo Finance...');
                    await fetchYahooFinanceData(stockCode, 'TW');
                    processStockData(stockCode, stockData.length > 0 ? 1 : 0, '上市');
                }
            } else {
                await fetchTPExData(stockCode);
            }
        }

        // 上市股票資料 (TWSE)
        async function fetchTWSEData(stockCode) {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // Calculate all months to fetch (including buffer for MA calculations)
            const monthsToFetch = [];
            
            // Start from 2 months before the start date (for MA20 calculations)
            let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth() - 2, 1);
            const endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
            
            while (currentMonth <= endMonth) {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth() + 1;
                const dateStr = `${year}${String(month).padStart(2, '0')}01`;
                monthsToFetch.push(dateStr);
                
                // Move to next month
                currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            }
            
            console.log('TWSE Months to fetch:', monthsToFetch);
            
            let fetchedCount = 0;
            for (const dateStr of monthsToFetch) {
                try {
                    updateLoadingText(`正在獲取上市 ${dateStr.substring(0, 4)}/${dateStr.substring(4, 6)} 月份資料...`);
                    
                    const url = `https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${stockCode}`;
                    const data = await fetchWithProxy(url);
                    
                    if (data.stat === 'OK' && data.data && data.data.length > 0) {
                        stockName = data.title ? data.title.split(' ')[2] || stockCode : stockCode;
                        fetchedCount++;
                        
                        data.data.forEach(row => {
                            const rocDate = row[0];
                            const [rocYear, month, day] = rocDate.split('/');
                            const year = parseInt(rocYear) + 1911;
                            const dateString = `${year}/${month}/${day}`;
                            const rowDate = new Date(year, parseInt(month) - 1, parseInt(day));
                            
                            stockData.push({
                                date: dateString,
                                dateObj: rowDate,
                                volume: parseInt(row[1].replace(/,/g, '')),
                                turnover: parseInt(row[2].replace(/,/g, '')),
                                open: parseFloat(row[3].replace(/,/g, '')),
                                high: parseFloat(row[4].replace(/,/g, '')),
                                low: parseFloat(row[5].replace(/,/g, '')),
                                close: parseFloat(row[6].replace(/,/g, '')),
                                change: row[7],
                                transactions: parseInt(row[8].replace(/,/g, ''))
                            });
                        });
                    } else {
                        console.log(`No TWSE data for ${dateStr}:`, data.stat);
                    }
                } catch (e) {
                    console.log(`Error fetching TWSE data for ${dateStr}:`, e);
                }
                
                await new Promise(resolve => setTimeout(resolve, 350));
            }

            processStockData(stockCode, fetchedCount, '上市');
        }

        // 上櫃股票資料 (TPEx) - 優先使用 Yahoo Finance
        async function fetchTPExData(stockCode) {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            // 直接使用 Yahoo Finance 獲取上櫃資料（更穩定）
            updateLoadingText('正在獲取上櫃股票資料...');
            await fetchYahooFinanceData(stockCode, 'TWO');
            
            // 如果 Yahoo Finance 失敗，嘗試 TPEx 官方 API
            if (stockData.length === 0) {
                console.log('Yahoo Finance failed, trying TPEx API...');
                await fetchTPExOfficialData(stockCode, startDate, endDate);
            }

            processStockData(stockCode, stockData.length > 0 ? 1 : 0, '上櫃');
        }
        
        // TPEx 官方 API 抓取
        async function fetchTPExOfficialData(stockCode, startDate, endDate) {
            const monthsToFetch = [];
            let currentMonth = new Date(startDate.getFullYear(), startDate.getMonth() - 2, 1);
            const endMonth = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
            
            while (currentMonth <= endMonth) {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth() + 1;
                const rocYear = year - 1911;
                monthsToFetch.push({ rocYear, year, month });
                currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            }
            
            for (const { rocYear, year, month } of monthsToFetch) {
                try {
                    updateLoadingText(`正在獲取上櫃 ${year}/${String(month).padStart(2, '0')} 資料...`);
                    
                    const dateStr = `${rocYear}/${String(month).padStart(2, '0')}`;
                    const url = `https://www.tpex.org.tw/web/stock/aftertrading/daily_trading_info/st43_result.php?l=zh-tw&d=${dateStr}&stkno=${stockCode}`;
                    
                    const data = await fetchWithProxy(url);
                    
                    if (data && data.aaData && data.aaData.length > 0) {
                        if (!stockName || stockName === stockCode) {
                            stockName = data.stkName || stockCode;
                        }
                        
                        data.aaData.forEach(row => {
                            try {
                                const rocDate = row[0];
                                if (!rocDate || !rocDate.includes('/')) return;
                                
                                const [y, m, d] = rocDate.split('/');
                                const fullYear = parseInt(y) + 1911;
                                const dateString = `${fullYear}/${m}/${d}`;
                                const rowDate = new Date(fullYear, parseInt(m) - 1, parseInt(d));
                                
                                const parseNum = (val) => {
                                    if (!val || val === '--' || val === '-') return NaN;
                                    return parseFloat(String(val).replace(/,/g, ''));
                                };
                                
                                const volume = parseNum(row[1]) * 1000;
                                const open = parseNum(row[2]);
                                const high = parseNum(row[3]);
                                const low = parseNum(row[4]);
                                const close = parseNum(row[5]);
                                
                                if (!isNaN(close) && close > 0) {
                                    stockData.push({
                                        date: dateString,
                                        dateObj: rowDate,
                                        volume: isNaN(volume) ? 0 : volume,
                                        turnover: 0,
                                        open: isNaN(open) ? close : open,
                                        high: isNaN(high) ? close : high,
                                        low: isNaN(low) ? close : low,
                                        close: close,
                                        change: row[6] || '-',
                                        transactions: parseNum(row[7]) || 0
                                    });
                                }
                            } catch (e) {
                                // Skip invalid row
                            }
                        });
                    }
                } catch (e) {
                    console.log(`TPEx fetch error for ${year}/${month}:`, e.message);
                }
                
                await new Promise(resolve => setTimeout(resolve, 300));
            }
        }
        
        // 使用 Yahoo Finance 獲取資料（支援上市和上櫃）
        async function fetchYahooFinanceData(stockCode, market) {
            try {
                const symbol = market === 'TWO' ? `${stockCode}.TWO` : `${stockCode}.TW`;
                const endTimestamp = Math.floor(new Date(document.getElementById('endDate').value).getTime() / 1000) + 86400;
                const startTimestamp = Math.floor(new Date(document.getElementById('startDate').value).getTime() / 1000) - (86400 * 45);
                
                // 使用 Yahoo Finance API
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${startTimestamp}&period2=${endTimestamp}&interval=1d&includePrePost=false`;
                
                console.log('Fetching Yahoo Finance:', symbol);
                
                const data = await fetchWithProxy(url);
                
                if (data && data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const timestamps = result.timestamp;
                    const quotes = result.indicators.quote[0];
                    const meta = result.meta;
                    
                    if (!stockName || stockName === stockCode) {
                        stockName = meta.shortName || meta.longName || stockCode;
                        // 清理股票名稱
                        if (stockName.includes(stockCode)) {
                            stockName = stockName.replace(stockCode, '').trim();
                        }
                    }
                    
                    if (timestamps && quotes && timestamps.length > 0) {
                        for (let i = 0; i < timestamps.length; i++) {
                            const date = new Date(timestamps[i] * 1000);
                            const dateString = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                            
                            const close = quotes.close[i];
                            const open = quotes.open[i];
                            const high = quotes.high[i];
                            const low = quotes.low[i];
                            const volume = quotes.volume[i];
                            
                            if (close && !isNaN(close) && close > 0) {
                                stockData.push({
                                    date: dateString,
                                    dateObj: date,
                                    volume: volume || 0,
                                    turnover: 0,
                                    open: open || close,
                                    high: high || close,
                                    low: low || close,
                                    close: close,
                                    change: '-',
                                    transactions: 0
                                });
                            }
                        }
                        console.log(`Yahoo Finance: fetched ${stockData.length} records for ${symbol}`);
                    }
                } else if (data && data.chart && data.chart.error) {
                    console.log('Yahoo Finance error:', data.chart.error.description);
                }
            } catch (e) {
                console.log('Yahoo Finance fetch failed:', e.message);
            }
        }

        // 處理股票資料
        function processStockData(stockCode, fetchedCount, marketType) {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);

            // Sort by date
            stockData.sort((a, b) => a.dateObj - b.dateObj);
            
            // Remove duplicates based on date
            stockData = stockData.filter((item, index, self) =>
                index === self.findIndex((t) => t.date === item.date)
            );
            
            // Filter to only include data within the selected range (keep buffer data for calculation)
            const bufferStartDate = new Date(startDate);
            bufferStartDate.setDate(bufferStartDate.getDate() - 35); // Buffer for MA20 + KD9
            
            stockData = stockData.filter(item => 
                item.dateObj >= bufferStartDate && item.dateObj <= endDate
            );
            
            console.log(`Fetched ${fetchedCount} months, ${stockData.length} trading days`);
            
            if (stockData.length === 0) {
                const startDateDisplay = document.getElementById('startDate').value;
                const endDateDisplay = document.getElementById('endDate').value;
                throw new Error(`無法獲取${marketType}股票 ${stockCode} 在 ${startDateDisplay} 至 ${endDateDisplay} 期間的交易資料。\n\n可能原因：\n1. 股票代號不正確\n2. 股票市場選擇錯誤（請確認是上市或上櫃）\n3. 選擇的日期範圍內無交易日\n4. 資料尚未更新（約 18:00 後更新）`);
            }
            
            if (stockData.length < 20) {
                console.warn('Warning: Less than 20 trading days, some indicators may not be accurate');
            }
        }

        async function fetchInstitutionalData(stockCode) {
            institutionalData = {
                foreign: 0,
                investment: 0,
                dealer: 0
            };
            institutionalHistory = [];

            try {
                // 獲取多天的三大法人數據
                const dates = getRecentTradingDates(20); // 獲取最近20個交易日
                
                for (const dateStr of dates) {
                    let dayData = null;
                    
                    if (currentMarket === 'twse') {
                        dayData = await fetchTWSEInstitutional(stockCode, dateStr);
                    } else {
                        dayData = await fetchTPExInstitutional(stockCode, dateStr);
                    }
                    
                    if (dayData) {
                        // 找到對應的股價
                        const priceData = stockData.find(d => d.date === dayData.date);
                        const price = priceData ? priceData.close : 0;
                        
                        institutionalHistory.push({
                            date: dayData.date,
                            price: price,
                            foreign: dayData.foreignNet,
                            investment: dayData.trustNet,
                            dealer: dayData.dealerNet
                        });
                    }
                    
                    // 加入延遲避免請求過快
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // 排序（從舊到新）
                institutionalHistory.sort((a, b) => a.date.localeCompare(b.date));
                
                // 設定最新一天的數據
                if (institutionalHistory.length > 0) {
                    const latest = institutionalHistory[institutionalHistory.length - 1];
                    institutionalData.foreign = latest.foreign;
                    institutionalData.investment = latest.investment;
                    institutionalData.dealer = latest.dealer;
                }
                
                console.log('Institutional history loaded:', institutionalHistory.length, 'days');
                
            } catch (e) {
                console.log('Error fetching institutional data:', e);
            }
        }
        
        function getRecentTradingDates(days) {
            // 從 stockData 獲取實際交易日
            if (stockData.length > 0) {
                return stockData.slice(-days).map(d => d.date);
            }
            return [];
        }
        
        // 獲取上市股票三大法人資料
        // TWSE T86 API 欄位順序 (2024年後更新版):
        // 0:證券代號, 1:證券名稱
        // 2:外陸資買進股數(不含外資自營商), 3:外陸資賣出股數, 4:外陸資買賣超股數
        // 5:外資自營商買進股數, 6:外資自營商賣出股數, 7:外資自營商買賣超股數
        // 8:外資及陸資買進股數, 9:外資及陸資賣出股數, 10:外資及陸資買賣超股數 (新增合計欄位)
        // 11:投信買進股數, 12:投信賣出股數, 13:投信買賣超股數
        // 14:自營商買進(自行買賣), 15:自營商賣出(自行買賣), 16:自營商買賣超(自行買賣)
        // 17:自營商買進(避險), 18:自營商賣出(避險), 19:自營商買賣超(避險)
        // 20:自營商買賣超股數(合計)
        // 21:三大法人買賣超股數
        async function fetchTWSEInstitutional(stockCode, date) {
            try {
                // 將日期轉換為 API 格式 (YYYYMMDD)
                const dateStr = date.replace(/\//g, '').replace(/-/g, '');
                const url = `https://www.twse.com.tw/rwd/zh/fund/T86?date=${dateStr}&selectType=ALLBUT0999&response=json`;
                const data = await fetchWithProxy(url);
                
                if (data && data.stat === 'OK' && data.data) {
                    const stockRow = data.data.find(row => row[0].trim() === stockCode);
                    if (stockRow) {
                        // 解析數值，處理特殊減號和逗號
                        const parseNum = (str) => {
                            if (!str) return 0;
                            let cleaned = String(str).replace(/,/g, '').replace(/−/g, '-');
                            return parseInt(cleaned) || 0;
                        };
                        
                        // 檢測 API 版本
                        const isNewFormat = stockRow.length >= 22;
                        
                        // 外資 = 外陸資(不含外資自營商) + 外資自營商
                        const foreignNet = parseNum(stockRow[4]) + parseNum(stockRow[7]);
                        
                        let trustNet, dealerNet;
                        if (isNewFormat) {
                            // 新版 API (22欄位)
                            trustNet = parseNum(stockRow[13]);  // 投信買賣超
                            dealerNet = parseNum(stockRow[20]); // 自營商合計買賣超
                        } else {
                            // 舊版 API
                            trustNet = parseNum(stockRow[10]);
                            dealerNet = parseNum(stockRow[11]);
                        }
                        
                        // 轉換為張數（股數 / 1000）
                        return {
                            date: date,
                            foreignNet: Math.round(foreignNet / 1000),
                            trustNet: Math.round(trustNet / 1000),
                            dealerNet: Math.round(dealerNet / 1000)
                        };
                    }
                }
                return null;
            } catch (e) {
                console.log('TWSE institutional fetch error:', e);
                return null;
            }
        }
        
        // 獲取上櫃股票三大法人資料
        // TPEX 3itrade_hedge_result API 欄位順序:
        // 0:股票代號, 1:股票名稱
        // 2:外資及陸資(不含外資自營商)-買進, 3:賣出, 4:買賣超
        // 5:外資自營商-買進, 6:賣出, 7:買賣超
        // 8:投信-買進, 9:賣出, 10:買賣超
        // 11:自營商(自行買賣)-買進, 12:賣出, 13:買賣超
        // 14:自營商(避險)-買進, 15:賣出, 16:買賣超
        // 17:自營商合計買賣超, 18:三大法人買賣超合計
        async function fetchTPExInstitutional(stockCode, date) {
            try {
                // 轉換為民國年格式
                const dateParts = date.split(/[\/\-]/);
                let year, month, day;
                
                if (dateParts[0].length === 4) {
                    // 西元年格式 2024/01/23 或 2024-01-23
                    year = parseInt(dateParts[0]) - 1911;
                    month = dateParts[1];
                    day = dateParts[2];
                } else {
                    // 可能已經是民國年
                    year = parseInt(dateParts[0]);
                    month = dateParts[1];
                    day = dateParts[2];
                }
                
                const dateStr = `${year}/${month.padStart(2, '0')}/${day.padStart(2, '0')}`;
                const url = `https://www.tpex.org.tw/web/stock/3insti/daily_trade/3itrade_hedge_result.php?l=zh-tw&o=json&se=EW&t=D&d=${dateStr}&s=0,asc`;
                const data = await fetchWithProxy(url);
                
                if (data && data.aaData) {
                    const stockRow = data.aaData.find(row => row[0].trim() === stockCode);
                    if (stockRow) {
                        const parseNum = (val) => {
                            if (val === null || val === undefined) return 0;
                            let cleaned = String(val).replace(/,/g, '').replace(/−/g, '-');
                            return parseInt(cleaned) || 0;
                        };
                        
                        // 外資 = 外陸資(不含外資自營商) + 外資自營商
                        const foreignNet = parseNum(stockRow[4]) + parseNum(stockRow[7]);
                        const trustNet = parseNum(stockRow[10]);  // 投信買賣超
                        const dealerNet = parseNum(stockRow[17]); // 自營商合計買賣超
                        
                        // 轉換為張數（股數 / 1000）
                        return {
                            date: date,
                            foreignNet: Math.round(foreignNet / 1000),
                            trustNet: Math.round(trustNet / 1000),
                            dealerNet: Math.round(dealerNet / 1000)
                        };
                    }
                }
                return null;
            } catch (e) {
                console.log('TPEx institutional fetch error:', e);
                return null;
            }
        }

        function calculateAllIndicators() {
            const closes = stockData.map(d => d.close);
            const highs = stockData.map(d => d.high);
            const lows = stockData.map(d => d.low);
            const volumes = stockData.map(d => d.volume);

            // Calculate Moving Averages
            technicalIndicators.ma5 = calculateMA(closes, 5);
            technicalIndicators.ma10 = calculateMA(closes, 10);
            technicalIndicators.ma20 = calculateMA(closes, 20);

            // Calculate RSI
            technicalIndicators.rsi = calculateRSI(closes, 14);

            // Calculate KD
            const kd = calculateKD(highs, lows, closes, 9);
            technicalIndicators.k = kd.k;
            technicalIndicators.d = kd.d;

            // Calculate MACD
            const macd = calculateMACD(closes);
            technicalIndicators.dif = macd.dif;
            technicalIndicators.macd = macd.macd;
            technicalIndicators.osc = macd.osc;

            // Calculate Bollinger Bands
            technicalIndicators.bollinger = calculateBollinger(closes, 20);

            // Now filter stockData to only show selected date range (remove buffer data)
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            // Find the index range for the selected dates
            let startIdx = 0;
            let endIdx = stockData.length - 1;
            
            for (let i = 0; i < stockData.length; i++) {
                if (stockData[i].dateObj >= startDate) {
                    startIdx = i;
                    break;
                }
            }
            
            for (let i = stockData.length - 1; i >= 0; i--) {
                if (stockData[i].dateObj <= endDate) {
                    endIdx = i;
                    break;
                }
            }
            
            // Slice all data to selected range
            stockData = stockData.slice(startIdx, endIdx + 1);
            technicalIndicators.ma5 = technicalIndicators.ma5.slice(startIdx, endIdx + 1);
            technicalIndicators.ma10 = technicalIndicators.ma10.slice(startIdx, endIdx + 1);
            technicalIndicators.ma20 = technicalIndicators.ma20.slice(startIdx, endIdx + 1);
            technicalIndicators.rsi = technicalIndicators.rsi.slice(startIdx, endIdx + 1);
            technicalIndicators.k = technicalIndicators.k.slice(startIdx, endIdx + 1);
            technicalIndicators.d = technicalIndicators.d.slice(startIdx, endIdx + 1);
            technicalIndicators.dif = technicalIndicators.dif.slice(startIdx, endIdx + 1);
            technicalIndicators.macd = technicalIndicators.macd.slice(startIdx, endIdx + 1);
            technicalIndicators.osc = technicalIndicators.osc.slice(startIdx, endIdx + 1);
            technicalIndicators.bollinger.upper = technicalIndicators.bollinger.upper.slice(startIdx, endIdx + 1);
            technicalIndicators.bollinger.middle = technicalIndicators.bollinger.middle.slice(startIdx, endIdx + 1);
            technicalIndicators.bollinger.lower = technicalIndicators.bollinger.lower.slice(startIdx, endIdx + 1);

            // Recalculate volume analysis with filtered data
            const filteredVolumes = stockData.map(d => d.volume);
            const last20Volumes = filteredVolumes.slice(-Math.min(20, filteredVolumes.length));
            technicalIndicators.avgVolume = last20Volumes.reduce((a, b) => a + b, 0) / last20Volumes.length;
            technicalIndicators.volumeRatio = filteredVolumes[filteredVolumes.length - 1] / technicalIndicators.avgVolume;

            // Support and Resistance (last 20 days of filtered data)
            const recentHighs = highs.slice(startIdx, endIdx + 1).slice(-20);
            const recentLows = lows.slice(startIdx, endIdx + 1).slice(-20);
            technicalIndicators.resistance = Math.max(...recentHighs);
            technicalIndicators.support = Math.min(...recentLows);

            // Generate alerts
            technicalIndicators.alerts = generateAlerts();
        }

        function calculateMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    result.push(sum / period);
                }
            }
            return result;
        }

        function calculateRSI(data, period) {
            const result = [];
            let gains = [];
            let losses = [];

            for (let i = 0; i < data.length; i++) {
                if (i === 0) {
                    result.push(null);
                    continue;
                }

                const change = data[i] - data[i - 1];
                const gain = change > 0 ? change : 0;
                const loss = change < 0 ? -change : 0;

                gains.push(gain);
                losses.push(loss);

                if (i < period) {
                    result.push(null);
                } else {
                    const avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period;
                    const avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period;
                    
                    if (avgLoss === 0) {
                        result.push(100);
                    } else {
                        const rs = avgGain / avgLoss;
                        result.push(100 - (100 / (1 + rs)));
                    }
                }
            }
            return result;
        }

        function calculateKD(highs, lows, closes, period) {
            const k = [];
            const d = [];
            let prevK = 50;
            let prevD = 50;

            for (let i = 0; i < closes.length; i++) {
                if (i < period - 1) {
                    k.push(null);
                    d.push(null);
                    continue;
                }

                const highN = Math.max(...highs.slice(i - period + 1, i + 1));
                const lowN = Math.min(...lows.slice(i - period + 1, i + 1));
                
                const rsv = highN === lowN ? 50 : ((closes[i] - lowN) / (highN - lowN)) * 100;
                
                const currentK = (2/3) * prevK + (1/3) * rsv;
                const currentD = (2/3) * prevD + (1/3) * currentK;
                
                k.push(currentK);
                d.push(currentD);
                
                prevK = currentK;
                prevD = currentD;
            }

            return { k, d };
        }

        function calculateMACD(data) {
            const ema12 = calculateEMA(data, 12);
            const ema26 = calculateEMA(data, 26);
            
            const dif = [];
            for (let i = 0; i < data.length; i++) {
                if (ema12[i] === null || ema26[i] === null) {
                    dif.push(null);
                } else {
                    dif.push(ema12[i] - ema26[i]);
                }
            }

            const macd = calculateEMA(dif.filter(d => d !== null), 9);
            const paddedMacd = Array(data.length - macd.length).fill(null).concat(macd);

            const osc = [];
            for (let i = 0; i < data.length; i++) {
                if (dif[i] === null || paddedMacd[i] === null) {
                    osc.push(null);
                } else {
                    osc.push((dif[i] - paddedMacd[i]) * 2);
                }
            }

            return { dif, macd: paddedMacd, osc };
        }

        function calculateEMA(data, period) {
            const result = [];
            const multiplier = 2 / (period + 1);
            
            const validData = data.filter(d => d !== null);
            if (validData.length < period) {
                return data.map(() => null);
            }

            let ema = validData.slice(0, period).reduce((a, b) => a + b, 0) / period;
            
            let validIndex = 0;
            for (let i = 0; i < data.length; i++) {
                if (data[i] === null) {
                    result.push(null);
                    continue;
                }
                
                if (validIndex < period - 1) {
                    result.push(null);
                } else if (validIndex === period - 1) {
                    result.push(ema);
                } else {
                    ema = (data[i] - ema) * multiplier + ema;
                    result.push(ema);
                }
                validIndex++;
            }
            
            return result;
        }

        function calculateBollinger(data, period) {
            const middle = calculateMA(data, period);
            const upper = [];
            const lower = [];

            for (let i = 0; i < data.length; i++) {
                if (middle[i] === null) {
                    upper.push(null);
                    lower.push(null);
                } else {
                    const slice = data.slice(i - period + 1, i + 1);
                    const std = Math.sqrt(slice.reduce((sum, val) => sum + Math.pow(val - middle[i], 2), 0) / period);
                    upper.push(middle[i] + 2 * std);
                    lower.push(middle[i] - 2 * std);
                }
            }

            return { upper, middle, lower };
        }

        function generateAlerts() {
            const alerts = [];
            const n = stockData.length - 1;
            const closes = stockData.map(d => d.close);
            
            // 1. MA Cross Analysis
            const ma5 = technicalIndicators.ma5;
            const ma10 = technicalIndicators.ma10;
            const ma20 = technicalIndicators.ma20;
            
            if (ma5[n] && ma20[n] && ma5[n-1] && ma20[n-1]) {
                // Golden Cross
                if (ma5[n] > ma20[n] && ma5[n-1] <= ma20[n-1]) {
                    alerts.push({
                        type: 'bullish',
                        priority: 1,
                        title: '均線黃金交叉',
                        description: 'MA5 從下方穿越 MA20，中期趨勢可能轉多'
                    });
                }
                // Death Cross
                if (ma5[n] < ma20[n] && ma5[n-1] >= ma20[n-1]) {
                    alerts.push({
                        type: 'bearish',
                        priority: 1,
                        title: '均線死亡交叉',
                        description: 'MA5 從上方跌破 MA20，中期趨勢可能轉空'
                    });
                }
            }

            // MA Arrangement
            if (ma5[n] && ma10[n] && ma20[n]) {
                if (ma5[n] > ma10[n] && ma10[n] > ma20[n]) {
                    alerts.push({
                        type: 'bullish',
                        priority: 2,
                        title: '多頭排列',
                        description: 'MA5 > MA10 > MA20，均線呈現多頭排列'
                    });
                } else if (ma5[n] < ma10[n] && ma10[n] < ma20[n]) {
                    alerts.push({
                        type: 'bearish',
                        priority: 2,
                        title: '空頭排列',
                        description: 'MA5 < MA10 < MA20，均線呈現空頭排列'
                    });
                }
            }

            // 2. Support/Resistance Analysis
            const currentClose = closes[n];
            const resistance = technicalIndicators.resistance;
            const support = technicalIndicators.support;

            if (currentClose > resistance * 0.995 && closes[n-1] <= resistance * 0.995) {
                alerts.push({
                    type: 'bullish',
                    priority: 1,
                    title: '突破壓力位',
                    description: `股價突破20日高點 ${resistance.toFixed(2)} 元`
                });
            }
            if (currentClose < support * 1.005 && closes[n-1] >= support * 1.005) {
                alerts.push({
                    type: 'bearish',
                    priority: 1,
                    title: '跌破支撐位',
                    description: `股價跌破20日低點 ${support.toFixed(2)} 元`
                });
            }
            if (currentClose >= resistance * 0.97 && currentClose < resistance) {
                alerts.push({
                    type: 'warning',
                    priority: 3,
                    title: '接近壓力位',
                    description: `股價接近20日高點 ${resistance.toFixed(2)} 元，留意突破或回檔`
                });
            }
            if (currentClose <= support * 1.03 && currentClose > support) {
                alerts.push({
                    type: 'warning',
                    priority: 3,
                    title: '接近支撐位',
                    description: `股價接近20日低點 ${support.toFixed(2)} 元，留意跌破或反彈`
                });
            }

            // 3. Volume Analysis
            const volumeRatio = technicalIndicators.volumeRatio;
            const change = currentClose - closes[n-1];

            if (volumeRatio >= 2) {
                if (change > 0) {
                    alerts.push({
                        type: 'bullish',
                        priority: 2,
                        title: '量增價漲',
                        description: `成交量為平均量的 ${volumeRatio.toFixed(1)} 倍，配合價格上漲，多方強勢`
                    });
                } else {
                    alerts.push({
                        type: 'warning',
                        priority: 2,
                        title: '量增價跌',
                        description: `成交量為平均量的 ${volumeRatio.toFixed(1)} 倍，配合價格下跌，留意賣壓`
                    });
                }
            } else if (volumeRatio < 0.5) {
                alerts.push({
                    type: 'neutral',
                    priority: 3,
                    title: '成交量萎縮',
                    description: '成交量低於平均量50%，市場觀望氣氛濃厚'
                });
            }

            // 4. KD Analysis
            const k = technicalIndicators.k[n];
            const d = technicalIndicators.d[n];
            const prevK = technicalIndicators.k[n-1];
            const prevD = technicalIndicators.d[n-1];

            if (k > 80 && d > 80) {
                alerts.push({
                    type: 'warning',
                    priority: 2,
                    title: 'KD 超買',
                    description: `K=${k.toFixed(1)}, D=${d.toFixed(1)}，股價可能面臨回檔壓力`
                });
            }
            if (k < 20 && d < 20) {
                alerts.push({
                    type: 'bullish',
                    priority: 2,
                    title: 'KD 超賣',
                    description: `K=${k.toFixed(1)}, D=${d.toFixed(1)}，股價可能出現反彈`
                });
            }
            if (k > d && prevK <= prevD) {
                alerts.push({
                    type: 'bullish',
                    priority: 2,
                    title: 'KD 黃金交叉',
                    description: 'K 值從下方穿越 D 值，短線買進訊號'
                });
            }
            if (k < d && prevK >= prevD) {
                alerts.push({
                    type: 'bearish',
                    priority: 2,
                    title: 'KD 死亡交叉',
                    description: 'K 值從上方跌破 D 值，短線賣出訊號'
                });
            }

            // 5. RSI Analysis
            const rsi = technicalIndicators.rsi[n];
            if (rsi > 80) {
                alerts.push({
                    type: 'warning',
                    priority: 2,
                    title: 'RSI 超買',
                    description: `RSI=${rsi.toFixed(1)}，股價可能過熱`
                });
            }
            if (rsi < 20) {
                alerts.push({
                    type: 'bullish',
                    priority: 2,
                    title: 'RSI 超賣',
                    description: `RSI=${rsi.toFixed(1)}，股價可能超跌`
                });
            }

            // 6. MACD Analysis
            const dif = technicalIndicators.dif[n];
            const macd = technicalIndicators.macd[n];
            const osc = technicalIndicators.osc[n];
            const prevDif = technicalIndicators.dif[n-1];
            const prevMacd = technicalIndicators.macd[n-1];
            const prevOsc = technicalIndicators.osc[n-1];

            if (dif && macd && prevDif && prevMacd) {
                if (dif > macd && prevDif <= prevMacd) {
                    alerts.push({
                        type: 'bullish',
                        priority: 1,
                        title: 'MACD 黃金交叉',
                        description: 'DIF 從下方穿越 MACD，中期趨勢可能轉多'
                    });
                }
                if (dif < macd && prevDif >= prevMacd) {
                    alerts.push({
                        type: 'bearish',
                        priority: 1,
                        title: 'MACD 死亡交叉',
                        description: 'DIF 從上方跌破 MACD，中期趨勢可能轉空'
                    });
                }
            }
            if (osc && prevOsc) {
                if (osc > 0 && prevOsc <= 0) {
                    alerts.push({
                        type: 'bullish',
                        priority: 2,
                        title: '柱狀體翻正',
                        description: 'MACD 柱狀體由負轉正，動能轉強'
                    });
                }
                if (osc < 0 && prevOsc >= 0) {
                    alerts.push({
                        type: 'bearish',
                        priority: 2,
                        title: '柱狀體翻負',
                        description: 'MACD 柱狀體由正轉負，動能轉弱'
                    });
                }
            }

            // 7. Bollinger Bands
            const upper = technicalIndicators.bollinger.upper[n];
            const lower = technicalIndicators.bollinger.lower[n];

            if (currentClose >= upper) {
                alerts.push({
                    type: 'warning',
                    priority: 3,
                    title: '觸及布林上軌',
                    description: '股價觸及布林通道上軌，短線可能過熱'
                });
            }
            if (currentClose <= lower) {
                alerts.push({
                    type: 'bullish',
                    priority: 3,
                    title: '觸及布林下軌',
                    description: '股價觸及布林通道下軌，短線可能超跌'
                });
            }

            return alerts;
        }

        function updateUI() {
            const n = stockData.length - 1;
            const latestData = stockData[n];
            const prevData = stockData[n - 1];

            // Update stock header
            document.getElementById('stockName').textContent = stockName;
            document.getElementById('displayCode').textContent = currentStockCode;
            
            // Update market tag
            const marketTag = document.getElementById('marketTag');
            if (currentMarket === 'twse') {
                marketTag.textContent = '上市';
                marketTag.className = 'market-tag twse';
            } else {
                marketTag.textContent = '上櫃';
                marketTag.className = 'market-tag tpex';
            }
            
            const startDateDisplay = document.getElementById('startDate').value;
            const endDateDisplay = document.getElementById('endDate').value;
            document.getElementById('stockDate').textContent = `分析期間：${startDateDisplay} 至 ${endDateDisplay}（共 ${stockData.length} 筆交易日）`;
            
            const priceElement = document.getElementById('currentPrice');
            const changeElement = document.getElementById('priceChange');
            
            priceElement.textContent = latestData.close.toFixed(2);
            
            const change = latestData.close - prevData.close;
            const changePercent = (change / prevData.close * 100);
            
            if (change >= 0) {
                priceElement.className = 'current-price price-up';
                changeElement.innerHTML = `<span style="color: var(--accent-up);">▲ ${change.toFixed(2)} (+${changePercent.toFixed(2)}%)</span>`;
            } else {
                priceElement.className = 'current-price price-down';
                changeElement.innerHTML = `<span style="color: var(--accent-down);">▼ ${Math.abs(change).toFixed(2)} (${changePercent.toFixed(2)}%)</span>`;
            }

            // Update overview cards
            const techScore = calculateTechScore();
            document.getElementById('techScore').textContent = techScore + '/100';
            document.getElementById('techProgress').style.width = techScore + '%';
            
            if (techScore >= 70) {
                document.getElementById('techProgress').style.background = 'var(--accent-up)';
            } else if (techScore >= 50) {
                document.getElementById('techProgress').style.background = 'var(--accent-yellow)';
            } else {
                document.getElementById('techProgress').style.background = 'var(--accent-down)';
            }

            const rsi = technicalIndicators.rsi[n];
            document.getElementById('rsiValue').textContent = rsi ? rsi.toFixed(1) : '-';
            document.getElementById('rsiStatus').textContent = rsi > 70 ? '超買區' : rsi < 30 ? '超賣區' : '中性區';

            const k = technicalIndicators.k[n];
            const d = technicalIndicators.d[n];
            document.getElementById('kdValue').textContent = k && d ? `${k.toFixed(1)}/${d.toFixed(1)}` : '-';
            document.getElementById('kdStatus').textContent = k > 80 ? '超買區' : k < 20 ? '超賣區' : '中性區';

            document.getElementById('volumeRatio').textContent = technicalIndicators.volumeRatio.toFixed(2) + 'x';
            document.getElementById('volumeStatus').textContent = technicalIndicators.volumeRatio >= 2 ? '放量' : 
                technicalIndicators.volumeRatio < 0.5 ? '萎縮' : '正常';

            // Key levels
            document.getElementById('resistanceLevel').textContent = technicalIndicators.resistance.toFixed(2);
            document.getElementById('supportLevel').textContent = technicalIndicators.support.toFixed(2);
            document.getElementById('ma5Value').textContent = technicalIndicators.ma5[n] ? technicalIndicators.ma5[n].toFixed(2) : '-';
            document.getElementById('ma20Value').textContent = technicalIndicators.ma20[n] ? technicalIndicators.ma20[n].toFixed(2) : '-';

            const ma5 = technicalIndicators.ma5[n];
            const ma10 = technicalIndicators.ma10[n];
            const ma20 = technicalIndicators.ma20[n];
            if (ma5 > ma10 && ma10 > ma20) {
                document.getElementById('maStatus').textContent = '📈 多頭排列';
                document.getElementById('maStatus').style.color = 'var(--accent-up)';
            } else if (ma5 < ma10 && ma10 < ma20) {
                document.getElementById('maStatus').textContent = '📉 空頭排列';
                document.getElementById('maStatus').style.color = 'var(--accent-down)';
            } else {
                document.getElementById('maStatus').textContent = '➡️ 糾結整理';
                document.getElementById('maStatus').style.color = 'var(--accent-yellow)';
            }

            // Update chart day counts
            const dayCount = stockData.length;
            document.getElementById('priceChartDays').textContent = `(${dayCount}日)`;
            document.getElementById('kdChartDays').textContent = `(${dayCount}日)`;
            document.getElementById('macdChartDays').textContent = `(${dayCount}日)`;

            // Update KD card values
            document.getElementById('currentK').textContent = k ? k.toFixed(2) : '-';
            document.getElementById('currentD').textContent = d ? d.toFixed(2) : '-';
            updateKDSignal();

            // Update MACD card values
            const dif = technicalIndicators.dif[n];
            const macd = technicalIndicators.macd[n];
            const osc = technicalIndicators.osc[n];
            document.getElementById('currentDIF').textContent = dif ? dif.toFixed(3) : '-';
            document.getElementById('currentMACD').textContent = macd ? macd.toFixed(3) : '-';
            document.getElementById('currentOSC').textContent = osc ? osc.toFixed(3) : '-';
            if (osc) {
                document.getElementById('currentOSC').style.color = osc >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
            }
            updateMACDSignal();

            // Draw charts
            drawPriceChart();
            drawKDChart();
            drawMACDChart();

            // Update technical table
            updateTechnicalTable();

            // Update alerts
            updateAlerts();

            // Generate AI report
            generateAIReport();
            
            // 更新籌碼面
            updateInstitutionalDisplay();
            
            // 預先計算波浪理論
            if (stockData.length >= 30) {
                try {
                    window.elliottWaveData = detectElliottWaves(stockData);
                    console.log('Elliott Wave prepared:', window.elliottWaveData.currentWave);
                } catch (e) {
                    console.error('Elliott Wave error:', e);
                }
            }
        }

        function calculateTechScore() {
            let score = 50; // Base score
            const n = stockData.length - 1;
            const alerts = technicalIndicators.alerts;

            // Adjust based on alerts
            alerts.forEach(alert => {
                const weight = alert.priority === 1 ? 8 : alert.priority === 2 ? 5 : 3;
                if (alert.type === 'bullish') {
                    score += weight;
                } else if (alert.type === 'bearish') {
                    score -= weight;
                }
            });

            // Adjust based on MA position
            const close = stockData[n].close;
            const ma20 = technicalIndicators.ma20[n];
            if (ma20 && close > ma20) score += 5;
            if (ma20 && close < ma20) score -= 5;

            return Math.max(0, Math.min(100, Math.round(score)));
        }

        function updateKDSignal() {
            const n = stockData.length - 1;
            const k = technicalIndicators.k[n];
            const d = technicalIndicators.d[n];
            const signalElement = document.getElementById('kdSignal');
            
            if (k > 80 && d > 80) {
                signalElement.textContent = '⚠️ 超買';
                signalElement.style.color = 'var(--accent-down)';
            } else if (k < 20 && d < 20) {
                signalElement.textContent = '💡 超賣';
                signalElement.style.color = 'var(--accent-up)';
            } else if (k > d) {
                signalElement.textContent = '📈 偏多';
                signalElement.style.color = 'var(--accent-up)';
            } else {
                signalElement.textContent = '📉 偏空';
                signalElement.style.color = 'var(--accent-down)';
            }
        }

        function updateMACDSignal() {
            const n = stockData.length - 1;
            const dif = technicalIndicators.dif[n];
            const macd = technicalIndicators.macd[n];
            const osc = technicalIndicators.osc[n];
            const signalElement = document.getElementById('macdSignal');
            
            if (dif > macd && osc > 0) {
                signalElement.textContent = '📈 多方強勢';
                signalElement.style.color = 'var(--accent-up)';
            } else if (dif < macd && osc < 0) {
                signalElement.textContent = '📉 空方強勢';
                signalElement.style.color = 'var(--accent-down)';
            } else if (dif > macd) {
                signalElement.textContent = '↗️ 偏多';
                signalElement.style.color = 'var(--accent-up)';
            } else {
                signalElement.textContent = '↘️ 偏空';
                signalElement.style.color = 'var(--accent-down)';
            }
        }

        function drawPriceChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (charts.priceChart) {
                charts.priceChart.destroy();
            }

            const labels = stockData.map(d => d.date.substring(5));
            
            charts.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '收盤價',
                            data: stockData.map(d => d.close),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'MA5',
                            data: technicalIndicators.ma5,
                            borderColor: '#f59e0b',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'MA10',
                            data: technicalIndicators.ma10,
                            borderColor: '#8b5cf6',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: 'MA20',
                            data: technicalIndicators.ma20,
                            borderColor: '#10b981',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#2d3a4f',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        }
                    }
                }
            });
        }

        function drawKDChart() {
            const ctx = document.getElementById('kdChart').getContext('2d');
            
            if (charts.kdChart) {
                charts.kdChart.destroy();
            }

            const labels = stockData.map(d => d.date.substring(5));

            charts.kdChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'K',
                            data: technicalIndicators.k,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'D',
                            data: technicalIndicators.d,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#2d3a4f',
                            borderWidth: 1
                        },
                        annotation: {
                            annotations: {
                                overbought: {
                                    type: 'box',
                                    yMin: 80,
                                    yMax: 100,
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                    borderWidth: 0
                                },
                                oversold: {
                                    type: 'box',
                                    yMin: 0,
                                    yMax: 20,
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 0
                                },
                                line80: {
                                    type: 'line',
                                    yMin: 80,
                                    yMax: 80,
                                    borderColor: 'rgba(16, 185, 129, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5]
                                },
                                line20: {
                                    type: 'line',
                                    yMin: 20,
                                    yMax: 20,
                                    borderColor: 'rgba(239, 68, 68, 0.5)',
                                    borderWidth: 1,
                                    borderDash: [5, 5]
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                stepSize: 20
                            }
                        }
                    }
                }
            });
        }

        function drawMACDChart() {
            const ctx = document.getElementById('macdChart').getContext('2d');
            
            if (charts.macdChart) {
                charts.macdChart.destroy();
            }

            const labels = stockData.map(d => d.date.substring(5));
            const osc = technicalIndicators.osc;
            
            // Prepare bar colors - 台灣股市：漲紅跌綠
            const barColors = osc.map(v => v >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(16, 185, 129, 0.8)');

            charts.macdChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: '柱狀體',
                            data: osc,
                            backgroundColor: barColors,
                            borderWidth: 0
                        },
                        {
                            type: 'line',
                            label: 'DIF',
                            data: technicalIndicators.dif,
                            borderColor: '#3b82f6',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: 'MACD',
                            data: technicalIndicators.macd,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: '#2d3a4f',
                            borderWidth: 1
                        },
                        annotation: {
                            annotations: {
                                zeroLine: {
                                    type: 'line',
                                    yMin: 0,
                                    yMax: 0,
                                    borderColor: 'rgba(148, 163, 184, 0.5)',
                                    borderWidth: 1
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(45, 58, 79, 0.5)'
                            },
                            ticks: {
                                color: '#64748b'
                            }
                        }
                    }
                }
            });
        }

        // ===== 籌碼面分析 =====
        function drawInstitutionalChart() {
            if (!institutionalHistory || institutionalHistory.length === 0) {
                document.getElementById('institutionalAnalysis').innerHTML = '<p style="color: var(--accent-yellow);">⚠️ 籌碼數據暫無法取得，請稍後再試。</p>';
                return;
            }
            
            const ctx = document.getElementById('institutionalChart').getContext('2d');
            
            if (charts.institutionalChart) {
                charts.institutionalChart.destroy();
            }
            
            const labels = institutionalHistory.map(d => d.date.substring(5));
            const foreignData = institutionalHistory.map(d => d.foreign / 1000); // 轉換為千張
            const investmentData = institutionalHistory.map(d => d.investment / 1000);
            const dealerData = institutionalHistory.map(d => d.dealer / 1000);
            const priceData = institutionalHistory.map(d => d.price);
            
            charts.institutionalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '外資 (千張)',
                            data: foreignData,
                            backgroundColor: foreignData.map(v => v >= 0 ? 'rgba(59, 130, 246, 0.8)' : 'rgba(59, 130, 246, 0.4)'),
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '投信 (千張)',
                            data: investmentData,
                            backgroundColor: investmentData.map(v => v >= 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(239, 68, 68, 0.4)'),
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '自營商 (千張)',
                            data: dealerData,
                            backgroundColor: dealerData.map(v => v >= 0 ? 'rgba(168, 85, 247, 0.8)' : 'rgba(168, 85, 247, 0.4)'),
                            borderColor: '#a855f7',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: '股價',
                            data: priceData,
                            type: 'line',
                            borderColor: '#f59e0b',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 3,
                            pointBackgroundColor: '#f59e0b',
                            yAxisID: 'y1',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#94a3b8' }
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8'
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(45, 58, 79, 0.5)' },
                            ticks: { color: '#64748b', maxTicksLimit: 12 }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            grid: { color: 'rgba(45, 58, 79, 0.5)' },
                            ticks: { color: '#64748b' },
                            title: {
                                display: true,
                                text: '買賣超 (千張)',
                                color: '#64748b'
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#f59e0b' },
                            title: {
                                display: true,
                                text: '股價',
                                color: '#f59e0b'
                            }
                        }
                    }
                }
            });
        }
        
        function updateInstitutionalDisplay() {
            // 更新當日買賣超卡片
            if (institutionalData) {
                const foreign = institutionalData.foreign || 0;
                const investment = institutionalData.investment || 0;
                const dealer = institutionalData.dealer || 0;
                const total = foreign + investment + dealer;
                
                const foreignEl = document.getElementById('foreignNet');
                const investmentEl = document.getElementById('investmentNet');
                const dealerEl = document.getElementById('dealerNet');
                const totalEl = document.getElementById('totalInstitutional');
                
                foreignEl.textContent = `${foreign >= 0 ? '+' : ''}${foreign.toLocaleString()} 張`;
                foreignEl.style.color = foreign >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
                
                investmentEl.textContent = `${investment >= 0 ? '+' : ''}${investment.toLocaleString()} 張`;
                investmentEl.style.color = investment >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
                
                dealerEl.textContent = `${dealer >= 0 ? '+' : ''}${dealer.toLocaleString()} 張`;
                dealerEl.style.color = dealer >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
                
                totalEl.textContent = `${total >= 0 ? '+' : ''}${total.toLocaleString()} 張`;
                totalEl.style.color = total >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
                
                // 生成籌碼分析文字
                generateInstitutionalAnalysis(foreign, investment, dealer, total);
            }
            
            // 繪製圖表
            drawInstitutionalChart();
        }
        
        function generateInstitutionalAnalysis(foreign, investment, dealer, total) {
            let html = '';
            
            // 外資分析
            if (foreign > 0) {
                html += `<p>🏦 <strong>外資買超 ${foreign.toLocaleString()} 張</strong>：外資持續看好，為股價帶來支撐力道。</p>`;
            } else if (foreign < 0) {
                html += `<p>🏦 <strong>外資賣超 ${Math.abs(foreign).toLocaleString()} 張</strong>：外資調節持股，需留意後續動向。</p>`;
            } else {
                html += `<p>🏦 <strong>外資今日無買賣超</strong>：外資觀望中。</p>`;
            }
            
            // 投信分析
            if (investment > 0) {
                html += `<p>📈 <strong>投信買超 ${investment.toLocaleString()} 張</strong>：投信持續加碼，顯示法人看好後市。</p>`;
            } else if (investment < 0) {
                html += `<p>📈 <strong>投信賣超 ${Math.abs(investment).toLocaleString()} 張</strong>：投信調節部位，可能獲利了結。</p>`;
            } else {
                html += `<p>📈 <strong>投信今日無買賣超</strong>：投信觀望中。</p>`;
            }
            
            // 自營商分析
            if (dealer > 0) {
                html += `<p>🏢 <strong>自營商買超 ${dealer.toLocaleString()} 張</strong>：自營商進場佈局。</p>`;
            } else if (dealer < 0) {
                html += `<p>🏢 <strong>自營商賣超 ${Math.abs(dealer).toLocaleString()} 張</strong>：自營商調節持股。</p>`;
            } else {
                html += `<p>🏢 <strong>自營商今日無買賣超</strong>：自營商觀望中。</p>`;
            }
            
            // 總結
            html += '<hr style="border-color: var(--border-color); margin: 15px 0;">';
            if (total > 0) {
                html += `<p style="color: var(--accent-up);"><strong>📊 三大法人合計買超 ${total.toLocaleString()} 張</strong>，籌碼面偏多，有利股價上漲。</p>`;
            } else if (total < 0) {
                html += `<p style="color: var(--accent-down);"><strong>📊 三大法人合計賣超 ${Math.abs(total).toLocaleString()} 張</strong>，籌碼面偏空，需留意股價壓力。</p>`;
            } else {
                html += `<p><strong>📊 三大法人今日買賣超持平</strong>，籌碼面中性。</p>`;
            }
            
            // 歷史趨勢分析
            if (institutionalHistory && institutionalHistory.length >= 5) {
                const recent5 = institutionalHistory.slice(-5);
                const totalForeign = recent5.reduce((sum, d) => sum + d.foreign, 0);
                const totalInvestment = recent5.reduce((sum, d) => sum + d.investment, 0);
                
                html += `<p style="margin-top: 10px; color: var(--text-secondary);">📆 近5日外資累計${totalForeign >= 0 ? '買超' : '賣超'} ${Math.abs(totalForeign).toLocaleString()} 張，投信累計${totalInvestment >= 0 ? '買超' : '賣超'} ${Math.abs(totalInvestment).toLocaleString()} 張。</p>`;
            }
            
            document.getElementById('institutionalAnalysis').innerHTML = html;
        }

        function updateTechnicalTable() {
            const tbody = document.getElementById('technicalBody');
            tbody.innerHTML = '';

            // Show last 20 days
            const recentData = stockData.slice(-20).reverse();
            
            recentData.forEach((data, index) => {
                const realIndex = stockData.length - 1 - index;
                const prevClose = realIndex > 0 ? stockData[realIndex - 1].close : data.close;
                const change = data.close - prevClose;
                const changeClass = change >= 0 ? 'price-up' : 'price-down';
                const changeSymbol = change >= 0 ? '+' : '';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.date}</td>
                    <td>${data.close.toFixed(2)}</td>
                    <td class="${changeClass}">${changeSymbol}${change.toFixed(2)}</td>
                    <td>${(data.volume / 1000).toFixed(0)}K</td>
                    <td>${technicalIndicators.ma5[realIndex]?.toFixed(2) || '-'}</td>
                    <td>${technicalIndicators.ma10[realIndex]?.toFixed(2) || '-'}</td>
                    <td>${technicalIndicators.ma20[realIndex]?.toFixed(2) || '-'}</td>
                    <td>${technicalIndicators.rsi[realIndex]?.toFixed(1) || '-'}</td>
                    <td>${technicalIndicators.k[realIndex]?.toFixed(1) || '-'}</td>
                    <td>${technicalIndicators.d[realIndex]?.toFixed(1) || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateAlerts() {
            const alerts = technicalIndicators.alerts;
            const container = document.getElementById('alertsList');
            container.innerHTML = '';

            let bullishCount = 0, bearishCount = 0, warningCount = 0;
            let alertScore = 0;

            // Sort alerts by priority
            alerts.sort((a, b) => a.priority - b.priority);

            alerts.forEach(alert => {
                // Count types
                if (alert.type === 'bullish') {
                    bullishCount++;
                    alertScore += alert.priority === 1 ? 20 : alert.priority === 2 ? 10 : 5;
                } else if (alert.type === 'bearish') {
                    bearishCount++;
                    alertScore -= alert.priority === 1 ? 20 : alert.priority === 2 ? 10 : 5;
                } else if (alert.type === 'warning') {
                    warningCount++;
                }

                // Get icon and tag
                let icon, tagClass, tagText;
                switch (alert.type) {
                    case 'bullish':
                        icon = '🟢';
                        tagClass = 'tag-bullish';
                        tagText = '看漲';
                        break;
                    case 'bearish':
                        icon = '🔴';
                        tagClass = 'tag-bearish';
                        tagText = '看跌';
                        break;
                    case 'warning':
                        icon = '🟡';
                        tagClass = 'tag-warning';
                        tagText = '警告';
                        break;
                    default:
                        icon = '⚪';
                        tagClass = 'tag-neutral';
                        tagText = '中性';
                }

                const alertHtml = `
                    <div class="alert-item priority-${alert.priority}">
                        <span class="alert-icon">${icon}</span>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-desc">${alert.description}</div>
                        </div>
                        <span class="alert-tag ${tagClass}">${tagText}</span>
                    </div>
                `;
                container.innerHTML += alertHtml;
            });

            // Update counts
            document.getElementById('bullishCount').textContent = bullishCount;
            document.getElementById('bearishCount').textContent = bearishCount;
            document.getElementById('warningCount').textContent = warningCount;

            // Update score
            alertScore = Math.max(-100, Math.min(100, alertScore));
            const scoreElement = document.getElementById('alertScore');
            scoreElement.textContent = (alertScore >= 0 ? '+' : '') + alertScore;
            
            if (alertScore >= 30) {
                scoreElement.style.color = 'var(--accent-up)';
            } else if (alertScore <= -30) {
                scoreElement.style.color = 'var(--accent-down)';
            } else {
                scoreElement.style.color = 'var(--accent-yellow)';
            }
        }

        function generateAIReport() {
            const n = stockData.length - 1;
            const latestData = stockData[n];
            const techScore = calculateTechScore();
            const alerts = technicalIndicators.alerts;

            // Calculate sentiment
            let stance = '中性';
            if (techScore >= 70) stance = '偏多';
            else if (techScore >= 90) stance = '極度看多';
            else if (techScore <= 30) stance = '偏空';
            else if (techScore <= 10) stance = '極度看空';

            // Generate report content
            let report = `
<div class="analysis-section">
    <h4>📊 籌碼面評分：${institutionalData ? '65' : 'N/A'}/100</h4>
    <p>籌碼分析：${institutionalData ? `外資今日${institutionalData.foreign >= 0 ? '買超' : '賣超'} ${Math.abs(institutionalData.foreign).toLocaleString()} 張，投信${institutionalData.investment >= 0 ? '買超' : '賣超'} ${Math.abs(institutionalData.investment).toLocaleString()} 張，自營商${institutionalData.dealer >= 0 ? '買超' : '賣超'} ${Math.abs(institutionalData.dealer).toLocaleString()} 張。` : '籌碼數據暫無法取得，請參考技術面分析。'}</p>
</div>

<div class="analysis-section">
    <h4>📰 消息面評分：待搜尋/100</h4>
    <p>建議搜尋最新公司營運、產業動態、法說會、財報等資訊，以獲得完整消息面分析。</p>
</div>

<hr style="border-color: var(--border-color); margin: 20px 0;">

<div class="analysis-section">
    <h4>🎯 綜合研判</h4>
    
    <p><strong>📍 多空立場：${stance}</strong></p>
    
    <p><strong>📈 短線預測：</strong>${generatePrediction()}</p>
    
    <p><strong>🎯 關鍵價位：</strong></p>
    <ul style="list-style: none; padding-left: 20px;">
        <li>• 壓力：${technicalIndicators.resistance.toFixed(2)} 元</li>
        <li>• 支撐：${technicalIndicators.support.toFixed(2)} 元</li>
    </ul>
</div>

<div class="analysis-section">
    <h4>💡 操作建議</h4>
    ${generateSuggestion()}
</div>

<div class="analysis-section">
    <h4>⚠️ 風險提醒</h4>
    <ul style="list-style: none; padding-left: 0;">
        ${generateRisks()}
    </ul>
</div>
`;

            document.getElementById('aiReportContent').innerHTML = report;
        }

        function generatePrediction() {
            const n = stockData.length - 1;
            const ma5 = technicalIndicators.ma5[n];
            const ma20 = technicalIndicators.ma20[n];
            const close = stockData[n].close;
            const k = technicalIndicators.k[n];
            
            if (ma5 > ma20 && close > ma20) {
                return '技術面站穩均線之上，配合均線多頭排列，預期維持多方走勢。';
            } else if (ma5 < ma20 && close < ma20) {
                return '技術面跌破均線，配合均線空頭排列，短線偏弱整理。';
            } else if (k < 20) {
                return 'KD 進入超賣區，有機會出現技術性反彈。';
            } else if (k > 80) {
                return 'KD 進入超買區，短線留意回檔壓力。';
            }
            return '目前處於均線糾結整理階段，建議等待方向明確後再行布局。';
        }

        function generateSuggestion() {
            const n = stockData.length - 1;
            const close = stockData[n].close;
            const support = technicalIndicators.support;
            const resistance = technicalIndicators.resistance;
            const techScore = calculateTechScore();
            
            const stopLoss = (support * 0.97).toFixed(2);
            const target = (resistance * 1.03).toFixed(2);
            
            if (techScore >= 70) {
                return `
                    <ul style="list-style: none; padding-left: 0;">
                        <li>• 策略：順勢偏多操作</li>
                        <li>• 進場：${support.toFixed(2)} 元附近分批布局</li>
                        <li>• 停損：${stopLoss} 元（約 -3%）</li>
                        <li>• 停利：${target} 元（約 +${((target/close - 1) * 100).toFixed(1)}%）</li>
                    </ul>
                `;
            } else if (techScore <= 30) {
                return `
                    <ul style="list-style: none; padding-left: 0;">
                        <li>• 策略：保守觀望或減碼</li>
                        <li>• 若持有：可於反彈時減碼</li>
                        <li>• 空手者：建議等待止穩訊號</li>
                        <li>• 關注：${support.toFixed(2)} 元是否有效支撐</li>
                    </ul>
                `;
            }
            return `
                <ul style="list-style: none; padding-left: 0;">
                    <li>• 策略：區間操作或觀望</li>
                    <li>• 上檔壓力：${resistance.toFixed(2)} 元</li>
                    <li>• 下檔支撐：${support.toFixed(2)} 元</li>
                    <li>• 建議：等待突破方向明確後再行布局</li>
                </ul>
            `;
        }

        function generateRisks() {
            const risks = [];
            const n = stockData.length - 1;
            const k = technicalIndicators.k[n];
            const volumeRatio = technicalIndicators.volumeRatio;
            
            risks.push('<li>• 大盤系統性風險需持續關注</li>');
            
            if (k > 80) {
                risks.push('<li>• KD 指標超買，留意短線回檔風險</li>');
            }
            if (volumeRatio < 0.5) {
                risks.push('<li>• 成交量萎縮，流動性風險較高</li>');
            }
            if (volumeRatio > 2) {
                risks.push('<li>• 成交量異常放大，留意主力動向</li>');
            }
            risks.push('<li>• 建議搜尋最新消息面資訊以完善分析</li>');
            
            return risks.join('');
        }

        function showTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabId).classList.add('active');
            event.target.classList.add('active');

            // Redraw charts if needed
            if (tabId === 'kd-chart' && charts.kdChart) {
                charts.kdChart.update();
            }
            if (tabId === 'macd-chart' && charts.macdChart) {
                charts.macdChart.update();
            }
            if (tabId === 'elliott-wave' && stockData.length > 0) {
                analyzeElliottWave();
            }
            // 切換到 AI 票決分頁時更新股票數據狀態
            if (tabId === 'ai-voting') {
                updateStockDataStatusForAI();
            }
        }

        function copyReport() {
            const reportContent = document.getElementById('aiReportContent').innerText;
            navigator.clipboard.writeText(reportContent).then(() => {
                alert('報告已複製到剪貼簿！');
            });
        }

        // ===== 類股熱力圖功能 =====
        
        // ===== 即時股價功能 =====
        let realtimeInterval = null;
        let currentRealtimeCode = '';
        let currentRealtimeMarket = 'twse';
        let lastValidRealtimeData = null; // 保存上次有效的即時報價

        // 快速查詢即時報價（輸入代碼後立即顯示）
        async function quickFetchRealtime() {
            const code = document.getElementById('stockCode').value.trim();
            if (!code || code.length < 4) return;
            
            const market = document.querySelector('.market-btn.active')?.dataset.market || 'twse';
            
            // 顯示即時報價區塊
            document.getElementById('realtimeSection').classList.add('active');
            
            // 切換股票時重置上次的數據
            if (code !== currentRealtimeCode || market !== currentRealtimeMarket) {
                lastValidRealtimeData = null;
            }
            
            // 設置當前代碼
            currentRealtimeCode = code;
            currentRealtimeMarket = market;
            
            // 更新顯示（載入中）
            document.getElementById('rtCode').textContent = code;
            document.getElementById('rtName').textContent = '載入中...';
            document.getElementById('rtMarket').textContent = market === 'twse' ? '上市' : '上櫃';
            document.getElementById('rtMarket').className = 'realtime-market-tag' + (market === 'tpex' ? ' tpex' : '');
            
            await refreshRealtimeQuote();
        }

        // 獲取即時報價詳細資訊
        async function fetchRealtimeQuoteDetail(code, market) {
            try {
                const exch = market === 'tpex' ? 'otc' : 'tse';
                const url = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=${exch}_${code}.tw&json=1&delay=0&_=${Date.now()}`;
                
                // 先嘗試直接請求
                let data = null;
                try {
                    const response = await fetchWithTimeout(url, 5000);
                    data = await response.json();
                } catch (directError) {
                    console.log('直接請求失敗，嘗試使用 proxy...', directError.message);
                    // 使用 proxy
                    data = await fetchWithProxy(url);
                }
                
                if (data && data.msgArray && data.msgArray.length > 0) {
                    const stock = data.msgArray[0];
                    
                    // 解析所有欄位
                    const name = stock.n || code;
                    const prevClose = parseFloat(stock.y) || 0;
                    
                    // 五檔報價（先解析，用於備援價格）
                    const askPrices = stock.a ? stock.a.split('_').filter(p => p && p !== '-') : [];
                    const askVolumes = stock.f ? stock.f.split('_').filter(v => v && v !== '-') : [];
                    const bidPrices = stock.b ? stock.b.split('_').filter(p => p && p !== '-') : [];
                    const bidVolumes = stock.g ? stock.g.split('_').filter(v => v && v !== '-') : [];
                    
                    // 獲取其他價格
                    const openPrice = (stock.o && stock.o !== '-') ? parseFloat(stock.o) : 0;
                    const highPrice = (stock.h && stock.h !== '-') ? parseFloat(stock.h) : 0;
                    const lowPrice = (stock.l && stock.l !== '-') ? parseFloat(stock.l) : 0;
                    
                    let currentPrice = 0;
                    let hasTraded = true;
                    let priceSource = '';
                    
                    // Debug 信息
                    console.log(`[${code}] 原始數據: z=${stock.z}, pz=${stock.pz}, o=${stock.o}, h=${stock.h}, l=${stock.l}`);
                    console.log(`[${code}] 五檔買: ${bidPrices.join(',')}, 五檔賣: ${askPrices.join(',')}`);
                    
                    // 優先順序：成交價 > 試撮價 > 買賣中價 > 最高價 > 開盤價 > 昨收價
                    if (stock.z && stock.z !== '-' && parseFloat(stock.z) > 0) {
                        currentPrice = parseFloat(stock.z);
                        priceSource = '成交';
                        hasTraded = true;
                    } else if (stock.pz && stock.pz !== '-' && parseFloat(stock.pz) > 0) {
                        currentPrice = parseFloat(stock.pz);
                        priceSource = '試撮';
                        hasTraded = false;
                    } else if (bidPrices.length > 0 && askPrices.length > 0) {
                        // 使用五檔買賣價中間價
                        const bid1 = parseFloat(bidPrices[0]) || 0;
                        const ask1 = parseFloat(askPrices[0]) || 0;
                        if (bid1 > 0 && ask1 > 0) {
                            currentPrice = (bid1 + ask1) / 2;
                            priceSource = '委託中價';
                            hasTraded = false;
                        }
                    } else if (bidPrices.length > 0 && parseFloat(bidPrices[0]) > 0) {
                        currentPrice = parseFloat(bidPrices[0]);
                        priceSource = '買一價';
                        hasTraded = false;
                    } else if (askPrices.length > 0 && parseFloat(askPrices[0]) > 0) {
                        currentPrice = parseFloat(askPrices[0]);
                        priceSource = '賣一價';
                        hasTraded = false;
                    } else if (highPrice > 0) {
                        // 使用最高價（表示今天有成交過）
                        currentPrice = highPrice;
                        priceSource = '最高價';
                        hasTraded = false;
                    } else if (openPrice > 0) {
                        currentPrice = openPrice;
                        priceSource = '開盤價';
                        hasTraded = false;
                    } else {
                        currentPrice = prevClose;
                        priceSource = '昨收';
                        hasTraded = false;
                    }
                    
                    console.log(`[${code}] 選用: ${priceSource} = ${currentPrice}`);
                    
                    return {
                        code: code,
                        name: name,
                        price: currentPrice,
                        prevClose: prevClose,
                        change: currentPrice - prevClose,
                        changePercent: prevClose > 0 ? ((currentPrice - prevClose) / prevClose * 100) : 0,
                        open: openPrice,
                        high: highPrice,
                        low: lowPrice,
                        volume: parseInt(stock.v) || 0,
                        turnover: parseInt(stock.tv) || 0,
                        limitUp: parseFloat(stock.u) || 0,
                        limitDown: parseFloat(stock.w) || 0,
                        tradeDate: stock.d || '',
                        tradeTime: stock.t || '',
                        hasTraded: hasTraded,
                        priceSource: priceSource,
                        askPrices: askPrices,
                        askVolumes: askVolumes,
                        bidPrices: bidPrices,
                        bidVolumes: bidVolumes,
                        source: 'twse'
                    };
                }
                
                // 只有在首次獲取（沒有上次有效數據）時才使用Yahoo作為備援
                if (!lastValidRealtimeData) {
                    console.log('證交所 API 無數據，首次嘗試 Yahoo Finance...');
                    return await fetchRealtimeFromYahoo(code, market);
                }
                
                // 如果有上次有效數據，返回null讓refreshRealtimeQuote保持上次數據
                console.log('證交所 API 暫時無數據，將維持上次報價');
                return null;
                
            } catch (e) {
                console.error('即時報價獲取失敗:', e);
                // 只有首次才用備援
                if (!lastValidRealtimeData) {
                    return await fetchRealtimeFromYahoo(code, market);
                }
                return null;
            }
        }
        
        // Yahoo Finance 備援即時報價
        async function fetchRealtimeFromYahoo(code, market) {
            try {
                const symbol = market === 'tpex' ? `${code}.TWO` : `${code}.TW`;
                const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1m&range=1d&_=${Date.now()}`;
                
                const data = await fetchWithProxy(url);
                
                if (data && data.chart && data.chart.result && data.chart.result[0]) {
                    const result = data.chart.result[0];
                    const meta = result.meta;
                    const quotes = result.indicators.quote[0];
                    
                    // 取得最新價格
                    let currentPrice = meta.regularMarketPrice || 0;
                    let prevClose = meta.chartPreviousClose || meta.previousClose || 0;
                    let open = meta.regularMarketOpen || 0;
                    let high = meta.regularMarketDayHigh || 0;
                    let low = meta.regularMarketDayLow || 0;
                    let volume = Math.round((meta.regularMarketVolume || 0) / 1000);
                    
                    // 從分鐘數據取得更準確的值
                    if (quotes && quotes.close) {
                        const len = quotes.close.length;
                        for (let i = len - 1; i >= 0; i--) {
                            if (quotes.close[i] && !isNaN(quotes.close[i])) {
                                currentPrice = quotes.close[i];
                                break;
                            }
                        }
                    }
                    
                    if (currentPrice > 0) {
                        return {
                            code: code,
                            name: meta.shortName || meta.symbol || code,
                            price: currentPrice,
                            prevClose: prevClose,
                            change: currentPrice - prevClose,
                            changePercent: prevClose > 0 ? ((currentPrice - prevClose) / prevClose * 100) : 0,
                            open: open,
                            high: high,
                            low: low,
                            volume: volume,
                            turnover: 0,
                            limitUp: Math.round(prevClose * 1.1 * 100) / 100,
                            limitDown: Math.round(prevClose * 0.9 * 100) / 100,
                            tradeDate: '',
                            tradeTime: new Date().toLocaleTimeString('zh-TW'),
                            hasTraded: true,
                            askPrices: [],
                            askVolumes: [],
                            bidPrices: [],
                            bidVolumes: [],
                            source: 'yahoo' // 標記數據來源
                        };
                    }
                }
            } catch (e) {
                console.error('Yahoo Finance 備援失敗:', e);
            }
            return null;
        }

        // 更新即時報價顯示
        function updateRealtimeDisplay(data) {
            if (!data) {
                document.getElementById('rtName').textContent = '(無法取得資料)';
                return;
            }
            
            // 基本資訊
            document.getElementById('rtCode').textContent = data.code;
            document.getElementById('rtName').textContent = data.name;
            
            // 價格
            const priceEl = document.getElementById('rtPrice');
            const changeEl = document.getElementById('rtChange');
            
            // 檢查價格是否有變化，觸發閃爍
            const oldPrice = parseFloat(priceEl.textContent) || 0;
            const newPrice = data.price;
            
            priceEl.textContent = data.price > 0 ? data.price.toFixed(2) : '---';
            
            const isUp = data.change > 0;
            const isDown = data.change < 0;
            const sign = isUp ? '+' : '';
            const priceClass = isUp ? 'realtime-price-up' : (isDown ? 'realtime-price-down' : 'realtime-price-flat');
            
            priceEl.className = 'realtime-current-price ' + priceClass;
            changeEl.className = 'realtime-price-change ' + priceClass;
            
            // 價格更新閃爍效果
            if (oldPrice !== newPrice && oldPrice > 0) {
                priceEl.classList.add('price-flash');
                setTimeout(() => priceEl.classList.remove('price-flash'), 1000);
                
                // 顯示更新訊號
                const flashEl = document.getElementById('rtUpdateFlash');
                if (flashEl) {
                    flashEl.style.display = 'inline';
                    flashEl.classList.add('update-pulse');
                    setTimeout(() => {
                        flashEl.style.display = 'none';
                        flashEl.classList.remove('update-pulse');
                    }, 2000);
                }
            }
            
            if (data.price > 0) {
                changeEl.textContent = `${isUp ? '▲' : (isDown ? '▼' : '－')} ${sign}${data.change.toFixed(2)} (${sign}${data.changePercent.toFixed(2)}%)`;
            } else {
                changeEl.textContent = '--- (--%)';
            }
            
            // 更新時間和狀態
            document.getElementById('rtUpdateTime').textContent = data.tradeTime || new Date().toLocaleTimeString('zh-TW');
            
            // 顯示價格來源和交易狀態
            let statusText = '';
            if (!data.hasTraded) {
                if (data.priceSource) {
                    statusText = ` ⚠️ ${data.priceSource}`;
                } else {
                    statusText = ' ⚠️ 試撮價';
                }
            }
            document.getElementById('rtTradeStatus').textContent = statusText;
            
            // 昨收價 vs 即時價 比較顯示
            const prevDisplay = document.getElementById('rtPrevDisplay');
            const currentDisplay = document.getElementById('rtCurrentDisplay');
            const diffDisplay = document.getElementById('rtDiffDisplay');
            
            if (prevDisplay && currentDisplay && diffDisplay) {
                prevDisplay.textContent = data.prevClose > 0 ? data.prevClose.toFixed(2) : '---';
                currentDisplay.textContent = data.price > 0 ? data.price.toFixed(2) : '---';
                currentDisplay.style.color = isUp ? 'var(--accent-up)' : (isDown ? 'var(--accent-down)' : 'var(--text-secondary)');
                
                // 即時價閃爍
                if (oldPrice !== newPrice && oldPrice > 0) {
                    currentDisplay.classList.add('price-flash');
                    setTimeout(() => currentDisplay.classList.remove('price-flash'), 1000);
                }
                
                if (data.price > 0 && data.prevClose > 0) {
                    const diff = data.price - data.prevClose;
                    const diffSign = diff > 0 ? '+' : '';
                    diffDisplay.textContent = `${diffSign}${diff.toFixed(2)}`;
                    diffDisplay.style.color = diff > 0 ? 'var(--accent-up)' : (diff < 0 ? 'var(--accent-down)' : 'var(--text-secondary)');
                } else {
                    diffDisplay.textContent = '---';
                    diffDisplay.style.color = 'var(--text-secondary)';
                }
            }
            
            // 詳細資訊
            document.getElementById('rtOpen').textContent = data.open > 0 ? data.open.toFixed(2) : '---';
            document.getElementById('rtHigh').textContent = data.high > 0 ? data.high.toFixed(2) : '---';
            document.getElementById('rtLow').textContent = data.low > 0 ? data.low.toFixed(2) : '---';
            document.getElementById('rtPrevClose').textContent = data.prevClose > 0 ? data.prevClose.toFixed(2) : '---';
            document.getElementById('rtVolume').textContent = data.volume > 0 ? formatVolume(data.volume) : '---';
            document.getElementById('rtTurnover').textContent = data.turnover > 0 ? formatMoney(data.turnover * 1000) : '---';
            document.getElementById('rtLimitUp').textContent = data.limitUp > 0 ? data.limitUp.toFixed(2) : '---';
            document.getElementById('rtLimitDown').textContent = data.limitDown > 0 ? data.limitDown.toFixed(2) : '---';
            
            // 五檔報價
            updateFivePrices(data);
            
            // 重新計算持有損益
            calculateHoldingProfit();
        }

        // 更新五檔報價
        function updateFivePrices(data) {
            const bidContainer = document.getElementById('rtBidPrices');
            const askContainer = document.getElementById('rtAskPrices');
            
            // 買價（由高到低）
            let bidHtml = '';
            for (let i = 0; i < 5; i++) {
                const price = data.bidPrices[i] || '---';
                const vol = data.bidVolumes[i] ? parseInt(data.bidVolumes[i]).toLocaleString() : '---';
                bidHtml += `<div class="five-price-row bid"><span>買${i+1}</span><span>${price}</span><span>${vol}</span></div>`;
            }
            bidContainer.innerHTML = bidHtml;
            
            // 賣價（由低到高）
            let askHtml = '';
            for (let i = 0; i < 5; i++) {
                const price = data.askPrices[i] || '---';
                const vol = data.askVolumes[i] ? parseInt(data.askVolumes[i]).toLocaleString() : '---';
                askHtml += `<div class="five-price-row ask"><span>賣${i+1}</span><span>${price}</span><span>${vol}</span></div>`;
            }
            askContainer.innerHTML = askHtml;
        }

        // 格式化金額
        function formatMoney(value) {
            if (value >= 100000000) {
                return (value / 100000000).toFixed(2) + ' 億';
            } else if (value >= 10000) {
                return (value / 10000).toFixed(2) + ' 萬';
            }
            return value.toLocaleString();
        }

        // 計算持有損益
        function calculateHoldingProfit() {
            const holdPriceInput = document.getElementById('rtHoldPrice');
            const holdSharesInput = document.getElementById('rtHoldShares');
            const profitPerShareEl = document.getElementById('rtProfitPerShare');
            const totalProfitEl = document.getElementById('rtTotalProfit');
            const totalValueEl = document.getElementById('rtTotalValue');
            
            if (!holdPriceInput || !profitPerShareEl) return;
            
            const holdPrice = parseFloat(holdPriceInput.value) || 0;
            const holdShares = parseInt(holdSharesInput.value) || 1;
            const currentPriceText = document.getElementById('rtPrice')?.textContent;
            const currentPrice = parseFloat(currentPriceText) || 0;
            
            if (holdPrice <= 0 || currentPrice <= 0) {
                profitPerShareEl.textContent = '---';
                profitPerShareEl.style.color = 'var(--text-secondary)';
                totalProfitEl.textContent = '---';
                totalProfitEl.style.color = 'var(--text-secondary)';
                if (totalValueEl) totalValueEl.textContent = '---';
                return;
            }
            
            // 計算每股損益
            const profitPerShare = currentPrice - holdPrice;
            const profitPercent = (profitPerShare / holdPrice) * 100;
            
            // 計算總損益（1張 = 1000股）
            const totalProfit = profitPerShare * holdShares * 1000;
            const totalValue = currentPrice * holdShares * 1000;
            
            const isProfit = profitPerShare > 0;
            const isLoss = profitPerShare < 0;
            const color = isProfit ? 'var(--accent-up)' : (isLoss ? 'var(--accent-down)' : 'var(--text-secondary)');
            const sign = isProfit ? '+' : '';
            
            // 更新顯示 - 每股損益含百分比
            profitPerShareEl.innerHTML = `${sign}${profitPerShare.toFixed(2)}<br><span style="font-size: 0.8rem;">(${sign}${profitPercent.toFixed(2)}%)</span>`;
            profitPerShareEl.style.color = color;
            
            // 總損益
            const totalProfitDisplay = Math.abs(totalProfit) >= 10000 
                ? `${sign}${(totalProfit / 10000).toFixed(2)}萬` 
                : `${sign}${totalProfit.toLocaleString()}`;
            totalProfitEl.textContent = totalProfitDisplay;
            totalProfitEl.style.color = color;
            
            // 市值
            if (totalValueEl) {
                const totalValueDisplay = totalValue >= 10000 
                    ? `${(totalValue / 10000).toFixed(2)}萬` 
                    : totalValue.toLocaleString();
                totalValueEl.textContent = totalValueDisplay;
            }
        }

        // 手動刷新即時報價
        async function refreshRealtimeQuote() {
            if (!currentRealtimeCode) return;
            
            const btn = document.getElementById('rtRefreshBtn');
            const icon = document.getElementById('rtRefreshIcon');
            
            btn.classList.add('refreshing');
            icon.textContent = '⏳';
            icon.classList.add('spinner');
            
            try {
                const data = await fetchRealtimeQuoteDetail(currentRealtimeCode, currentRealtimeMarket);
                
                // 只有當獲取到有效數據時才更新
                if (data && data.price > 0) {
                    // 檢查是否為有效的即時數據（有交易時間）
                    if (data.tradeTime || data.hasTraded !== undefined) {
                        lastValidRealtimeData = data;
                        updateRealtimeDisplay(data);
                    } else if (lastValidRealtimeData) {
                        // 如果新數據可能是歷史數據，保持上次的即時數據，只更新時間
                        lastValidRealtimeData.tradeTime = new Date().toLocaleTimeString('zh-TW');
                        updateRealtimeDisplay(lastValidRealtimeData);
                        console.log('保持上次即時報價，避免跳到歷史價');
                    }
                } else if (lastValidRealtimeData) {
                    // 獲取失敗時，保持上次的數據，只更新時間顯示
                    document.getElementById('rtUpdateTime').textContent = new Date().toLocaleTimeString('zh-TW') + ' (維持)';
                    console.log('獲取失敗，維持上次即時報價');
                }
            } catch (e) {
                console.error('刷新失敗:', e);
                // 保持上次的數據
                if (lastValidRealtimeData) {
                    document.getElementById('rtUpdateTime').textContent = new Date().toLocaleTimeString('zh-TW') + ' (維持)';
                }
            }
            
            btn.classList.remove('refreshing');
            icon.textContent = '🔄';
            icon.classList.remove('spinner');
        }

        // 自動刷新開關
        function toggleAutoRefresh() {
            const checked = document.getElementById('rtAutoRefresh').checked;
            
            if (checked) {
                // 開始自動刷新
                realtimeInterval = setInterval(refreshRealtimeQuote, 15000);
                showToast('🔄 已開啟自動更新（每 15 秒）');
            } else {
                // 停止自動刷新
                if (realtimeInterval) {
                    clearInterval(realtimeInterval);
                    realtimeInterval = null;
                }
                showToast('⏸️ 已關閉自動更新');
            }
        }

        // 從即時報價開始歷史分析
        function startHistoricalAnalysis() {
            if (currentRealtimeCode) {
                document.getElementById('stockCode').value = currentRealtimeCode;
                // 確保市場選擇正確
                document.querySelectorAll('.market-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.market === currentRealtimeMarket);
                });
            }
            startAnalysis();
        }

        // 為股票代碼輸入框添加即時查詢功能
        function initRealtimeQuickSearch() {
            const input = document.getElementById('stockCode');
            let debounceTimer = null;
            
            input.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                const code = this.value.trim();
                
                if (code.length >= 4) {
                    debounceTimer = setTimeout(() => {
                        quickFetchRealtime();
                    }, 500);
                }
            });
        }

        // ===== 多股即時監控功能 =====
        let monitorStocks = []; // 監控清單 [{code, market, holdPrice, shares, data}]
        let monitorInterval = null;
        let monitorIntervalSeconds = 30; // 預設30秒
        let tradingTimeChecker = null; // 交易時間檢查器
        const MAX_MONITOR = 8;
        const STAGGER_DELAY = 2000; // 每檔間隔2秒錯開

        // 檢查是否為交易時間 (週一~週五 09:00~13:30)
        function isTradingTime() {
            const now = new Date();
            const day = now.getDay(); // 0=週日, 1=週一, ..., 6=週六
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const timeValue = hours * 60 + minutes; // 轉換為分鐘數方便比較
            
            // 週六(6)、週日(0) 不是交易日
            if (day === 0 || day === 6) {
                return false;
            }
            
            // 交易時間 09:00 ~ 13:30
            const marketOpen = 9 * 60; // 09:00 = 540分鐘
            const marketClose = 13 * 60 + 30; // 13:30 = 810分鐘
            
            return timeValue >= marketOpen && timeValue <= marketClose;
        }

        // 取得交易狀態文字
        function getTradingStatusText() {
            const now = new Date();
            const day = now.getDay();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const timeValue = hours * 60 + minutes;
            
            if (day === 0 || day === 6) {
                return '🔴 休市（週末）';
            }
            
            const marketOpen = 9 * 60;
            const marketClose = 13 * 60 + 30;
            
            if (timeValue < marketOpen) {
                const diffMin = marketOpen - timeValue;
                const diffHours = Math.floor(diffMin / 60);
                const diffMins = diffMin % 60;
                return `🟡 盤前（${diffHours}時${diffMins}分後開盤）`;
            } else if (timeValue > marketClose) {
                return '🔴 已收盤';
            } else {
                return '🟢 交易中';
            }
        }

        // 更新交易狀態顯示
        function updateTradingStatus() {
            const statusEl = document.getElementById('tradingStatusText');
            if (statusEl) {
                statusEl.textContent = getTradingStatusText();
            }
        }

        // 自動啟動/停止監控（根據交易時間）
        function checkAndAutoStartMonitor() {
            const autoCheckbox = document.getElementById('monitorAutoRefresh');
            const smartAutoCheckbox = document.getElementById('monitorSmartAuto');
            
            if (!smartAutoCheckbox || !smartAutoCheckbox.checked) {
                return; // 智能模式未開啟
            }
            
            const isTradingNow = isTradingTime();
            const isCurrentlyRunning = monitorInterval !== null;
            
            if (isTradingNow && !isCurrentlyRunning && monitorStocks.length > 0) {
                // 交易時間且未運行 → 自動啟動
                console.log('[智能監控] 進入交易時間，自動啟動監控');
                autoCheckbox.checked = true;
                startMonitorAutoRefresh();
                showToast('🟢 交易時間，自動啟動監控');
            } else if (!isTradingNow && isCurrentlyRunning) {
                // 非交易時間且正在運行 → 自動停止
                console.log('[智能監控] 離開交易時間，自動停止監控');
                autoCheckbox.checked = false;
                stopMonitorAutoRefresh();
                showToast('🔴 非交易時間，自動停止監控');
            }
            
            updateTradingStatus();
        }

        // 啟動監控自動更新
        function startMonitorAutoRefresh() {
            if (monitorInterval) return; // 已經在運行
            
            refreshAllMonitorStaggered();
            monitorInterval = setInterval(refreshAllMonitorStaggered, monitorIntervalSeconds * 1000);
        }

        // 停止監控自動更新
        function stopMonitorAutoRefresh() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
            }
        }

        // 開啟/關閉智能交易時間模式
        function toggleSmartAutoMode() {
            const smartCheckbox = document.getElementById('monitorSmartAuto');
            
            if (smartCheckbox.checked) {
                // 開啟智能模式 - 每分鐘檢查一次交易時間
                tradingTimeChecker = setInterval(checkAndAutoStartMonitor, 60000);
                checkAndAutoStartMonitor(); // 立即檢查一次
                showToast('🧠 已開啟智能模式（交易時間自動監控）');
                localStorage.setItem('monitorSmartAuto', 'true');
            } else {
                // 關閉智能模式
                if (tradingTimeChecker) {
                    clearInterval(tradingTimeChecker);
                    tradingTimeChecker = null;
                }
                showToast('⏹️ 已關閉智能模式');
                localStorage.setItem('monitorSmartAuto', 'false');
            }
            
            updateTradingStatus();
        }

        // 從 localStorage 載入監控清單
        function loadMonitorList() {
            try {
                const saved = localStorage.getItem('monitorStocks');
                if (saved) {
                    monitorStocks = JSON.parse(saved);
                    renderMonitorGrid();
                    if (monitorStocks.length > 0) {
                        refreshAllMonitorStaggered();
                    }
                }
                // 載入間隔設定
                const savedInterval = localStorage.getItem('monitorIntervalSeconds');
                if (savedInterval) {
                    monitorIntervalSeconds = parseInt(savedInterval);
                    document.getElementById('monitorInterval').value = monitorIntervalSeconds;
                }
                // 載入智能模式設定
                const savedSmartAuto = localStorage.getItem('monitorSmartAuto');
                if (savedSmartAuto === 'true') {
                    const smartCheckbox = document.getElementById('monitorSmartAuto');
                    if (smartCheckbox) {
                        smartCheckbox.checked = true;
                        toggleSmartAutoMode();
                    }
                }
                // 更新交易狀態
                updateTradingStatus();
            } catch (e) {
                console.error('載入監控清單失敗:', e);
            }
        }

        // 儲存監控清單
        function saveMonitorList() {
            try {
                localStorage.setItem('monitorStocks', JSON.stringify(monitorStocks.map(s => ({
                    code: s.code,
                    market: s.market,
                    holdPrice: s.holdPrice || 0,
                    shares: s.shares || 1
                }))));
            } catch (e) {
                console.error('儲存監控清單失敗:', e);
            }
        }

        // 更新間隔設定
        function updateMonitorInterval() {
            monitorIntervalSeconds = parseInt(document.getElementById('monitorInterval').value);
            localStorage.setItem('monitorIntervalSeconds', monitorIntervalSeconds);
            
            // 如果自動更新開啟中，重新設定間隔
            if (monitorInterval) {
                stopMonitorAutoRefresh();
                startMonitorAutoRefresh();
                showToast(`⏱️ 更新間隔已改為 ${monitorIntervalSeconds} 秒`);
            }
        }

        // 新增監控股票
        function addMonitorStock() {
            const codeInput = document.getElementById('monitorCode');
            const code = codeInput.value.trim();
            const market = document.getElementById('monitorMarket').value;
            
            if (!code || code.length < 4) {
                showToast('❌ 請輸入有效的股票代碼');
                return;
            }
            
            if (monitorStocks.length >= MAX_MONITOR) {
                showToast(`❌ 最多只能監控 ${MAX_MONITOR} 檔股票`);
                return;
            }
            
            // 檢查是否已存在
            if (monitorStocks.find(s => s.code === code)) {
                showToast('⚠️ 此股票已在監控清單中');
                return;
            }
            
            monitorStocks.push({
                code: code,
                market: market,
                holdPrice: 0,
                shares: 1,
                data: null
            });
            
            saveMonitorList();
            renderMonitorGrid();
            refreshMonitorStock(monitorStocks.length - 1);
            
            codeInput.value = '';
            showToast(`✅ 已新增 ${code} 到監控清單`);
        }

        // 移除監控股票
        function removeMonitorStock(index) {
            const stock = monitorStocks[index];
            monitorStocks.splice(index, 1);
            saveMonitorList();
            renderMonitorGrid();
            showToast(`🗑️ 已移除 ${stock.code}`);
        }

        // 更新持有價
        function updateMonitorHoldPrice(index, value) {
            monitorStocks[index].holdPrice = parseFloat(value) || 0;
            saveMonitorList();
            renderMonitorCard(index);
        }

        // 更新持有張數
        function updateMonitorShares(index, value) {
            monitorStocks[index].shares = parseInt(value) || 1;
            saveMonitorList();
            renderMonitorCard(index);
        }

        // 渲染整個監控網格
        function renderMonitorGrid() {
            const grid = document.getElementById('monitorGrid');
            if (!grid) return;
            
            if (monitorStocks.length === 0) {
                grid.innerHTML = `
                    <div class="monitor-add-card" onclick="document.getElementById('monitorCode').focus()">
                        <div class="add-icon">➕</div>
                        <div>點擊新增監控股票</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // 渲染已有的股票卡片
            monitorStocks.forEach((stock, index) => {
                html += renderMonitorCardHTML(stock, index);
            });
            
            // 添加空白新增卡片（如果還沒達到上限）
            if (monitorStocks.length < MAX_MONITOR) {
                html += `
                    <div class="monitor-add-card" onclick="document.getElementById('monitorCode').focus()">
                        <div class="add-icon">➕</div>
                        <div>新增監控</div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }

        // 渲染單一股票卡片HTML
        function renderMonitorCardHTML(stock, index) {
            const data = stock.data;
            const isUp = data && data.change > 0;
            const isDown = data && data.change < 0;
            const cardClass = isUp ? 'up' : (isDown ? 'down' : 'flat');
            const priceClass = isUp ? 'price-up' : (isDown ? 'price-down' : '');
            
            const price = data ? data.price.toFixed(2) : '---';
            const change = data ? `${isUp ? '▲' : (isDown ? '▼' : '－')}${isUp ? '+' : ''}${data.change.toFixed(2)}` : '---';
            const changePercent = data ? `(${isUp ? '+' : ''}${data.changePercent.toFixed(2)}%)` : '';
            const prevClose = data ? data.prevClose.toFixed(2) : '---';
            const open = data && data.open ? data.open.toFixed(2) : '---';
            const high = data && data.high ? data.high.toFixed(2) : '---';
            const low = data && data.low ? data.low.toFixed(2) : '---';
            const volume = data ? formatVolume(data.volume) : '---';
            const limitUp = data && data.limitUp ? data.limitUp.toFixed(2) : '---';
            const limitDown = data && data.limitDown ? data.limitDown.toFixed(2) : '---';
            const updateTime = data ? data.tradeTime : '--:--';
            const name = data ? data.name : stock.code;
            
            // 計算持有損益
            let profitDisplay = '---';
            let totalProfitDisplay = '---';
            let profitClass = '';
            
            if (data && stock.holdPrice > 0) {
                const profit = data.price - stock.holdPrice;
                const profitPercent = (profit / stock.holdPrice) * 100;
                const totalProfit = profit * (stock.shares || 1) * 1000;
                const isProfit = profit > 0;
                const isLoss = profit < 0;
                profitClass = isProfit ? 'price-up' : (isLoss ? 'price-down' : '');
                const sign = isProfit ? '+' : '';
                profitDisplay = `${sign}${profit.toFixed(2)} (${sign}${profitPercent.toFixed(1)}%)`;
                totalProfitDisplay = Math.abs(totalProfit) >= 10000 
                    ? `${sign}${(totalProfit/10000).toFixed(1)}萬`
                    : `${sign}${totalProfit.toLocaleString()}`;
            }
            
            return `
                <div class="monitor-card ${cardClass}" id="monitorCard${index}">
                    <div class="monitor-card-header">
                        <div class="monitor-stock-info">
                            <span class="monitor-stock-code">${stock.code}</span>
                            <span class="monitor-stock-name">${name}</span>
                            <span class="monitor-market-tag ${stock.market === 'tpex' ? 'tpex' : ''}">${stock.market === 'twse' ? '上市' : '上櫃'}</span>
                        </div>
                        <button class="monitor-remove-btn" onclick="removeMonitorStock(${index})" title="移除">✕</button>
                    </div>
                    <div class="monitor-price-row">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">📊 昨收</div>
                                <div style="font-size: 1.2rem; font-weight: 600; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace;">${prevClose}</div>
                            </div>
                            <div style="color: var(--text-muted); font-size: 1.2rem;">→</div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">⚡ 即時</div>
                                <div class="monitor-current-price ${priceClass}" style="font-size: 1.8rem;">${price}</div>
                            </div>
                        </div>
                        <div class="monitor-price-change ${priceClass}" style="margin-left: auto;">${change} ${changePercent}</div>
                    </div>
                    <div class="monitor-details">
                        <div class="monitor-detail-item">
                            <div>開盤</div>
                            <div class="monitor-detail-value">${open}</div>
                        </div>
                        <div class="monitor-detail-item">
                            <div>最高</div>
                            <div class="monitor-detail-value" style="color: var(--accent-up);">${high}</div>
                        </div>
                        <div class="monitor-detail-item">
                            <div>最低</div>
                            <div class="monitor-detail-value" style="color: var(--accent-down);">${low}</div>
                        </div>
                        <div class="monitor-detail-item">
                            <div>成交量</div>
                            <div class="monitor-detail-value">${volume}</div>
                        </div>
                    </div>
                    <div class="monitor-details" style="border-top: none; padding-top: 0;">
                        <div class="monitor-detail-item">
                            <div>🎯漲停</div>
                            <div class="monitor-detail-value" style="color: var(--accent-up);">${limitUp}</div>
                        </div>
                        <div class="monitor-detail-item">
                            <div>⬇️跌停</div>
                            <div class="monitor-detail-value" style="color: var(--accent-down);">${limitDown}</div>
                        </div>
                    </div>
                    <div class="monitor-holding">
                        <span style="font-size: 0.8rem; color: var(--text-muted);">💰</span>
                        <input type="number" value="${stock.holdPrice || ''}" placeholder="持有價" step="0.01" 
                            onchange="updateMonitorHoldPrice(${index}, this.value)" style="width: 90px;">
                        <span style="font-size: 0.8rem; color: var(--text-muted);">×</span>
                        <input type="number" value="${stock.shares || 1}" placeholder="張" step="1" min="1" style="width: 55px;"
                            onchange="updateMonitorShares(${index}, this.value)">
                        <div class="monitor-profit">
                            <div class="monitor-profit-item">
                                <div class="monitor-profit-label">損益</div>
                                <div class="monitor-profit-value ${profitClass}">${profitDisplay}</div>
                            </div>
                            <div class="monitor-profit-item">
                                <div class="monitor-profit-label">總計</div>
                                <div class="monitor-profit-value ${profitClass}">${totalProfitDisplay}</div>
                            </div>
                        </div>
                    </div>
                    <div class="monitor-update-time">🕐 ${updateTime}</div>
                </div>
            `;
        }

        // 更新單一卡片顯示
        function renderMonitorCard(index) {
            const card = document.getElementById(`monitorCard${index}`);
            if (card && monitorStocks[index]) {
                const newCard = document.createElement('div');
                newCard.innerHTML = renderMonitorCardHTML(monitorStocks[index], index);
                card.replaceWith(newCard.firstElementChild);
            }
        }

        // 刷新單一股票數據
        async function refreshMonitorStock(index) {
            const stock = monitorStocks[index];
            if (!stock) return;
            
            try {
                const data = await fetchRealtimeQuoteDetail(stock.code, stock.market);
                if (data && data.price > 0) {
                    monitorStocks[index].data = data;
                    renderMonitorCard(index);
                }
            } catch (e) {
                console.error(`刷新 ${stock.code} 失敗:`, e);
            }
        }

        // 錯開刷新全部監控股票（避免限流）
        async function refreshAllMonitorStaggered() {
            if (monitorStocks.length === 0) return;
            
            const statusEl = document.getElementById('monitorStatus');
            const statusText = document.getElementById('monitorStatusText');
            
            if (statusEl) statusEl.style.display = 'block';
            
            for (let i = 0; i < monitorStocks.length; i++) {
                if (statusText) {
                    statusText.textContent = `⏳ 更新中... (${i + 1}/${monitorStocks.length}) ${monitorStocks[i].code}`;
                }
                
                await refreshMonitorStock(i);
                
                // 除了最後一檔，每檔之間等待2秒
                if (i < monitorStocks.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, STAGGER_DELAY));
                }
            }
            
            if (statusEl) statusEl.style.display = 'none';
            
            const now = new Date().toLocaleTimeString('zh-TW');
            console.log(`[${now}] 監控更新完成，共 ${monitorStocks.length} 檔`);
        }

        // 自動刷新開關（手動模式）
        function toggleMonitorAutoRefresh() {
            const checked = document.getElementById('monitorAutoRefresh').checked;
            
            if (checked) {
                startMonitorAutoRefresh();
                showToast(`🔄 已開啟監控自動更新（每 ${monitorIntervalSeconds} 秒）`);
            } else {
                stopMonitorAutoRefresh();
                showToast('⏸️ 已關閉監控自動更新');
            }
        }

        // 從主要即時報價添加到監控
        function addCurrentToMonitor() {
            if (currentRealtimeCode) {
                document.getElementById('monitorCode').value = currentRealtimeCode;
                document.getElementById('monitorMarket').value = currentRealtimeMarket;
                addMonitorStock();
            }
        }

        function loadHeatmapData() {
            const sectors = [
                { name: '通信網路', change: 3.16 },
                { name: '生技醫療', change: 3.03 },
                { name: '貿易百貨', change: 2.72 },
                { name: '紡織纖維', change: 2.42 },
                { name: '其他電子', change: 1.75 },
                { name: '資訊服務', change: 1.74 },
                { name: '營建業', change: 1.68 },
                { name: '化學工業', change: 1.57 },
                { name: '食品工業', change: 1.39 },
                { name: '金融保險', change: 1.39 },
                { name: '橡膠工業', change: 1.01 },
                { name: '電腦週邊', change: 0.57 },
                { name: '觀光事業', change: -0.03 },
                { name: '水泥工業', change: -0.23 },
                { name: '航運業', change: -0.27 },
                { name: '鋼鐵工業', change: -0.66 },
                { name: '玻璃陶瓷', change: -0.69 },
                { name: '塑膠工業', change: -1.02 },
                { name: '造紙工業', change: -1.02 },
                { name: '油電燃氣', change: -1.20 },
                { name: '汽車工業', change: -1.38 },
                { name: '光電業', change: -1.49 },
                { name: '半導體', change: -1.77 },
                { name: '電機機械', change: -1.88 },
                { name: '電器電纜', change: -2.01 },
                { name: '電子通路', change: -2.04 },
                { name: '電子零組件', change: -2.37 },
                { name: '其他', change: -2.59 }
            ];

            const grid = document.getElementById('heatmapGrid');
            if (!grid) return;
            
            grid.innerHTML = sectors.map(sector => {
                let heatClass = 'heat-flat';
                if (sector.change > 3) heatClass = 'heat-up-3';
                else if (sector.change > 1) heatClass = 'heat-up-2';
                else if (sector.change > 0) heatClass = 'heat-up-1';
                else if (sector.change < -3) heatClass = 'heat-down-3';
                else if (sector.change < -1) heatClass = 'heat-down-2';
                else if (sector.change < 0) heatClass = 'heat-down-1';

                const sign = sector.change > 0 ? '+' : '';
                return `
                    <div class="heatmap-cell ${heatClass}">
                        <div class="name">${sector.name}</div>
                        <div class="change">${sign}${sector.change.toFixed(2)}%</div>
                    </div>
                `;
            }).join('');
        }

        // ===== ETF 功能 =====
        function loadETFData() {
            const etfs = [
                { code: '0050', name: '元大台灣50', price: 173.05, change: 0.80, percent: 0.46 },
                { code: '0056', name: '元大高股息', price: 38.51, change: 0.28, percent: 0.73 },
                { code: '00878', name: '國泰永續高股息', price: 23.49, change: 0.21, percent: 0.90 },
                { code: '00919', name: '群益台灣精選高息', price: 24.26, change: 0.33, percent: 1.38 },
                { code: '00929', name: '復華台灣科技優息', price: 20.35, change: 0.35, percent: 1.75 },
                { code: '00940', name: '元大台灣價值高息', price: 9.87, change: 0.08, percent: 0.82 },
                { code: '006208', name: '富邦台50', price: 169.00, change: 1.70, percent: 1.02 },
                { code: '00713', name: '元大台灣高息低波', price: 52.10, change: 0.00, percent: 0.00 },
                { code: '00881', name: '國泰台灣5G+', price: 34.52, change: 0.52, percent: 1.53 },
                { code: '00900', name: '富邦特選高股息30', price: 14.59, change: 0.10, percent: 0.69 },
                { code: '00891', name: '中信關鍵半導體', price: 23.97, change: 0.35, percent: 1.48 },
                { code: '00892', name: '富邦台灣半導體', price: 25.50, change: 0.36, percent: 1.43 },
                { code: '0051', name: '元大中型100', price: 105.65, change: 1.20, percent: 1.15 },
                { code: '0052', name: '富邦科技', price: 143.42, change: 0.57, percent: 0.40 },
                { code: '00912', name: '中信臺灣智慧50', price: 23.07, change: 0.20, percent: 0.87 },
                { code: '00915', name: '凱基優選高股息30', price: 24.35, change: 0.23, percent: 0.95 },
                { code: '00918', name: '大華優利高填息30', price: 23.61, change: 0.22, percent: 0.94 },
                { code: '00927', name: '群益半導體收益', price: 26.04, change: 0.58, percent: 2.28 },
                { code: '00934', name: '中信成長高股息', price: 22.80, change: 0.23, percent: 1.02 },
                { code: '00939', name: '統一台灣高息動能', price: 17.65, change: 0.15, percent: 0.86 }
            ];

            const grid = document.getElementById('etfGrid');
            if (!grid) return;
            
            grid.innerHTML = etfs.map(etf => {
                const isUp = etf.change >= 0;
                const sign = isUp ? '+' : '';
                return `
                    <div class="etf-card ${isUp ? 'up' : 'down'}" onclick="analyzeETF('${etf.code}')">
                        <div class="name">${etf.name}</div>
                        <div class="code">${etf.code}</div>
                        <div class="price" style="color: ${isUp ? 'var(--accent-up)' : 'var(--accent-down)'};">${etf.price.toFixed(2)}</div>
                        <div class="change" style="color: ${isUp ? 'var(--accent-up)' : 'var(--accent-down)'};">
                            ${isUp ? '▲' : '▼'} ${sign}${etf.change.toFixed(2)} (${sign}${etf.percent.toFixed(2)}%)
                        </div>
                    </div>
                `;
            }).join('');
        }

        function analyzeETF(code) {
            document.getElementById('stockCode').value = code;
            startAnalysis();
        }

        // ===== 排行榜功能 =====
        let currentRankingType = 'gainers';
        
        // 摺疊/展開排行榜
        function toggleRankingSection() {
            const section = document.getElementById('rankingSection');
            section.classList.toggle('collapsed');
            
            // 保存狀態到 localStorage
            const isCollapsed = section.classList.contains('collapsed');
            localStorage.setItem('ranking_collapsed', isCollapsed ? 'true' : 'false');
        }
        
        // 初始化時讀取摺疊狀態
        function initRankingState() {
            const isCollapsed = localStorage.getItem('ranking_collapsed') === 'true';
            if (isCollapsed) {
                document.getElementById('rankingSection').classList.add('collapsed');
            }
        }
        
        function switchRankingType(type) {
            currentRankingType = type;
            document.querySelectorAll('.ranking-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.ranking-tab-btn[data-type="${type}"]`).classList.add('active');
            
            const headerMap = {
                'gainers': '成交量(張)',
                'losers': '成交量(張)',
                'volume': '成交量(張)',
                'value': '成交值(億)'
            };
            document.getElementById('rankingValueHeader').textContent = headerMap[type];
            document.getElementById('rankingTableContainer').style.display = 'none';
        }

        async function fetchRankingData() {
            const market = document.getElementById('rankingMarket').value;
            const loading = document.getElementById('rankingLoading');
            const tableContainer = document.getElementById('rankingTableContainer');
            const updateTime = document.getElementById('rankingUpdateTime');
            
            loading.style.display = 'flex';
            tableContainer.style.display = 'none';
            updateTime.textContent = '⏳ 正在載入排行榜...';
            
            try {
                let data = [];
                
                if (market === 'tse') {
                    data = await fetchTWSERanking(currentRankingType);
                } else {
                    data = await fetchTPExRanking(currentRankingType);
                }
                
                console.log('Ranking result:', data);
                
                if (data.length > 0) {
                    renderRankingTable(data);
                    tableContainer.style.display = 'block';
                    const now = new Date();
                    updateTime.textContent = '📅 更新時間: ' + now.toLocaleString('zh-TW');
                } else {
                    updateTime.textContent = '❌ 無法取得排行榜資料，請稍後再試';
                }
            } catch (error) {
                console.error('排行榜載入失敗:', error);
                updateTime.textContent = '❌ 載入失敗: ' + error.message;
            } finally {
                loading.style.display = 'none';
            }
        }

        // 從證交所獲取上市排行榜
        async function fetchTWSERanking(type) {
            const datesToTry = getRecentTradeDates(5);
            
            for (const dateStr of datesToTry) {
                try {
                    console.log('Trying TWSE date:', dateStr);
                    
                    // 統一使用 MI_INDEX 全市場資料，自行排序
                    const url = 'https://www.twse.com.tw/rwd/zh/afterTrading/MI_INDEX?date=' + dateStr + '&type=ALLBUT0999&response=json';
                    const data = await fetchWithProxy(url);
                    
                    if (data && data.stat === 'OK' && data.tables) {
                        const result = parseTWSEAllData(data, type);
                        if (result.length > 0) {
                            console.log('Found TWSE data for', dateStr, 'type:', type);
                            return result;
                        }
                    }
                } catch (e) {
                    console.log('TWSE fetch error for', dateStr, e.message);
                }
            }
            return [];
        }
        
        function getRecentTradeDates(days) {
            const dates = [];
            let d = new Date();
            while (dates.length < days) {
                const dow = d.getDay();
                if (dow !== 0 && dow !== 6) {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    dates.push(y + m + day);
                }
                d.setDate(d.getDate() - 1);
            }
            return dates;
        }
        
        function parseTWSEAllData(data, type) {
            let stocks = [];
            const pn = (v) => {
                if (!v || v === '--') return 0;
                return parseFloat(String(v).replace(/,/g, '').replace(/−/g, '-').replace(/[+]/g, '')) || 0;
            };
            
            if (data.tables) {
                // MI_INDEX 格式: 通常在 tables[8] 或其他位置有個股資料
                // 欄位: 證券代號, 證券名稱, 成交股數, 成交筆數, 成交金額, 開盤價, 最高價, 最低價, 收盤價, 漲跌(+/-), 漲跌價差, 最後揭示買價, ...
                data.tables.forEach(t => {
                    if (t.data && t.fields && t.fields.length >= 10) {
                        t.data.forEach(row => {
                            const code = String(row[0] || '').trim();
                            if (/^\d{4}$/.test(code)) {
                                const vol = pn(row[2]);      // 成交股數
                                const val = pn(row[4]);      // 成交金額
                                const close = pn(row[8]);    // 收盤價
                                const changeSign = String(row[9] || '').trim(); // +/- 符號
                                let change = pn(row[10]);    // 漲跌價差
                                
                                // 處理漲跌符號
                                if (changeSign === '-' || changeSign.includes('-')) {
                                    change = -Math.abs(change);
                                } else if (changeSign === '+' || changeSign.includes('+')) {
                                    change = Math.abs(change);
                                }
                                
                                const prevClose = close - change;
                                const pct = prevClose > 0 ? (change / prevClose) * 100 : 0;
                                
                                if (close > 0) {
                                    stocks.push({
                                        code: code,
                                        name: String(row[1] || '').trim(),
                                        price: close,
                                        change: change,
                                        changePercent: pct,
                                        volume: vol,
                                        value: val
                                    });
                                }
                            }
                        });
                    }
                });
            }
            
            // 根據類型排序
            if (type === 'gainers') {
                stocks.sort((a, b) => b.changePercent - a.changePercent);
            } else if (type === 'losers') {
                stocks.sort((a, b) => a.changePercent - b.changePercent);
            } else if (type === 'volume') {
                stocks.sort((a, b) => b.volume - a.volume);
            } else {
                stocks.sort((a, b) => b.value - a.value);
            }
            
            return stocks.slice(0, 20).map((s, i) => ({
                rank: i + 1,
                code: s.code,
                name: s.name,
                price: s.price.toFixed(2),
                change: s.change,
                changePercent: s.changePercent,
                value: type === 'volume' 
                    ? (s.volume / 1000).toLocaleString() + ' 張'
                    : type === 'value'
                    ? (s.value / 100000000).toFixed(2) + ' 億'
                    : (s.volume / 1000).toLocaleString() + ' 張'
            }));
        }

        // 從櫃買中心獲取上櫃排行榜  
        async function fetchTPExRanking(type) {
            const datesToTry = getRecentROCDates(5);
            
            for (const dateStr of datesToTry) {
                try {
                    console.log('Trying TPEx date:', dateStr);
                    const url = 'https://www.tpex.org.tw/web/stock/aftertrading/otc_quotes_no1430/stk_wn1430_result.php?l=zh-tw&o=json&d=' + dateStr + '&se=EW';
                    const data = await fetchWithProxy(url);
                    
                    if (data && data.aaData && data.aaData.length > 0) {
                        console.log('Found TPEx data for', dateStr);
                        return parseTPExData(data.aaData, type);
                    }
                } catch (e) {
                    console.log('TPEx fetch error for', dateStr, e.message);
                }
            }
            return [];
        }
        
        function getRecentROCDates(days) {
            const dates = [];
            let d = new Date();
            while (dates.length < days) {
                const dow = d.getDay();
                if (dow !== 0 && dow !== 6) {
                    const y = d.getFullYear() - 1911;
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    dates.push(y + '/' + m + '/' + day);
                }
                d.setDate(d.getDate() - 1);
            }
            return dates;
        }
        
        function parseTPExData(aaData, type) {
            const pn = (v) => {
                if (v == null || v === '--') return 0;
                return parseFloat(String(v).replace(/,/g, '').replace(/−/g, '-')) || 0;
            };
            
            let stocks = aaData.map(row => {
                const code = String(row[0] || '').trim();
                const name = String(row[1] || '').trim();
                const price = pn(row[2]);
                const change = pn(row[3]);
                const vol = pn(row[8]);
                const val = pn(row[9]);
                const prevP = price - change;
                const pct = prevP > 0 ? (change / prevP) * 100 : 0;
                return { code, name, price, change, changePercent: pct, volume: vol, value: val };
            }).filter(s => /^\d{4}$/.test(s.code) && s.price > 0);
            
            if (type === 'gainers') stocks.sort((a, b) => b.changePercent - a.changePercent);
            else if (type === 'losers') stocks.sort((a, b) => a.changePercent - b.changePercent);
            else if (type === 'volume') stocks.sort((a, b) => b.volume - a.volume);
            else stocks.sort((a, b) => b.value - a.value);
            
            return stocks.slice(0, 20).map((s, i) => ({
                rank: i + 1,
                code: s.code,
                name: s.name,
                price: s.price.toFixed(2),
                change: s.change,
                changePercent: s.changePercent,
                value: type === 'volume' ? (s.volume / 1000).toLocaleString() + ' 張' : (s.value / 100000000).toFixed(2) + ' 億'
            }));
        }

        function renderRankingTable(data) {
            const tbody = document.getElementById('rankingBody');
            tbody.innerHTML = '';
            
            data.forEach((item, index) => {
                const isUp = item.change > 0;
                const isDown = item.change < 0;
                const colorClass = isUp ? 'color: var(--accent-up);' : (isDown ? 'color: var(--accent-down);' : '');
                const changeSymbol = isUp ? '+' : '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color);">
                        <span class="ranking-rank ${index < 3 ? 'top3' : 'normal'}">${item.rank}</span>
                    </td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); font-weight: 600; color: var(--accent-cyan);">${item.code}</td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); font-family: 'Noto Sans TC', sans-serif;">${item.name}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); font-weight: 600;">${item.price}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); ${colorClass} font-weight: 600;">${changeSymbol}${typeof item.change === 'number' ? item.change.toFixed(2) : item.change}</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color); ${colorClass} font-weight: 600;">${changeSymbol}${typeof item.changePercent === 'number' ? item.changePercent.toFixed(2) : item.changePercent}%</td>
                    <td style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-color);">${item.value}</td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color);">
                        <button onclick="loadStockFromRanking('${item.code}')" style="background: var(--accent-blue); border: none; border-radius: 6px; padding: 6px 12px; color: white; cursor: pointer; font-size: 0.85rem;">📊 分析</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadStockFromRanking(code) {
            document.getElementById('stockCode').value = code;
            // 檢測是上市還是上櫃（根據當前排行榜選擇）
            const market = document.getElementById('rankingMarket').value === 'tse' ? 'twse' : 'tpex';
            selectMarket(market);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            startAnalysis();
        }

        // ===== 波浪理論分析 =====
        function analyzeElliottWave() {
            console.log('analyzeElliottWave called, stockData length:', stockData.length);
            
            if (stockData.length < 30) {
                document.getElementById('elliottAnalysis').innerHTML = '<p style="color: var(--accent-yellow);">⚠️ 請載入至少 30 筆交易日資料以進行波浪分析。</p>';
                document.getElementById('currentWavePosition').textContent = '數據不足';
                document.getElementById('currentWaveDesc').textContent = '請選擇更長的分析期間';
                document.getElementById('wavePrediction').innerHTML = '<p style="color: var(--text-secondary);">需要更多數據才能進行波浪預測。</p>';
                return;
            }
            
            try {
                const waveAnalysis = detectElliottWaves(stockData);
                console.log('Wave analysis result:', waveAnalysis);
                renderElliottWaveDisplay(waveAnalysis);
                setTimeout(() => { drawElliottChart(waveAnalysis); }, 100);
                calculateFibonacciLevels(waveAnalysis);
            } catch (error) {
                console.error('Elliott Wave analysis error:', error);
                document.getElementById('elliottAnalysis').innerHTML = `<p style="color: var(--accent-yellow);">⚠️ 波浪分析發生錯誤: ${error.message}</p>`;
            }
        }
        
        function detectElliottWaves(data) {
            const currentPrice = parseFloat(data[data.length - 1].close);
            const recentData = data.slice(-120);
            
            // ===== 第一步：找出所有轉折點 =====
            const pivots = [];
            const windowSize = Math.max(2, Math.min(5, Math.floor(recentData.length / 25)));
            
            for (let i = windowSize; i < recentData.length - windowSize; i++) {
                const closePrice = parseFloat(recentData[i].close);
                const windowData = recentData.slice(i - windowSize, i + windowSize + 1);
                const maxClose = Math.max(...windowData.map(d => parseFloat(d.close)));
                const minClose = Math.min(...windowData.map(d => parseFloat(d.close)));
                
                if (closePrice >= maxClose && !pivots.some(p => Math.abs(p.index - i) < windowSize && p.type === 'high')) {
                    pivots.push({ index: i, price: closePrice, type: 'high', date: recentData[i].date });
                }
                if (closePrice <= minClose && !pivots.some(p => Math.abs(p.index - i) < windowSize && p.type === 'low')) {
                    pivots.push({ index: i, price: closePrice, type: 'low', date: recentData[i].date });
                }
            }
            
            // 檢查最新數據是否為近期高低點
            const lastIdx = recentData.length - 1;
            const lastClose = parseFloat(recentData[lastIdx].close);
            const last10 = recentData.slice(-10);
            const max10 = Math.max(...last10.map(d => parseFloat(d.close)));
            const min10 = Math.min(...last10.map(d => parseFloat(d.close)));
            
            if (lastClose >= max10 && !pivots.some(p => p.index >= lastIdx - 2 && p.type === 'high')) {
                pivots.push({ index: lastIdx, price: lastClose, type: 'high', date: recentData[lastIdx].date });
            }
            if (lastClose <= min10 && !pivots.some(p => p.index >= lastIdx - 2 && p.type === 'low')) {
                pivots.push({ index: lastIdx, price: lastClose, type: 'low', date: recentData[lastIdx].date });
            }
            
            pivots.sort((a, b) => a.index - b.index);
            
            // ===== 第二步：合併同類型轉折點 =====
            const mergedPivots = [];
            for (const pivot of pivots) {
                if (mergedPivots.length === 0) {
                    mergedPivots.push(pivot);
                } else {
                    const last = mergedPivots[mergedPivots.length - 1];
                    if (pivot.type === last.type) {
                        if ((pivot.type === 'high' && pivot.price > last.price) ||
                            (pivot.type === 'low' && pivot.price < last.price)) {
                            mergedPivots[mergedPivots.length - 1] = pivot;
                        }
                    } else {
                        mergedPivots.push(pivot);
                    }
                }
            }
            
            // ===== 第三步：過濾小波動（1.5%）=====
            const avgPrice = recentData.reduce((s, d) => s + parseFloat(d.close), 0) / recentData.length;
            const minSwing = avgPrice * 0.015;
            
            const significantPivots = [];
            for (const pivot of mergedPivots) {
                if (significantPivots.length === 0) {
                    significantPivots.push(pivot);
                } else {
                    const last = significantPivots[significantPivots.length - 1];
                    if (Math.abs(pivot.price - last.price) >= minSwing) {
                        significantPivots.push(pivot);
                    }
                }
            }
            
            // ===== 第四步：確保高低點交替 =====
            const alternatingPivots = [];
            for (const pivot of significantPivots) {
                if (alternatingPivots.length === 0) {
                    alternatingPivots.push(pivot);
                } else {
                    const last = alternatingPivots[alternatingPivots.length - 1];
                    if (pivot.type !== last.type) {
                        alternatingPivots.push(pivot);
                    } else {
                        if ((pivot.type === 'high' && pivot.price > last.price) ||
                            (pivot.type === 'low' && pivot.price < last.price)) {
                            alternatingPivots[alternatingPivots.length - 1] = pivot;
                        }
                    }
                }
            }
            
            console.log('Pivots found:', alternatingPivots.length, alternatingPivots.map(p => `${p.type}@${p.price.toFixed(2)}`).join('→'));
            
            // ===== 第五步：建構波浪 =====
            const waves = [];
            const recentPivots = alternatingPivots.slice(-9);
            
            for (let i = 1; i < recentPivots.length; i++) {
                const prev = recentPivots[i - 1];
                const curr = recentPivots[i];
                waves.push({
                    start: prev.price,
                    end: curr.price,
                    startDate: prev.date,
                    endDate: curr.date,
                    type: curr.price > prev.price ? 'up' : 'down'
                });
            }
            
            console.log('Waves built:', waves.length, waves.map(w => `${w.type}(${w.start.toFixed(2)}→${w.end.toFixed(2)})`).join(' | '));
            
            // ===== 第六步：標記波浪（艾略特標準序列）=====
            // 1(↑) → 2(↓) → 3(↑) → 4(↓) → 5(↑) → A(↓) → B(↑) → C(↓)
            const waveSequence = [
                { label: 1, dir: 'up', impulse: true },
                { label: 2, dir: 'down', impulse: false },
                { label: 3, dir: 'up', impulse: true },
                { label: 4, dir: 'down', impulse: false },
                { label: 5, dir: 'up', impulse: true },
                { label: 'A', dir: 'down', impulse: false },
                { label: 'B', dir: 'up', impulse: false },
                { label: 'C', dir: 'down', impulse: false }
            ];
            
            const labeledWaves = [];
            if (waves.length > 0) {
                // 第一個波浪是上漲→從1開始，下跌→從2開始
                let seqIdx = waves[0].type === 'up' ? 0 : 1;
                
                for (let i = 0; i < waves.length && i < 8; i++) {
                    const w = waves[i];
                    const seq = waveSequence[seqIdx % 8];
                    labeledWaves.push({
                        number: seq.label,
                        start: w.start,
                        end: w.end,
                        startDate: w.startDate,
                        endDate: w.endDate,
                        type: w.type,
                        isImpulse: seq.impulse
                    });
                    seqIdx++;
                }
            }
            
            console.log('Labeled waves:', labeledWaves.map(w => `Wave${w.number}(${w.type})`).join('→'));
            
            // ===== 第七步：判斷當前波浪位置 =====
            let currentWave = '?';
            
            if (labeledWaves.length > 0) {
                const lastWave = labeledWaves[labeledWaves.length - 1];
                const lastLabel = lastWave.number;
                const lastEnd = lastWave.end;
                const lastStart = lastWave.start;
                const priceChange = (currentPrice - lastEnd) / lastEnd;
                const pricePos = currentPrice > lastEnd ? 'above' : 'below';
                
                console.log(`Last wave: ${lastLabel}, end: ${lastEnd.toFixed(2)}, current: ${currentPrice.toFixed(2)}, change: ${(priceChange*100).toFixed(2)}%, pos: ${pricePos}`);
                
                // 根據艾略特波浪理論判斷當前位置
                if (typeof lastLabel === 'number') {
                    switch(lastLabel) {
                        case 1: // 第1浪結束（上漲結束）
                            // 浪2不可能完全回撤浪1
                            if (priceChange < -0.02) {
                                currentWave = 2; // 進入第2浪修正
                            } else if (priceChange > 0.03) {
                                currentWave = 1; // 還在第1浪延續
                            } else {
                                currentWave = pricePos === 'below' ? 2 : 1;
                            }
                            break;
                        case 2: // 第2浪結束（下跌結束）
                            if (priceChange > 0.02) {
                                currentWave = 3; // 進入第3浪（通常最強）
                            } else if (priceChange < -0.03) {
                                currentWave = 2; // 還在第2浪
                            } else {
                                currentWave = pricePos === 'above' ? 3 : 2;
                            }
                            break;
                        case 3: // 第3浪結束（上漲結束，通常最強最長）
                            if (priceChange < -0.02) {
                                currentWave = 4; // 進入第4浪修正
                            } else if (priceChange > 0.03) {
                                currentWave = 3; // 還在第3浪
                            } else {
                                currentWave = pricePos === 'below' ? 4 : 3;
                            }
                            break;
                        case 4: // 第4浪結束（下跌結束）
                            // 浪4的低點不能與浪1頂點重疊
                            if (priceChange > 0.02) {
                                currentWave = 5; // 進入第5浪
                            } else if (priceChange < -0.03) {
                                currentWave = 4; // 還在第4浪
                            } else {
                                currentWave = pricePos === 'above' ? 5 : 4;
                            }
                            break;
                        case 5: // 第5浪結束（上漲結束，市場狂熱）
                            if (priceChange < -0.03) {
                                currentWave = 'A'; // 開始ABC修正
                            } else if (priceChange > 0.05) {
                                currentWave = 1; // 新循環開始
                            } else {
                                currentWave = 5; // 還在第5浪
                            }
                            break;
                    }
                } else {
                    // ABC 修正浪
                    switch(lastLabel) {
                        case 'A': // A浪結束（下跌結束）
                            if (priceChange > 0.02) {
                                currentWave = 'B'; // 反彈進入B浪
                            } else {
                                currentWave = 'A';
                            }
                            break;
                        case 'B': // B浪結束（反彈結束，多頭陷阱）
                            if (priceChange > 0.08) {
                                currentWave = 1; // 新循環開始
                            } else if (priceChange < -0.02) {
                                currentWave = 'C'; // 進入C浪下跌
                            } else if (priceChange > 0.03) {
                                currentWave = 1; // 可能新循環
                            } else {
                                currentWave = pricePos === 'below' ? 'C' : 'B';
                            }
                            break;
                        case 'C': // C浪結束（下跌結束，破壞力強）
                            if (priceChange > 0.03) {
                                currentWave = 1; // 新循環開始
                            } else if (priceChange < -0.02) {
                                currentWave = 'C'; // 還在C浪
                            } else {
                                currentWave = pricePos === 'above' ? 1 : 'C';
                            }
                            break;
                    }
                }
                
                console.log('Determined current wave:', currentWave);
            }
            
            // ===== 第八步：判斷趨勢 =====
            let trend = '盤整';
            if (recentData.length >= 20) {
                const startPrice = parseFloat(recentData[recentData.length - 20].close);
                const change = (currentPrice - startPrice) / startPrice;
                if (change > 0.05) trend = '上升趨勢';
                else if (change < -0.05) trend = '下降趨勢';
            }
            
            // ===== 第九步：波浪規則檢查 =====
            const rules = [];
            const w1 = labeledWaves.find(w => w.number === 1);
            const w2 = labeledWaves.find(w => w.number === 2);
            const w3 = labeledWaves.find(w => w.number === 3);
            const w4 = labeledWaves.find(w => w.number === 4);
            const w5 = labeledWaves.find(w => w.number === 5);
            
            // 規則1: 浪2不可能完全回撤浪1
            if (w1 && w2) {
                const w1Start = Math.min(w1.start, w1.end);
                const w2End = Math.min(w2.start, w2.end);
                rules.push({
                    rule: '浪2不可能完全回撤浪1',
                    valid: w2End >= w1Start * 0.99
                });
            }
            
            // 規則2: 浪3不可能是驅動浪中最短一浪
            if (w1 && w3) {
                const w1Len = Math.abs(w1.end - w1.start);
                const w3Len = Math.abs(w3.end - w3.start);
                const w5Len = w5 ? Math.abs(w5.end - w5.start) : Infinity;
                const isW3Shortest = w3Len < w1Len && w3Len < w5Len;
                rules.push({
                    rule: '浪3不可能是最短推動浪',
                    valid: !isW3Shortest
                });
            }
            
            // 規則3: 浪4的低點不能與浪1頂點重疊
            if (w1 && w4) {
                const w1Top = Math.max(w1.start, w1.end);
                const w4Low = Math.min(w4.start, w4.end);
                rules.push({
                    rule: '浪4低點不能與浪1頂點重疊',
                    valid: w4Low >= w1Top * 0.99
                });
            }
            
            // 計算價格變動
            let lastWaveEnd = null;
            let priceChangePercent = null;
            if (labeledWaves.length > 0) {
                lastWaveEnd = labeledWaves[labeledWaves.length - 1].end;
                priceChangePercent = ((currentPrice - lastWaveEnd) / lastWaveEnd * 100).toFixed(2);
            }
            
            // 最近5天數據
            const recentDays = data.slice(-5).map(d => ({
                date: d.date,
                open: parseFloat(d.open || d.close),
                high: parseFloat(d.high || d.close),
                low: parseFloat(d.low || d.close),
                close: parseFloat(d.close)
            }));
            
            return {
                waves: labeledWaves,
                currentWave,
                currentPrice,
                lastWaveEnd,
                priceChangePercent,
                rules,
                trend,
                pivots: alternatingPivots.slice(-10),
                recentDays,
                prices: recentData.map(d => parseFloat(d.close))
            };
        }
        
        function renderElliottWaveDisplay(analysis) {
            const displayWave = analysis.currentWave || '?';
            
            // 更新波浪位置
            const wavePos = document.getElementById('currentWavePosition');
            wavePos.textContent = `第 ${displayWave} 浪`;
            
            // 根據波浪類型設定顏色
            if (typeof displayWave === 'number' && displayWave % 2 === 1) {
                wavePos.style.color = 'var(--accent-up)'; // 推動浪 1, 3, 5
            } else if (typeof displayWave === 'number') {
                wavePos.style.color = 'var(--accent-cyan)'; // 修正浪 2, 4
            } else if (displayWave === 'B') {
                wavePos.style.color = 'var(--accent-yellow)'; // B浪反彈
            } else {
                wavePos.style.color = 'var(--accent-down)'; // A, C 浪
            }
            
            // 價格變動描述
            let priceChangeDesc = '';
            if (analysis.lastWaveEnd && analysis.priceChangePercent) {
                const change = parseFloat(analysis.priceChangePercent);
                if (change > 0) {
                    priceChangeDesc = `<span style="color: var(--accent-up);">↑${analysis.priceChangePercent}%</span> 自上浪`;
                } else if (change < 0) {
                    priceChangeDesc = `<span style="color: var(--accent-down);">↓${Math.abs(change).toFixed(2)}%</span> 自上浪`;
                }
            }
            
            document.getElementById('currentWaveDesc').innerHTML = `${analysis.trend} | 現價: ${analysis.currentPrice?.toFixed(2) || '--'} ${priceChangeDesc}`;
            
            // 更新趨勢
            const trendEl = document.getElementById('elliottTrend');
            if (analysis.trend === '上升趨勢') {
                trendEl.innerHTML = `<span style="color: var(--accent-up);">📈 ${analysis.trend}</span>`;
            } else if (analysis.trend === '下降趨勢') {
                trendEl.innerHTML = `<span style="color: var(--accent-down);">📉 ${analysis.trend}</span>`;
            } else {
                trendEl.innerHTML = `<span style="color: var(--accent-yellow);">➡️ ${analysis.trend}</span>`;
            }
            
            // 更新費波納契位置（基於當前波浪）
            document.getElementById('elliottStrength').textContent = `${analysis.waves.length} 個波浪`;
            
            // 更新分析內容
            document.getElementById('elliottAnalysis').innerHTML = generateWaveAnalysisHTML(analysis);
            
            // 更新預測
            document.getElementById('wavePrediction').innerHTML = getWaveAdvice(analysis.currentWave, analysis.trend);
        }
        
        function generateWaveAnalysisHTML(analysis) {
            let html = '';
            
            // 波浪計數視覺化
            html += `<div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">`;
            [1, 2, 3, 4, 5].forEach(n => {
                const isCurrent = analysis.currentWave === n;
                const bgColor = isCurrent ? 'var(--accent-up)' : 'var(--bg-hover)';
                const textColor = isCurrent ? 'white' : 'var(--text-secondary)';
                html += `<div style="width: 36px; height: 36px; border-radius: 50%; background: ${bgColor}; color: ${textColor}; display: flex; align-items: center; justify-content: center; font-weight: 600;">${n}</div>`;
            });
            ['A', 'B', 'C'].forEach(n => {
                const isCurrent = analysis.currentWave === n;
                const bgColor = isCurrent ? 'var(--accent-down)' : 'var(--bg-hover)';
                const textColor = isCurrent ? 'white' : 'var(--text-secondary)';
                html += `<div style="width: 36px; height: 36px; border-radius: 50%; background: ${bgColor}; color: ${textColor}; display: flex; align-items: center; justify-content: center; font-weight: 600;">${n}</div>`;
            });
            html += `</div>`;
            
            // 波浪規則檢查
            html += `<div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin-bottom: 15px;">`;
            html += `<h4 style="margin: 0 0 10px 0; font-size: 0.95rem;">📋 波浪規則檢查</h4>`;
            if (analysis.rules.length > 0) {
                analysis.rules.forEach(r => {
                    const icon = r.valid ? '✅' : '❌';
                    const color = r.valid ? 'var(--accent-up)' : 'var(--accent-down)';
                    html += `<div style="padding: 5px 0; color: ${color};">${icon} ${r.rule}</div>`;
                });
            } else {
                html += `<p style="color: var(--text-muted);">資料不足，無法完整驗證波浪規則</p>`;
            }
            html += `</div>`;
            
            // 近期波浪
            html += `<div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px; margin-bottom: 15px;">`;
            html += `<h4 style="margin: 0 0 10px 0; font-size: 0.95rem;">📊 近期波浪</h4>`;
            if (analysis.waves.length > 0) {
                analysis.waves.slice(-5).forEach((w, i, arr) => {
                    const isLastWave = i === arr.length - 1;
                    const bgStyle = isLastWave ? 'background: var(--bg-hover); margin: 0 -8px; padding: 8px; border-radius: 6px;' : '';
                    const color = w.type === 'up' ? 'var(--accent-up)' : 'var(--accent-down)';
                    const arrow = w.type === 'up' ? '↑' : '↓';
                    html += `<div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color); ${bgStyle}">
                        <span>第 ${w.number} 浪 (${w.isImpulse ? '推動' : '修正'})${isLastWave ? ' ← 最近' : ''}</span>
                        <span style="color: ${color}; font-family: 'JetBrains Mono', monospace;">
                            ${w.start.toFixed(2)} → ${w.end.toFixed(2)} ${arrow}
                        </span>
                    </div>`;
                });
                
                // 現價位
                if (analysis.lastWaveEnd) {
                    const changeColor = parseFloat(analysis.priceChangePercent) >= 0 ? 'var(--accent-up)' : 'var(--accent-down)';
                    const sign = parseFloat(analysis.priceChangePercent) >= 0 ? '+' : '';
                    html += `<div style="display: flex; justify-content: space-between; padding: 8px 0; margin-top: 5px; border-top: 2px dashed var(--border-color);">
                        <span style="color: var(--accent-blue); font-weight: 600;">📍 現價位</span>
                        <span style="font-family: 'JetBrains Mono', monospace;">
                            ${analysis.lastWaveEnd.toFixed(2)} → <span style="color: var(--accent-blue); font-weight: 600;">${analysis.currentPrice.toFixed(2)}</span>
                            <span style="color: ${changeColor}; margin-left: 5px;">(${sign}${analysis.priceChangePercent}%)</span>
                        </span>
                    </div>`;
                }
            } else {
                html += `<p style="color: var(--text-muted);">波動不足，無法識別明確波浪</p>`;
            }
            html += `</div>`;
            
            // 最近交易日數據
            if (analysis.recentDays && analysis.recentDays.length > 0) {
                html += `<div style="background: var(--bg-secondary); border-radius: 10px; padding: 15px;">`;
                html += `<h4 style="margin: 0 0 10px 0; font-size: 0.95rem;">📅 最近交易日數據</h4>`;
                html += `<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">`;
                html += `<thead><tr style="background: var(--bg-hover);">
                    <th style="padding: 8px; text-align: left;">日期</th>
                    <th style="padding: 8px; text-align: right;">開盤</th>
                    <th style="padding: 8px; text-align: right;">最高</th>
                    <th style="padding: 8px; text-align: right;">最低</th>
                    <th style="padding: 8px; text-align: right;">收盤</th>
                </tr></thead><tbody>`;
                analysis.recentDays.slice().reverse().forEach(d => {
                    const closeColor = d.close >= d.open ? 'var(--accent-up)' : 'var(--accent-down)';
                    html += `<tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 6px 8px;">${d.date}</td>
                        <td style="padding: 6px 8px; text-align: right; font-family: 'JetBrains Mono', monospace;">${d.open.toFixed(2)}</td>
                        <td style="padding: 6px 8px; text-align: right; font-family: 'JetBrains Mono', monospace;">${d.high.toFixed(2)}</td>
                        <td style="padding: 6px 8px; text-align: right; font-family: 'JetBrains Mono', monospace;">${d.low.toFixed(2)}</td>
                        <td style="padding: 6px 8px; text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 600; color: ${closeColor};">${d.close.toFixed(2)}</td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
            }
            
            // 提示
            html += `<div style="margin-top: 15px; padding: 10px 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                💡 波浪分析基於<strong>收盤價</strong>識別轉折點。波浪理論為主觀分析工具，建議搭配其他指標綜合判斷。
            </div>`;
            
            return html;
        }
        
        function getWaveAdvice(wave, trend) {
            const advices = {
                1: `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-up); font-weight: 600; margin-bottom: 10px;">🚀 第1浪 - 新趨勢起點</p>
                    <p>第1浪為新趨勢的起點，通常是築底反彈階段。此時市場半信半疑，成交量可能不大。</p>
                    <p><strong>💡 建議：</strong>可小量試單，設好停損，等待突破確認。</p>
                </div>`,
                2: `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-cyan); font-weight: 600; margin-bottom: 10px;">⏸️ 第2浪 - 回調整理</p>
                    <p>第2浪為回調整理階段，通常回撤第1浪的 38.2%-61.8%。不會跌破第1浪起點。</p>
                    <p><strong>💡 建議：</strong>等待回調到支撐位後進場，是較好的買點。</p>
                </div>`,
                3: `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-up); font-weight: 600; margin-bottom: 10px;">🔥 第3浪 - 主升段</p>
                    <p>第3浪通常是最強勁的上漲波段，成交量放大，市場信心增強。絕對不會是最短的推動浪。</p>
                    <p><strong>💡 建議：</strong>可積極做多，持股續抱，但注意不要追高。</p>
                </div>`,
                4: `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-cyan); font-weight: 600; margin-bottom: 10px;">⏸️ 第4浪 - 整理期</p>
                    <p>第4浪為整理期，通常回撤第3浪的 38.2%。不會與第1浪價格區間重疊。</p>
                    <p><strong>💡 建議：</strong>逢低布局，等待第5浪的到來。</p>
                </div>`,
                5: `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-yellow); font-weight: 600; margin-bottom: 10px;">⚠️ 第5浪 - 末升段</p>
                    <p>第5浪可能是最後一波上漲，漲幅通常小於第3浪。可能出現量價背離。</p>
                    <p><strong>💡 建議：</strong>需警惕反轉風險，考慮逐步獲利了結。</p>
                </div>`,
                'A': `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-down); font-weight: 600; margin-bottom: 10px;">📉 A浪 - 修正開始</p>
                    <p>A浪修正開始，多數人認為只是回檔，但實際上趨勢可能已經反轉。</p>
                    <p><strong>💡 建議：</strong>減碼或觀望，不宜搶反彈。</p>
                </div>`,
                'B': `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-yellow); font-weight: 600; margin-bottom: 10px;">🔄 B浪 - 反彈陷阱</p>
                    <p>B浪反彈通常是陷阱，容易讓人誤以為跌勢結束。成交量通常較A浪小。</p>
                    <p><strong>💡 建議：</strong>不宜追高，可考慮逢高減碼。</p>
                </div>`,
                'C': `<div style="line-height: 1.8;">
                    <p style="color: var(--accent-down); font-weight: 600; margin-bottom: 10px;">💡 C浪 - 修正末端</p>
                    <p>C浪修正末端，跌勢可能即將結束。市場悲觀情緒達到高峰。</p>
                    <p><strong>💡 建議：</strong>可開始留意反彈買點，為新循環做準備。</p>
                </div>`
            };
            
            return advices[wave] || `<div style="line-height: 1.8;">
                <p style="color: var(--text-secondary);">目前波浪位置需持續觀察確認。</p>
                <p><strong>趨勢判斷：</strong>${trend}</p>
                <p><strong>💡 建議：</strong>等待更明確的訊號出現，結合其他技術指標綜合判斷。</p>
            </div>`;
        }

        function drawElliottChart(analysis) {
            const ctx = document.getElementById('elliottChart').getContext('2d');
            
            if (charts.elliottChart) {
                charts.elliottChart.destroy();
            }
            
            // 使用最近 60 天的數據
            const recentData = stockData.slice(-60);
            const labels = recentData.map(d => d.date.substring(5));
            const prices = recentData.map(d => parseFloat(d.close));
            const fullDates = recentData.map(d => d.date); // 保留完整日期用於匹配
            
            // 標記轉折點和波浪標號
            const pivotHighs = new Array(prices.length).fill(null);
            const pivotLows = new Array(prices.length).fill(null);
            const waveLabels = new Array(prices.length).fill(null); // 儲存波浪標號
            
            console.log('=== 繪製波浪圖 ===');
            console.log('數據範圍:', fullDates[0], '~', fullDates[fullDates.length - 1]);
            
            // 從 analysis.waves 取得波浪標號
            if (analysis.waves && analysis.waves.length > 0) {
                console.log('波浪數據:', analysis.waves.map(w => `${w.number}(${w.endDate})`).join('→'));
                
                // 建立日期到波浪標號的映射
                analysis.waves.forEach((wave, idx) => {
                    // 波浪終點（標註波浪號碼）
                    if (wave.endDate) {
                        // 在圖表數據中尋找匹配的日期
                        const chartIdx = fullDates.findIndex(d => d === wave.endDate);
                        if (chartIdx !== -1) {
                            console.log(`Wave ${wave.number}: 找到日期 ${wave.endDate} at index ${chartIdx}`);
                            waveLabels[chartIdx] = {
                                label: wave.number,
                                price: wave.end,
                                type: wave.type
                            };
                            // 同時設定高低點
                            if (wave.type === 'up') {
                                pivotHighs[chartIdx] = wave.end;
                            } else {
                                pivotLows[chartIdx] = wave.end;
                            }
                        } else {
                            console.log(`Wave ${wave.number}: 日期 ${wave.endDate} 不在圖表範圍內`);
                        }
                    }
                });
            }
            
            // 如果沒有從 waves 取得足夠的標記，則使用 pivots 補充
            const dataStartIndex = stockData.length - recentData.length;
            if (analysis.pivots) {
                analysis.pivots.forEach(p => {
                    // 使用日期匹配
                    const chartIdx = fullDates.findIndex(d => d === p.date);
                    if (chartIdx !== -1 && !waveLabels[chartIdx]) {
                        if (p.type === 'high' && !pivotHighs[chartIdx]) {
                            pivotHighs[chartIdx] = p.price;
                        } else if (p.type === 'low' && !pivotLows[chartIdx]) {
                            pivotLows[chartIdx] = p.price;
                        }
                    }
                });
            }
            
            // 統計有多少波浪標籤
            const labelCount = waveLabels.filter(l => l !== null).length;
            console.log('圖表上的波浪標籤數量:', labelCount);
            
            // 自定義插件：繪製波浪標號
            const waveLabelsPlugin = {
                id: 'waveLabels',
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    const meta = chart.getDatasetMeta(0); // 收盤價的數據集
                    
                    waveLabels.forEach((info, index) => {
                        if (info && info.label !== null) {
                            const point = meta.data[index];
                            if (point) {
                                const x = point.x;
                                const y = point.y;
                                
                                // 判斷標號類型和位置
                                const isUp = info.type === 'up';
                                const isImpulse = typeof info.label === 'number' && [1, 3, 5].includes(info.label);
                                const isCorrection = typeof info.label === 'number' && [2, 4].includes(info.label);
                                const isABC = typeof info.label === 'string';
                                
                                // 設定顏色
                                let bgColor, offsetY;
                                if (isUp) {
                                    // 上漲結束點（在上方標註）
                                    if (isImpulse) {
                                        bgColor = '#10b981'; // 綠色 - 推動浪 1, 3, 5
                                    } else if (info.label === 'B') {
                                        bgColor = '#f59e0b'; // 橙色 - B浪反彈
                                    } else {
                                        bgColor = '#3b82f6'; // 藍色
                                    }
                                    offsetY = -30;
                                } else {
                                    // 下跌結束點（在下方標註）
                                    if (isCorrection) {
                                        bgColor = '#6366f1'; // 紫色 - 修正浪 2, 4
                                    } else if (isABC) {
                                        bgColor = '#ef4444'; // 紅色 - A, C浪
                                    } else {
                                        bgColor = '#8b5cf6'; // 淺紫色
                                    }
                                    offsetY = 30;
                                }
                                
                                // 繪製圓形背景
                                ctx.save();
                                ctx.beginPath();
                                ctx.arc(x, y + offsetY, 16, 0, Math.PI * 2);
                                ctx.fillStyle = bgColor;
                                ctx.fill();
                                ctx.strokeStyle = '#ffffff';
                                ctx.lineWidth = 2;
                                ctx.stroke();
                                
                                // 繪製標號文字
                                ctx.fillStyle = '#ffffff';
                                ctx.font = 'bold 14px Arial';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(String(info.label), x, y + offsetY);
                                
                                // 繪製連接線
                                ctx.beginPath();
                                ctx.moveTo(x, y);
                                ctx.lineTo(x, y + offsetY + (isUp ? 16 : -16));
                                ctx.strokeStyle = bgColor;
                                ctx.lineWidth = 2;
                                ctx.setLineDash([4, 4]);
                                ctx.stroke();
                                ctx.setLineDash([]);
                                
                                ctx.restore();
                            }
                        }
                    });
                }
            };
            
            charts.elliottChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '收盤價',
                            data: prices,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: '波浪高點',
                            data: pivotHighs,
                            borderColor: 'transparent',
                            backgroundColor: '#ef4444',
                            pointRadius: 6,
                            pointStyle: 'triangle',
                            showLine: false
                        },
                        {
                            label: '波浪低點',
                            data: pivotLows,
                            borderColor: 'transparent',
                            backgroundColor: '#10b981',
                            pointRadius: 6,
                            pointStyle: 'triangle',
                            rotation: 180,
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 40,
                            bottom: 40
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#94a3b8' }
                        },
                        tooltip: {
                            backgroundColor: '#1a2332',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            callbacks: {
                                label: function(context) {
                                    const idx = context.dataIndex;
                                    const waveInfo = waveLabels[idx];
                                    let label = context.dataset.label + ': ' + context.parsed.y?.toFixed(2);
                                    if (waveInfo && waveInfo.label !== null) {
                                        label += ` (第 ${waveInfo.label} 浪)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(45, 58, 79, 0.5)' },
                            ticks: { color: '#64748b', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: 'rgba(45, 58, 79, 0.5)' },
                            ticks: { color: '#64748b' }
                        }
                    }
                },
                plugins: [waveLabelsPlugin]
            });
        }

        function calculateFibonacciLevels(analysis) {
            if (!analysis.prices || analysis.prices.length < 10) return;
            
            const prices = analysis.prices;
            
            // 找最近的重要高低點
            let high = Math.max(...prices.slice(-30));
            let low = Math.min(...prices.slice(-30));
            
            const diff = high - low;
            
            // 計算費波納契水平
            const levels = {
                0: low,
                236: low + diff * 0.236,
                382: low + diff * 0.382,
                50: low + diff * 0.5,
                618: low + diff * 0.618,
                786: low + diff * 0.786,
                100: high,
                1618: low + diff * 1.618
            };
            
            // 更新顯示
            document.getElementById('fib0').textContent = levels[0].toFixed(2);
            document.getElementById('fib236').textContent = levels[236].toFixed(2);
            document.getElementById('fib382').textContent = levels[382].toFixed(2);
            document.getElementById('fib50').textContent = levels[50].toFixed(2);
            document.getElementById('fib618').textContent = levels[618].toFixed(2);
            document.getElementById('fib786').textContent = levels[786].toFixed(2);
            document.getElementById('fib100').textContent = levels[100].toFixed(2);
            document.getElementById('fib1618').textContent = levels[1618].toFixed(2);
            
            // 判斷當前價格在哪個區間
            const currentPrice = analysis.currentPrice;
            let fibPosition = '';
            
            if (currentPrice <= levels[236]) fibPosition = '0% - 23.6%';
            else if (currentPrice <= levels[382]) fibPosition = '23.6% - 38.2%';
            else if (currentPrice <= levels[50]) fibPosition = '38.2% - 50%';
            else if (currentPrice <= levels[618]) fibPosition = '50% - 61.8%';
            else if (currentPrice <= levels[786]) fibPosition = '61.8% - 78.6%';
            else if (currentPrice <= levels[100]) fibPosition = '78.6% - 100%';
            else fibPosition = '> 100% (延伸)';
            
            document.getElementById('fibonacciLevel').textContent = fibPosition;
        }

        // ===== AI 三方票決功能 =====
        
        // 載入儲存的 API 金鑰
        function loadApiKeys() {
            try {
                const keys = JSON.parse(localStorage.getItem('ai_voting_api_keys') || '{}');
                if (keys.claude) document.getElementById('claudeApiKey').value = keys.claude;
                if (keys.gemini) document.getElementById('geminiApiKey').value = keys.gemini;
                if (keys.openai) document.getElementById('openaiApiKey').value = keys.openai;
            } catch (e) {
                console.log('Error loading API keys:', e);
            }
        }

        // 儲存 API 金鑰
        function saveApiKeys() {
            const keys = {
                claude: document.getElementById('claudeApiKey').value.trim(),
                gemini: document.getElementById('geminiApiKey').value.trim(),
                openai: document.getElementById('openaiApiKey').value.trim()
            };
            localStorage.setItem('ai_voting_api_keys', JSON.stringify(keys));
            showToast('✅ API 金鑰已儲存');
        }

        // 清除 API 金鑰
        function clearApiKeys() {
            if (confirm('確定要清除所有 API 金鑰嗎？')) {
                localStorage.removeItem('ai_voting_api_keys');
                document.getElementById('claudeApiKey').value = '';
                document.getElementById('geminiApiKey').value = '';
                document.getElementById('openaiApiKey').value = '';
                showToast('🗑️ API 金鑰已清除');
            }
        }

        // 切換 API 金鑰顯示/隱藏
        function toggleApiKeyVisibility() {
            const inputs = ['claudeApiKey', 'geminiApiKey', 'openaiApiKey'];
            inputs.forEach(id => {
                const input = document.getElementById(id);
                input.type = input.type === 'password' ? 'text' : 'password';
            });
        }

        // 更新連線狀態顯示
        function updateConnectionStatus(ai, status, message = '') {
            const statusEl = document.getElementById(`${ai}ConnectionStatus`);
            const keyStatusEl = document.getElementById(`${ai}KeyStatus`);
            
            statusEl.className = 'conn-status ' + status;
            if (keyStatusEl) keyStatusEl.className = 'api-key-status ' + status;
            
            switch (status) {
                case 'testing':
                    statusEl.textContent = '測試中...';
                    if (keyStatusEl) keyStatusEl.textContent = '測試中';
                    break;
                case 'success':
                    statusEl.textContent = '✓ 連線成功';
                    if (keyStatusEl) keyStatusEl.textContent = '✓ 有效';
                    break;
                case 'error':
                    statusEl.textContent = '✗ ' + (message || '連線失敗');
                    if (keyStatusEl) keyStatusEl.textContent = '✗ 無效';
                    break;
                default:
                    statusEl.textContent = '未測試';
                    if (keyStatusEl) keyStatusEl.textContent = '';
            }
        }

        // 測試單一 API 連線
        async function testSingleApi(ai) {
            const keyMap = {
                claude: 'claudeApiKey',
                gemini: 'geminiApiKey',
                openai: 'openaiApiKey'
            };
            
            const apiKey = document.getElementById(keyMap[ai]).value.trim();
            
            if (!apiKey) {
                showToast(`⚠️ 請先輸入 ${ai.charAt(0).toUpperCase() + ai.slice(1)} API 金鑰`);
                return;
            }

            // 顯示連線狀態面板
            document.getElementById('connectionStatusPanel').style.display = 'block';
            updateConnectionStatus(ai, 'testing');

            try {
                let result;
                switch (ai) {
                    case 'claude':
                        result = await testClaudeConnection(apiKey);
                        break;
                    case 'gemini':
                        result = await testGeminiConnection(apiKey);
                        break;
                    case 'openai':
                        result = await testOpenAIConnection(apiKey);
                        break;
                }
                
                if (result.success) {
                    updateConnectionStatus(ai, 'success');
                    showToast(`✅ ${ai.charAt(0).toUpperCase() + ai.slice(1)} 連線成功！`);
                } else {
                    updateConnectionStatus(ai, 'error', result.error);
                    showToast(`❌ ${ai.charAt(0).toUpperCase() + ai.slice(1)} 連線失敗：${result.error}`);
                }
            } catch (error) {
                updateConnectionStatus(ai, 'error', error.message);
                showToast(`❌ ${ai.charAt(0).toUpperCase() + ai.slice(1)} 連線錯誤：${error.message}`);
            }
        }

        // 測試所有 API 連線
        async function testAllApiConnections() {
            const claudeKey = document.getElementById('claudeApiKey').value.trim();
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            const openaiKey = document.getElementById('openaiApiKey').value.trim();

            if (!claudeKey && !geminiKey && !openaiKey) {
                showToast('⚠️ 請至少輸入一個 API 金鑰');
                return;
            }

            // 顯示連線狀態面板
            document.getElementById('connectionStatusPanel').style.display = 'block';
            
            showToast('🔗 開始測試所有 API 連線...');

            const tests = [];

            if (claudeKey) {
                updateConnectionStatus('claude', 'testing');
                tests.push(
                    testClaudeConnection(claudeKey)
                        .then(result => {
                            updateConnectionStatus('claude', result.success ? 'success' : 'error', result.error);
                            return { ai: 'Claude', ...result };
                        })
                        .catch(err => {
                            updateConnectionStatus('claude', 'error', err.message);
                            return { ai: 'Claude', success: false, error: err.message };
                        })
                );
            }

            if (geminiKey) {
                updateConnectionStatus('gemini', 'testing');
                tests.push(
                    testGeminiConnection(geminiKey)
                        .then(result => {
                            updateConnectionStatus('gemini', result.success ? 'success' : 'error', result.error);
                            return { ai: 'Gemini', ...result };
                        })
                        .catch(err => {
                            updateConnectionStatus('gemini', 'error', err.message);
                            return { ai: 'Gemini', success: false, error: err.message };
                        })
                );
            }

            if (openaiKey) {
                updateConnectionStatus('openai', 'testing');
                tests.push(
                    testOpenAIConnection(openaiKey)
                        .then(result => {
                            updateConnectionStatus('openai', result.success ? 'success' : 'error', result.error);
                            return { ai: 'OpenAI', ...result };
                        })
                        .catch(err => {
                            updateConnectionStatus('openai', 'error', err.message);
                            return { ai: 'OpenAI', success: false, error: err.message };
                        })
                );
            }

            const results = await Promise.all(tests);
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;

            if (successCount === totalCount) {
                showToast(`✅ 所有 API 連線測試成功！(${successCount}/${totalCount})`);
            } else if (successCount > 0) {
                showToast(`⚠️ 部分 API 連線成功 (${successCount}/${totalCount})`);
            } else {
                showToast(`❌ 所有 API 連線失敗`);
            }
        }

        // 測試 Claude 連線
        async function testClaudeConnection(apiKey) {
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 10,
                        messages: [
                            { role: 'user', content: '測試連線，請回覆 OK' }
                        ]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return { success: true, message: 'Claude API 連線成功' };
                } else {
                    const error = await response.json();
                    return { success: false, error: error.error?.message || `HTTP ${response.status}` };
                }
            } catch (error) {
                return { success: false, error: error.message || '網路錯誤' };
            }
        }

        // 測試 Gemini 連線
        async function testGeminiConnection(apiKey) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: '測試連線，請回覆 OK' }]
                        }],
                        generationConfig: {
                            maxOutputTokens: 10
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return { success: true, message: 'Gemini API 連線成功' };
                } else {
                    const error = await response.json();
                    return { success: false, error: error.error?.message || `HTTP ${response.status}` };
                }
            } catch (error) {
                return { success: false, error: error.message || '網路錯誤' };
            }
        }

        // 測試 OpenAI 連線
        async function testOpenAIConnection(apiKey) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'user', content: '測試連線，請回覆 OK' }
                        ],
                        max_tokens: 10
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    return { success: true, message: 'OpenAI API 連線成功' };
                } else {
                    const error = await response.json();
                    return { success: false, error: error.error?.message || `HTTP ${response.status}` };
                }
            } catch (error) {
                return { success: false, error: error.message || '網路錯誤' };
            }
        }

        // 準備分析用的股票數據摘要
        function prepareStockDataSummary() {
            if (!stockData || stockData.length === 0) {
                return null;
            }

            try {
                const latestData = stockData[stockData.length - 1];
                const prevData = stockData.length > 1 ? stockData[stockData.length - 2] : null;
                
                // 計算基本統計
                const prices = stockData.map(d => parseFloat(d.close));
                const volumes = stockData.map(d => parseInt(d.volume));
                const high20 = Math.max(...prices.slice(-20));
                const low20 = Math.min(...prices.slice(-20));
                const avgVolume = volumes.slice(-20).reduce((a, b) => a + b, 0) / 20;
                
                // 計算均線
                const ma5 = prices.slice(-5).reduce((a, b) => a + b, 0) / 5;
                const ma10 = prices.slice(-10).reduce((a, b) => a + b, 0) / 10;
                const ma20 = prices.slice(-20).reduce((a, b) => a + b, 0) / 20;
                
                const currentPrice = parseFloat(latestData.close);
                const change = prevData ? currentPrice - parseFloat(prevData.close) : 0;
                const changePercent = prevData ? (change / parseFloat(prevData.close) * 100) : 0;

                // 處理技術指標 - 可能是陣列或單一值
                const getLastValue = (indicator) => {
                    if (Array.isArray(indicator)) {
                        // 找到最後一個有效值
                        for (let i = indicator.length - 1; i >= 0; i--) {
                            if (indicator[i] !== null && indicator[i] !== undefined && !isNaN(indicator[i])) {
                                return indicator[i];
                            }
                        }
                        return null;
                    }
                    return indicator;
                };

                const rsiValue = getLastValue(technicalIndicators.rsi);
                const kValue = getLastValue(technicalIndicators.k);
                const dValue = getLastValue(technicalIndicators.d);
                const difValue = getLastValue(technicalIndicators.dif);
                const macdValue = getLastValue(technicalIndicators.macd);

                return {
                    stockCode: currentStockCode,
                    stockName: stockName,
                    market: currentMarket === 'twse' ? '上市' : '上櫃',
                    currentPrice: currentPrice,
                    change: change.toFixed(2),
                    changePercent: changePercent.toFixed(2),
                    high20: high20.toFixed(2),
                    low20: low20.toFixed(2),
                    ma5: ma5.toFixed(2),
                    ma10: ma10.toFixed(2),
                    ma20: ma20.toFixed(2),
                    volume: parseInt(latestData.volume),
                    avgVolume: Math.round(avgVolume),
                    volumeRatio: (parseInt(latestData.volume) / avgVolume).toFixed(2),
                    rsi: rsiValue ? rsiValue.toFixed(2) : 'N/A',
                    kd: (kValue && dValue) ? 
                        `K:${kValue.toFixed(2)}, D:${dValue.toFixed(2)}` : 'N/A',
                    macd: (difValue && macdValue) ?
                        `DIF:${difValue.toFixed(2)}, MACD:${macdValue.toFixed(2)}` : 'N/A',
                    dataDate: latestData.date,
                    dataDays: stockData.length
                };
            } catch (error) {
                console.error('prepareStockDataSummary 錯誤:', error);
                return null;
            }
        }

        // 建立 AI 分析 Prompt
        function buildAnalysisPrompt(summary) {
            return `你是一位專業的台股技術分析師。請根據以下股票數據進行分析，並給出明確的投資建議。

股票資訊：
- 股票：${summary.stockName} (${summary.stockCode}) - ${summary.market}
- 數據日期：${summary.dataDate}
- 分析天數：${summary.dataDays} 天

價格資訊：
- 當前價格：${summary.currentPrice} 元
- 漲跌：${summary.change} 元 (${summary.changePercent}%)
- 20日最高：${summary.high20} 元
- 20日最低：${summary.low20} 元

均線位置：
- MA5：${summary.ma5} 元
- MA10：${summary.ma10} 元
- MA20：${summary.ma20} 元
- 股價相對MA5：${(summary.currentPrice > parseFloat(summary.ma5)) ? '在上方' : '在下方'}
- 股價相對MA20：${(summary.currentPrice > parseFloat(summary.ma20)) ? '在上方' : '在下方'}

成交量：
- 當日成交量：${summary.volume.toLocaleString()} 張
- 20日平均量：${summary.avgVolume.toLocaleString()} 張
- 量能比：${summary.volumeRatio}x

技術指標：
- RSI(14)：${summary.rsi}
- KD指標：${summary.kd}
- MACD：${summary.macd}

請依照以下格式回覆（請嚴格遵守格式）：

【投資建議】買進/賣出/觀望（只能選一個）
【信心度】0-100（數字）
【技術面分析】
（請詳細分析均線排列、KD指標、RSI、MACD等技術指標的多空訊號，約150字）
【量價分析】
（請分析成交量變化、量價配合情況，約80字）
【風險評估】
（請評估目前的風險點和注意事項，約70字）
【操作建議】
（請給出具體的操作建議，包含進場點位、停損停利建議，約100字）`;
        }

        // 呼叫 Claude API
        async function callClaudeAPI(prompt, apiKey) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1500,
                    messages: [
                        { role: 'user', content: prompt }
                    ]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Claude API 錯誤');
            }

            const data = await response.json();
            return data.content[0].text;
        }

        // 呼叫 Gemini API
        async function callGeminiAPI(prompt, apiKey) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 1500,
                        temperature: 0.7
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Gemini API 錯誤');
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // 呼叫 OpenAI API
        async function callOpenAIAPI(prompt, apiKey) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        { role: 'user', content: prompt }
                    ],
                    max_tokens: 1500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'OpenAI API 錯誤');
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // 解析 AI 回覆
        function parseAIResponse(response) {
            let verdict = 'hold';
            let confidence = 50;
            let analysis = '';

            // 解析投資建議
            const verdictMatch = response.match(/【投資建議】\s*(買進|賣出|觀望)/);
            if (verdictMatch) {
                const v = verdictMatch[1];
                if (v === '買進') verdict = 'buy';
                else if (v === '賣出') verdict = 'sell';
                else verdict = 'hold';
            }

            // 解析信心度
            const confidenceMatch = response.match(/【信心度】\s*(\d+)/);
            if (confidenceMatch) {
                confidence = Math.min(100, Math.max(0, parseInt(confidenceMatch[1])));
            }

            // 解析各段分析內容
            const sections = [];
            
            // 技術面分析
            const techMatch = response.match(/【技術面分析】\s*([\s\S]*?)(?=【|$)/);
            if (techMatch && techMatch[1].trim()) {
                sections.push('📊 技術面分析：\n' + techMatch[1].trim());
            }
            
            // 量價分析
            const volumeMatch = response.match(/【量價分析】\s*([\s\S]*?)(?=【|$)/);
            if (volumeMatch && volumeMatch[1].trim()) {
                sections.push('📈 量價分析：\n' + volumeMatch[1].trim());
            }
            
            // 風險評估
            const riskMatch = response.match(/【風險評估】\s*([\s\S]*?)(?=【|$)/);
            if (riskMatch && riskMatch[1].trim()) {
                sections.push('⚠️ 風險評估：\n' + riskMatch[1].trim());
            }
            
            // 操作建議
            const opMatch = response.match(/【操作建議】\s*([\s\S]*?)(?=【|$)/);
            if (opMatch && opMatch[1].trim()) {
                sections.push('💡 操作建議：\n' + opMatch[1].trim());
            }
            
            // 舊格式相容：分析理由
            const reasonMatch = response.match(/【分析理由】\s*([\s\S]*?)(?=【|$)/);
            if (reasonMatch && reasonMatch[1].trim()) {
                sections.push(reasonMatch[1].trim());
            }

            // 組合分析內容
            if (sections.length > 0) {
                analysis = sections.join('\n\n');
            } else {
                // 如果解析失敗，使用原始回覆（去除前兩行）
                const lines = response.split('\n').filter(l => !l.includes('【投資建議】') && !l.includes('【信心度】'));
                analysis = lines.join('\n').trim();
            }

            return { verdict, confidence, analysis };
        }

        // 更新 AI 卡片狀態
        function updateAICard(ai, status, result = null) {
            const statusEl = document.getElementById(`${ai}Status`);
            const verdictEl = document.getElementById(`${ai}Verdict`);
            const confidenceEl = document.getElementById(`${ai}Confidence`);
            const analysisEl = document.getElementById(`${ai}Analysis`);
            const cardEl = document.getElementById(`${ai}ResultCard`);

            statusEl.className = 'ai-status ' + status;
            
            if (status === 'analyzing') {
                statusEl.textContent = '分析中...';
                cardEl.classList.add('loading');
                analysisEl.innerHTML = '<span class="ai-loading-spinner"></span> 正在分析...';
            } else if (status === 'ready') {
                statusEl.textContent = '完成';
                cardEl.classList.remove('loading');
                
                if (result) {
                    // 設定判決
                    verdictEl.textContent = result.verdict === 'buy' ? '買進 📈' : 
                                           result.verdict === 'sell' ? '賣出 📉' : '觀望 ⏸️';
                    verdictEl.className = 'ai-verdict-value ' + result.verdict;
                    
                    // 設定信心度
                    confidenceEl.style.width = result.confidence + '%';
                    
                    // 設定分析內容
                    analysisEl.textContent = result.analysis;
                }
            } else if (status === 'error') {
                statusEl.textContent = '錯誤';
                cardEl.classList.remove('loading');
                verdictEl.textContent = '-';
                verdictEl.className = 'ai-verdict-value';
                confidenceEl.style.width = '0%';
                analysisEl.textContent = result?.error || '發生錯誤';
            } else {
                statusEl.textContent = '待命';
                cardEl.classList.remove('loading');
            }
        }

        // 計算最終票決結果
        function calculateFinalVerdict(results, aiNames = []) {
            const votes = { buy: 0, sell: 0, hold: 0 };
            let totalConfidence = 0;
            let validResults = 0;
            
            results.forEach(r => {
                if (r && r.verdict) {
                    votes[r.verdict]++;
                    totalConfidence += r.confidence || 0;
                    validResults++;
                }
            });

            document.getElementById('buyVoteCount').textContent = votes.buy;
            document.getElementById('sellVoteCount').textContent = votes.sell;
            document.getElementById('holdVoteCount').textContent = votes.hold;

            // 決定最終結果
            let finalVerdict = 'hold';
            let finalText = '觀望 ⏸️';
            let verdictReason = '';
            
            if (votes.buy > votes.sell && votes.buy > votes.hold) {
                finalVerdict = 'buy';
                finalText = '買進 📈';
                verdictReason = `${votes.buy} 個 AI 建議買進`;
            } else if (votes.sell > votes.buy && votes.sell > votes.hold) {
                finalVerdict = 'sell';
                finalText = '賣出 📉';
                verdictReason = `${votes.sell} 個 AI 建議賣出`;
            } else if (votes.buy === votes.sell && votes.buy > 0) {
                finalVerdict = 'hold';
                finalText = '觀望 ⏸️';
                verdictReason = '買賣意見相左，建議觀望';
            } else if (votes.hold >= votes.buy && votes.hold >= votes.sell) {
                finalVerdict = 'hold';
                finalText = '觀望 ⏸️';
                verdictReason = `${votes.hold} 個 AI 建議觀望`;
            }

            const resultEl = document.getElementById('finalVerdictResult');
            resultEl.textContent = finalText;
            resultEl.className = 'final-verdict-result ' + finalVerdict;

            // 計算平均信心度
            const avgConf = validResults > 0 ? Math.round(totalConfidence / validResults) : 0;
            document.getElementById('avgConfidence').textContent = avgConf + '%';
            
            // 參與票決 AI 數量
            document.getElementById('votingAiCount').textContent = `${validResults}/3`;
            
            // 一致性判斷
            const maxVotes = Math.max(votes.buy, votes.sell, votes.hold);
            let consensus = '';
            if (validResults === 0) {
                consensus = '-';
            } else if (maxVotes === validResults) {
                consensus = '完全一致 ✓';
            } else if (maxVotes >= validResults * 0.67) {
                consensus = '多數同意';
            } else {
                consensus = '意見分歧';
            }
            document.getElementById('consensusLevel').textContent = consensus;
            
            // 生成綜合結論
            let summaryContent = `📊 票決結果：${verdictReason}\n`;
            summaryContent += `📈 平均信心度：${avgConf}%\n`;
            summaryContent += `🤝 一致性：${consensus}\n\n`;
            
            // 各 AI 的簡要觀點
            summaryContent += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
            summaryContent += `📌 各 AI 觀點摘要：\n\n`;
            
            const aiLabels = ['Claude', 'Gemini', 'OpenAI'];
            const aiIcons = ['🤖', '✨', '🧠'];
            
            results.forEach((r, i) => {
                if (r) {
                    const verdictText = r.verdict === 'buy' ? '買進' : r.verdict === 'sell' ? '賣出' : '觀望';
                    summaryContent += `${aiIcons[i]} ${aiLabels[i]}：${verdictText} (信心度 ${r.confidence}%)\n`;
                }
            });
            
            summaryContent += `\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
            summaryContent += `💡 綜合建議：\n`;
            
            if (finalVerdict === 'buy') {
                if (avgConf >= 70) {
                    summaryContent += `多數 AI 看好此股，且信心度較高。可考慮進場，但仍需注意風險控管。`;
                } else {
                    summaryContent += `雖然多數建議買進，但信心度不高，建議謹慎評估或小量試單。`;
                }
            } else if (finalVerdict === 'sell') {
                if (avgConf >= 70) {
                    summaryContent += `多數 AI 建議賣出，且信心度較高。若持有中建議考慮減碼或出場。`;
                } else {
                    summaryContent += `雖然多數建議賣出，但信心度不高，可設停損觀察後續發展。`;
                }
            } else {
                summaryContent += `AI 意見分歧或建議觀望，建議暫時不要進場，等待更明確的訊號。`;
            }
            
            document.getElementById('finalSummaryContent').textContent = summaryContent;
            
            // 分析時間戳
            const now = new Date();
            document.getElementById('analysisTimestamp').textContent = 
                now.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });

            document.getElementById('finalVerdictSection').style.display = 'block';
        }

        // 開始 AI 三方票決
        async function startAiVoting() {
            // 立即顯示反饋，確認按鈕被觸發
            const btn = document.getElementById('startAiVotingBtn');
            btn.innerHTML = '🔄 檢查中...';
            
            try {
                showToast('🔄 開始檢查數據...');
                console.log('=== 開始 AI 三方票決 ===');
                console.log('stockData:', stockData);
                console.log('stockData length:', stockData ? stockData.length : 'null');
                console.log('stockName:', stockName);
                console.log('currentStockCode:', currentStockCode);
                
                // 檢查是否有股票數據
                const summary = prepareStockDataSummary();
                console.log('股票數據摘要:', summary);
                
                if (!summary) {
                    // 更明確的提示
                    const errorMsg = '⚠️ 請先載入股票數據！\n\n操作步驟：\n1. 在上方輸入股票代號（如 2330）\n2. 點擊「分析」按鈕載入數據\n3. 再回到此分頁進行 AI 分析';
                    alert(errorMsg);
                    showToast('❌ 請先載入股票數據');
                    
                    // 更新按鈕提示
                    btn.innerHTML = '⚠️ 請先載入股票數據';
                    setTimeout(() => {
                        btn.innerHTML = '🚀 開始 AI 三方分析與票決';
                    }, 3000);
                    return;
                }

                // 取得 API 金鑰
                const claudeKey = document.getElementById('claudeApiKey').value.trim();
                const geminiKey = document.getElementById('geminiApiKey').value.trim();
                const openaiKey = document.getElementById('openaiApiKey').value.trim();

                console.log('API 金鑰狀態:', {
                    claude: claudeKey ? '已輸入 (' + claudeKey.length + '字元)' : '未輸入',
                    gemini: geminiKey ? '已輸入 (' + geminiKey.length + '字元)' : '未輸入',
                    openai: openaiKey ? '已輸入 (' + openaiKey.length + '字元)' : '未輸入'
                });

                if (!claudeKey && !geminiKey && !openaiKey) {
                    alert('請至少輸入一個 API 金鑰');
                    showToast('❌ 請輸入 API 金鑰');
                    btn.innerHTML = '🚀 開始 AI 三方分析與票決';
                    return;
                }

                // 禁用按鈕
                btn.disabled = true;
                btn.innerHTML = '<span class="ai-loading-spinner"></span> 正在分析中...請稍候';

                showToast(`🚀 開始分析 ${summary.stockName}(${summary.stockCode})...`);

                // 隱藏最終結果
                document.getElementById('finalVerdictSection').style.display = 'none';

                // 準備 prompt
                const prompt = buildAnalysisPrompt(summary);
                console.log('分析 Prompt 長度:', prompt.length);
                console.log('Prompt 前200字:', prompt.substring(0, 200));
                
                const results = [];

                // 重置所有卡片
                ['claude', 'gemini', 'openai'].forEach(ai => {
                    updateAICard(ai, 'idle');
                });

                // 並行呼叫所有 API
                const promises = [];

            // Claude
            if (claudeKey) {
                updateAICard('claude', 'analyzing');
                promises.push(
                    callClaudeAPI(prompt, claudeKey)
                        .then(response => {
                            const parsed = parseAIResponse(response);
                            updateAICard('claude', 'ready', parsed);
                            return parsed;
                        })
                        .catch(error => {
                            console.error('Claude error:', error);
                            updateAICard('claude', 'error', { error: error.message });
                            return null;
                        })
                );
            }

            // Gemini
            if (geminiKey) {
                updateAICard('gemini', 'analyzing');
                promises.push(
                    callGeminiAPI(prompt, geminiKey)
                        .then(response => {
                            const parsed = parseAIResponse(response);
                            updateAICard('gemini', 'ready', parsed);
                            return parsed;
                        })
                        .catch(error => {
                            console.error('Gemini error:', error);
                            updateAICard('gemini', 'error', { error: error.message });
                            return null;
                        })
                );
            }

            // OpenAI
            if (openaiKey) {
                updateAICard('openai', 'analyzing');
                promises.push(
                    callOpenAIAPI(prompt, openaiKey)
                        .then(response => {
                            const parsed = parseAIResponse(response);
                            updateAICard('openai', 'ready', parsed);
                            return parsed;
                        })
                        .catch(error => {
                            console.error('OpenAI error:', error);
                            updateAICard('openai', 'error', { error: error.message });
                            return null;
                        })
                );
            }

            // 等待所有結果
            try {
                const allResults = await Promise.all(promises);
                results.push(...allResults.filter(r => r !== null));
                
                // 計算最終票決
                if (results.length > 0) {
                    calculateFinalVerdict(results);
                } else {
                    showToast('⚠️ 所有 API 都返回錯誤');
                }
            } catch (error) {
                console.error('Voting error:', error);
                showToast('❌ 分析過程發生錯誤: ' + error.message);
            }

            // 恢復按鈕
            btn.disabled = false;
            btn.innerHTML = '🚀 開始 AI 三方分析與票決';
            
            } catch (outerError) {
                // 外層錯誤處理
                console.error('startAiVoting 外層錯誤:', outerError);
                showToast('❌ 發生錯誤: ' + outerError.message);
                alert('發生錯誤: ' + outerError.message + '\n\n請檢查 Console (F12) 獲取詳細資訊');
                
                const btn = document.getElementById('startAiVotingBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '🚀 開始 AI 三方分析與票決';
                }
            }
        }

        // ===============================
        // 智能警示 AI 三方解析
        // ===============================
        async function startAlertAiAnalysis() {
            const btn = document.getElementById('startAlertAiBtn');
            btn.innerHTML = '🔄 分析中...';
            btn.disabled = true;

            try {
                // 檢查股票數據
                if (!stockData || stockData.length === 0) {
                    alert('請先載入股票數據');
                    btn.innerHTML = '🚀 啟動 AI 三方解析智能警示';
                    btn.disabled = false;
                    return;
                }

                // 收集警示資訊
                const alertsList = document.getElementById('alertsList');
                const alertsText = alertsList ? alertsList.innerText : '';
                const bullishCount = document.getElementById('bullishCount')?.textContent || '0';
                const bearishCount = document.getElementById('bearishCount')?.textContent || '0';
                const warningCount = document.getElementById('warningCount')?.textContent || '0';
                const alertScore = document.getElementById('alertScore')?.textContent || '0';

                const summary = prepareStockDataSummary();
                if (!summary) {
                    alert('無法準備股票數據摘要');
                    btn.innerHTML = '🚀 啟動 AI 三方解析智能警示';
                    btn.disabled = false;
                    return;
                }

                // 建立 Prompt
                const prompt = `你是一位專業的台股風險分析師。請根據以下智能警示資訊進行風險評估分析。

股票資訊：
- 股票：${summary.stockName} (${summary.stockCode}) - ${summary.market}
- 當前價格：${summary.currentPrice} 元
- 漲跌：${summary.change} 元 (${summary.changePercent}%)

智能警示統計：
- 看漲訊號：${bullishCount} 個
- 看跌訊號：${bearishCount} 個
- 警告訊號：${warningCount} 個
- 綜合評分：${alertScore} 分（範圍 -100 至 +100）

技術指標：
- RSI(14)：${summary.rsi}
- KD指標：${summary.kd}
- MACD：${summary.macd}

警示詳情：
${alertsText.substring(0, 500)}

請依照以下格式回覆（請嚴格遵守格式）：

【風險評估】低風險/中風險/高風險（只能選一個）
【信心度】0-100（數字）
【警示解讀】
（請詳細解讀各個警示訊號的意義，約150字）
【風險因素】
（請列出主要風險因素，約100字）
【操作建議】
（請給出具體的風險控管建議，約100字）`;

                // 取得 API 金鑰
                const claudeKey = document.getElementById('claudeApiKey')?.value?.trim();
                const geminiKey = document.getElementById('geminiApiKey')?.value?.trim();
                const openaiKey = document.getElementById('openaiApiKey')?.value?.trim();

                if (!claudeKey && !geminiKey && !openaiKey) {
                    alert('請先在「AI 三方票決」分頁設定 API 金鑰');
                    btn.innerHTML = '🚀 啟動 AI 三方解析智能警示';
                    btn.disabled = false;
                    return;
                }

                const promises = [];
                const results = [];

                // 重置卡片
                ['Claude', 'Gemini', 'Openai'].forEach(ai => {
                    const lower = ai.toLowerCase();
                    updateAlertAICard(lower, 'idle');
                });

                // Claude
                if (claudeKey) {
                    updateAlertAICard('claude', 'analyzing');
                    promises.push(
                        callClaudeAPI(prompt, claudeKey)
                            .then(response => {
                                const parsed = parseAlertAIResponse(response);
                                updateAlertAICard('claude', 'ready', parsed);
                                return parsed;
                            })
                            .catch(error => {
                                updateAlertAICard('claude', 'error', { error: error.message });
                                return null;
                            })
                    );
                }

                // Gemini
                if (geminiKey) {
                    updateAlertAICard('gemini', 'analyzing');
                    promises.push(
                        callGeminiAPI(prompt, geminiKey)
                            .then(response => {
                                const parsed = parseAlertAIResponse(response);
                                updateAlertAICard('gemini', 'ready', parsed);
                                return parsed;
                            })
                            .catch(error => {
                                updateAlertAICard('gemini', 'error', { error: error.message });
                                return null;
                            })
                    );
                }

                // OpenAI
                if (openaiKey) {
                    updateAlertAICard('openai', 'analyzing');
                    promises.push(
                        callOpenAIAPI(prompt, openaiKey)
                            .then(response => {
                                const parsed = parseAlertAIResponse(response);
                                updateAlertAICard('openai', 'ready', parsed);
                                return parsed;
                            })
                            .catch(error => {
                                updateAlertAICard('openai', 'error', { error: error.message });
                                return null;
                            })
                    );
                }

                const allResults = await Promise.all(promises);
                results.push(...allResults.filter(r => r !== null));

                if (results.length > 0) {
                    calculateAlertFinalVerdict(results);
                }

            } catch (error) {
                console.error('Alert AI error:', error);
                showToast('❌ 分析錯誤: ' + error.message);
            }

            btn.innerHTML = '🚀 啟動 AI 三方解析智能警示';
            btn.disabled = false;
        }

        function updateAlertAICard(ai, status, result = null) {
            const statusEl = document.getElementById(`alert${ai.charAt(0).toUpperCase() + ai.slice(1)}Status`);
            const verdictEl = document.getElementById(`alert${ai.charAt(0).toUpperCase() + ai.slice(1)}Verdict`);
            const confidenceEl = document.getElementById(`alert${ai.charAt(0).toUpperCase() + ai.slice(1)}Confidence`);
            const analysisEl = document.getElementById(`alert${ai.charAt(0).toUpperCase() + ai.slice(1)}Analysis`);

            if (!statusEl) return;

            if (status === 'analyzing') {
                statusEl.textContent = '分析中...';
                statusEl.className = 'ai-status analyzing';
            } else if (status === 'ready' && result) {
                statusEl.textContent = '完成';
                statusEl.className = 'ai-status ready';
                
                const riskText = result.verdict === 'low' ? '低風險 🟢' : result.verdict === 'high' ? '高風險 🔴' : '中風險 🟡';
                verdictEl.textContent = riskText;
                verdictEl.className = 'ai-verdict-value ' + (result.verdict === 'low' ? 'buy' : result.verdict === 'high' ? 'sell' : 'hold');
                confidenceEl.style.width = result.confidence + '%';
                analysisEl.textContent = result.analysis;
            } else if (status === 'error') {
                statusEl.textContent = '錯誤';
                statusEl.className = 'ai-status error';
                analysisEl.textContent = result?.error || '發生錯誤';
            } else {
                statusEl.textContent = '待命';
                statusEl.className = 'ai-status';
                verdictEl.textContent = '-';
                confidenceEl.style.width = '0%';
                analysisEl.textContent = '等待分析...';
            }
        }

        function parseAlertAIResponse(response) {
            let verdict = 'medium';
            let confidence = 50;
            let analysis = '';

            const verdictMatch = response.match(/【風險評估】\s*(低風險|中風險|高風險)/);
            if (verdictMatch) {
                const v = verdictMatch[1];
                if (v === '低風險') verdict = 'low';
                else if (v === '高風險') verdict = 'high';
                else verdict = 'medium';
            }

            const confidenceMatch = response.match(/【信心度】\s*(\d+)/);
            if (confidenceMatch) {
                confidence = Math.min(100, Math.max(0, parseInt(confidenceMatch[1])));
            }

            const sections = [];
            const interpretMatch = response.match(/【警示解讀】\s*([\s\S]*?)(?=【|$)/);
            if (interpretMatch) sections.push('📊 警示解讀：\n' + interpretMatch[1].trim());
            
            const riskMatch = response.match(/【風險因素】\s*([\s\S]*?)(?=【|$)/);
            if (riskMatch) sections.push('⚠️ 風險因素：\n' + riskMatch[1].trim());
            
            const adviceMatch = response.match(/【操作建議】\s*([\s\S]*?)(?=【|$)/);
            if (adviceMatch) sections.push('💡 操作建議：\n' + adviceMatch[1].trim());

            analysis = sections.length > 0 ? sections.join('\n\n') : response;

            return { verdict, confidence, analysis };
        }

        function calculateAlertFinalVerdict(results) {
            const votes = { low: 0, medium: 0, high: 0 };
            let totalConfidence = 0;

            results.forEach(r => {
                if (r && r.verdict) {
                    votes[r.verdict]++;
                    totalConfidence += r.confidence;
                }
            });

            document.getElementById('alertLowRiskCount').textContent = votes.low;
            document.getElementById('alertMedRiskCount').textContent = votes.medium;
            document.getElementById('alertHighRiskCount').textContent = votes.high;

            let finalVerdict = 'medium';
            let finalText = '中風險 🟡';

            if (votes.low > votes.medium && votes.low > votes.high) {
                finalVerdict = 'low';
                finalText = '低風險 🟢';
            } else if (votes.high > votes.low && votes.high > votes.medium) {
                finalVerdict = 'high';
                finalText = '高風險 🔴';
            }

            const resultEl = document.getElementById('alertFinalResult');
            resultEl.textContent = finalText;
            resultEl.className = 'final-verdict-result ' + (finalVerdict === 'low' ? 'buy' : finalVerdict === 'high' ? 'sell' : 'hold');

            const avgConf = results.length > 0 ? Math.round(totalConfidence / results.length) : 0;
            
            let summary = `📊 風險評估結果：${finalText}\n`;
            summary += `📈 平均信心度：${avgConf}%\n`;
            summary += `🤖 參與分析 AI：${results.length}/3\n\n`;
            summary += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
            summary += `💡 綜合建議：\n`;
            
            if (finalVerdict === 'low') {
                summary += `目前技術面風險較低，可以考慮適度布局，但仍需注意整體市場環境。`;
            } else if (finalVerdict === 'high') {
                summary += `目前存在較高風險，建議謹慎操作，考慮減碼或設定嚴格停損。`;
            } else {
                summary += `風險程度中等，建議觀望為主，等待更明確的訊號再行動。`;
            }

            document.getElementById('alertFinalSummary').textContent = summary;
            document.getElementById('alertFinalVerdict').style.display = 'block';
            
            // ====== 更新上方 AI 燈號面板 ======
            const lightsPanel = document.getElementById('aiAlertLightsPanel');
            lightsPanel.style.display = 'block';
            
            // 更新燈號數字
            document.getElementById('aiLightBullishCount').textContent = votes.low;
            document.getElementById('aiLightWarningCount').textContent = votes.medium;
            document.getElementById('aiLightBearishCount').textContent = votes.high;
            
            // 更新燈號圖示 (亮燈效果)
            document.getElementById('aiLightBullishIcon').textContent = votes.low > 0 ? '🟢' : '⚫';
            document.getElementById('aiLightWarningIcon').textContent = votes.medium > 0 ? '🟡' : '⚫';
            document.getElementById('aiLightBearishIcon').textContent = votes.high > 0 ? '🔴' : '⚫';
            
            // 更新燈號背景亮度
            document.getElementById('aiLightBullish').style.background = votes.low > 0 ? 
                'rgba(16, 185, 129, 0.4)' : 'rgba(16, 185, 129, 0.1)';
            document.getElementById('aiLightWarning').style.background = votes.medium > 0 ? 
                'rgba(245, 158, 11, 0.4)' : 'rgba(245, 158, 11, 0.1)';
            document.getElementById('aiLightBearish').style.background = votes.high > 0 ? 
                'rgba(239, 68, 68, 0.4)' : 'rgba(239, 68, 68, 0.1)';
            
            // 更新最終結果顯示
            const finalLightResult = document.getElementById('aiFinalLightResult');
            if (finalVerdict === 'low') {
                finalLightResult.textContent = '🟢 低風險 - 可布局';
                finalLightResult.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.1))';
                finalLightResult.style.color = '#10b981';
                finalLightResult.style.border = '2px solid #10b981';
            } else if (finalVerdict === 'high') {
                finalLightResult.textContent = '🔴 高風險 - 宜謹慎';
                finalLightResult.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.1))';
                finalLightResult.style.color = '#ef4444';
                finalLightResult.style.border = '2px solid #ef4444';
            } else {
                finalLightResult.textContent = '🟡 中風險 - 觀望中';
                finalLightResult.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(245, 158, 11, 0.1))';
                finalLightResult.style.color = '#f59e0b';
                finalLightResult.style.border = '2px solid #f59e0b';
            }
            
            // 更新簡短摘要
            let lightSummary = `AI 三方分析完成（${results.length}/3）| 平均信心度 ${avgConf}% | `;
            if (finalVerdict === 'low') {
                lightSummary += '技術面風險較低，可考慮適度布局';
            } else if (finalVerdict === 'high') {
                lightSummary += '存在較高風險，建議減碼或設停損';
            } else {
                lightSummary += '風險中等，建議觀望等待明確訊號';
            }
            document.getElementById('aiFinalLightSummary').textContent = lightSummary;
        }

        // ===============================
        // 波浪理論 AI 三方解析
        // ===============================
        async function startWaveAiAnalysis() {
            const btn = document.getElementById('startWaveAiBtn');
            btn.innerHTML = '🔄 分析中...';
            btn.disabled = true;

            try {
                if (!stockData || stockData.length === 0) {
                    alert('請先載入股票數據');
                    btn.innerHTML = '🚀 啟動 AI 三方解析波浪理論';
                    btn.disabled = false;
                    return;
                }

                // 收集波浪理論資訊
                const wavePosition = document.getElementById('currentWavePosition')?.textContent || '-';
                const waveDesc = document.getElementById('currentWaveDesc')?.textContent || '';
                const elliottTrend = document.getElementById('elliottTrend')?.textContent || '-';
                const elliottStrength = document.getElementById('elliottStrength')?.textContent || '-';
                const fibLevel = document.getElementById('fibonacciLevel')?.textContent || '-';
                const wavePrediction = document.getElementById('wavePrediction')?.innerText || '';
                const elliottAnalysis = document.getElementById('elliottAnalysis')?.innerText || '';

                // 費波納契水平
                const fib0 = document.getElementById('fib0')?.textContent || '-';
                const fib382 = document.getElementById('fib382')?.textContent || '-';
                const fib50 = document.getElementById('fib50')?.textContent || '-';
                const fib618 = document.getElementById('fib618')?.textContent || '-';
                const fib100 = document.getElementById('fib100')?.textContent || '-';

                const summary = prepareStockDataSummary();
                if (!summary) {
                    alert('無法準備股票數據摘要');
                    btn.innerHTML = '🚀 啟動 AI 三方解析波浪理論';
                    btn.disabled = false;
                    return;
                }

                const prompt = `你是一位專精艾略特波浪理論的台股技術分析師。請根據以下波浪分析資訊進行深入解析。

股票資訊：
- 股票：${summary.stockName} (${summary.stockCode}) - ${summary.market}
- 當前價格：${summary.currentPrice} 元
- 漲跌：${summary.change} 元 (${summary.changePercent}%)
- 20日最高：${summary.high20} 元
- 20日最低：${summary.low20} 元

波浪分析數據：
- 當前波浪位置：${wavePosition}
- 波浪描述：${waveDesc}
- 趨勢方向：${elliottTrend}
- 波浪強度：${elliottStrength}
- 費波納契位置：${fibLevel}

費波納契回撤水平：
- 0%：${fib0}
- 38.2%：${fib382}
- 50%：${fib50}
- 61.8%：${fib618}
- 100%：${fib100}

技術指標：
- RSI(14)：${summary.rsi}
- KD指標：${summary.kd}
- MACD：${summary.macd}

系統分析：
${elliottAnalysis.substring(0, 300)}

預測：
${wavePrediction.substring(0, 200)}

請依照以下格式回覆（請嚴格遵守格式）：

【波浪判斷】上升浪/整理浪/下降浪（只能選一個）
【信心度】0-100（數字）
【波浪結構分析】
（請詳細分析當前波浪結構和所處位置，約150字）
【費波納契解讀】
（請解讀價格與費波納契關鍵水平的關係，約100字）
【後續走勢預測】
（請預測可能的波浪發展和目標價位，約100字）`;

                const claudeKey = document.getElementById('claudeApiKey')?.value?.trim();
                const geminiKey = document.getElementById('geminiApiKey')?.value?.trim();
                const openaiKey = document.getElementById('openaiApiKey')?.value?.trim();

                if (!claudeKey && !geminiKey && !openaiKey) {
                    alert('請先在「AI 三方票決」分頁設定 API 金鑰');
                    btn.innerHTML = '🚀 啟動 AI 三方解析波浪理論';
                    btn.disabled = false;
                    return;
                }

                const promises = [];
                const results = [];

                ['Claude', 'Gemini', 'Openai'].forEach(ai => {
                    updateWaveAICard(ai.toLowerCase(), 'idle');
                });

                if (claudeKey) {
                    updateWaveAICard('claude', 'analyzing');
                    promises.push(
                        callClaudeAPI(prompt, claudeKey)
                            .then(response => {
                                const parsed = parseWaveAIResponse(response);
                                updateWaveAICard('claude', 'ready', parsed);
                                return parsed;
                            })
                            .catch(error => {
                                updateWaveAICard('claude', 'error', { error: error.message });
                                return null;
                            })
                    );
                }

                if (geminiKey) {
                    updateWaveAICard('gemini', 'analyzing');
                    promises.push(
                        callGeminiAPI(prompt, geminiKey)
                            .then(response => {
                                const parsed = parseWaveAIResponse(response);
                                updateWaveAICard('gemini', 'ready', parsed);
                                return parsed;
                            })
                            .catch(error => {
                                updateWaveAICard('gemini', 'error', { error: error.message });
                                return null;
                            })
                    );
                }

                if (openaiKey) {
                    updateWaveAICard('openai', 'analyzing');
                    promises.push(
                        callOpenAIAPI(prompt, openaiKey)
                            .then(response => {
                                const parsed = parseWaveAIResponse(response);
                                updateWaveAICard('openai', 'ready', parsed);
                                return parsed;
                            })
                            .catch(error => {
                                updateWaveAICard('openai', 'error', { error: error.message });
                                return null;
                            })
                    );
                }

                const allResults = await Promise.all(promises);
                results.push(...allResults.filter(r => r !== null));

                if (results.length > 0) {
                    calculateWaveFinalVerdict(results);
                }

            } catch (error) {
                console.error('Wave AI error:', error);
                showToast('❌ 分析錯誤: ' + error.message);
            }

            btn.innerHTML = '🚀 啟動 AI 三方解析波浪理論';
            btn.disabled = false;
        }

        function updateWaveAICard(ai, status, result = null) {
            const statusEl = document.getElementById(`wave${ai.charAt(0).toUpperCase() + ai.slice(1)}Status`);
            const verdictEl = document.getElementById(`wave${ai.charAt(0).toUpperCase() + ai.slice(1)}Verdict`);
            const confidenceEl = document.getElementById(`wave${ai.charAt(0).toUpperCase() + ai.slice(1)}Confidence`);
            const analysisEl = document.getElementById(`wave${ai.charAt(0).toUpperCase() + ai.slice(1)}Analysis`);

            if (!statusEl) return;

            if (status === 'analyzing') {
                statusEl.textContent = '分析中...';
                statusEl.className = 'ai-status analyzing';
            } else if (status === 'ready' && result) {
                statusEl.textContent = '完成';
                statusEl.className = 'ai-status ready';
                
                const waveText = result.verdict === 'up' ? '上升浪 📈' : result.verdict === 'down' ? '下降浪 📉' : '整理浪 ↔️';
                verdictEl.textContent = waveText;
                verdictEl.className = 'ai-verdict-value ' + (result.verdict === 'up' ? 'buy' : result.verdict === 'down' ? 'sell' : 'hold');
                confidenceEl.style.width = result.confidence + '%';
                analysisEl.textContent = result.analysis;
            } else if (status === 'error') {
                statusEl.textContent = '錯誤';
                statusEl.className = 'ai-status error';
                analysisEl.textContent = result?.error || '發生錯誤';
            } else {
                statusEl.textContent = '待命';
                statusEl.className = 'ai-status';
                verdictEl.textContent = '-';
                confidenceEl.style.width = '0%';
                analysisEl.textContent = '等待分析...';
            }
        }

        function parseWaveAIResponse(response) {
            let verdict = 'neutral';
            let confidence = 50;
            let analysis = '';

            const verdictMatch = response.match(/【波浪判斷】\s*(上升浪|整理浪|下降浪)/);
            if (verdictMatch) {
                const v = verdictMatch[1];
                if (v === '上升浪') verdict = 'up';
                else if (v === '下降浪') verdict = 'down';
                else verdict = 'neutral';
            }

            const confidenceMatch = response.match(/【信心度】\s*(\d+)/);
            if (confidenceMatch) {
                confidence = Math.min(100, Math.max(0, parseInt(confidenceMatch[1])));
            }

            const sections = [];
            const structMatch = response.match(/【波浪結構分析】\s*([\s\S]*?)(?=【|$)/);
            if (structMatch) sections.push('🌊 波浪結構分析：\n' + structMatch[1].trim());
            
            const fibMatch = response.match(/【費波納契解讀】\s*([\s\S]*?)(?=【|$)/);
            if (fibMatch) sections.push('📐 費波納契解讀：\n' + fibMatch[1].trim());
            
            const predictMatch = response.match(/【後續走勢預測】\s*([\s\S]*?)(?=【|$)/);
            if (predictMatch) sections.push('🔮 後續走勢預測：\n' + predictMatch[1].trim());

            analysis = sections.length > 0 ? sections.join('\n\n') : response;

            return { verdict, confidence, analysis };
        }

        function calculateWaveFinalVerdict(results) {
            const votes = { up: 0, neutral: 0, down: 0 };
            let totalConfidence = 0;

            results.forEach(r => {
                if (r && r.verdict) {
                    votes[r.verdict]++;
                    totalConfidence += r.confidence;
                }
            });

            document.getElementById('waveUpCount').textContent = votes.up;
            document.getElementById('waveNeutralCount').textContent = votes.neutral;
            document.getElementById('waveDownCount').textContent = votes.down;

            let finalVerdict = 'neutral';
            let finalText = '整理浪 ↔️';

            if (votes.up > votes.neutral && votes.up > votes.down) {
                finalVerdict = 'up';
                finalText = '上升浪 📈';
            } else if (votes.down > votes.up && votes.down > votes.neutral) {
                finalVerdict = 'down';
                finalText = '下降浪 📉';
            }

            const resultEl = document.getElementById('waveFinalResult');
            resultEl.textContent = finalText;
            resultEl.className = 'final-verdict-result ' + (finalVerdict === 'up' ? 'buy' : finalVerdict === 'down' ? 'sell' : 'hold');

            const avgConf = results.length > 0 ? Math.round(totalConfidence / results.length) : 0;
            
            let summary = `🌊 波浪判斷結果：${finalText}\n`;
            summary += `📈 平均信心度：${avgConf}%\n`;
            summary += `🤖 參與分析 AI：${results.length}/3\n\n`;
            summary += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
            summary += `💡 綜合建議：\n`;
            
            if (finalVerdict === 'up') {
                summary += `目前處於上升浪階段，趨勢向上，可以考慮順勢操作，但注意波浪末端的反轉風險。`;
            } else if (finalVerdict === 'down') {
                summary += `目前處於下降浪階段，趨勢向下，建議觀望或減碼，等待修正浪結束再行布局。`;
            } else {
                summary += `目前處於整理浪階段，方向不明，建議等待突破後再確認方向。`;
            }

            document.getElementById('waveFinalSummary').textContent = summary;
            document.getElementById('waveFinalVerdict').style.display = 'block';
            
            // ====== 更新上方 AI 波浪燈號面板 ======
            const lightsPanel = document.getElementById('aiWaveLightsPanel');
            lightsPanel.style.display = 'block';
            
            // 更新燈號數字
            document.getElementById('aiWaveLightUpCount').textContent = votes.up;
            document.getElementById('aiWaveLightNeutralCount').textContent = votes.neutral;
            document.getElementById('aiWaveLightDownCount').textContent = votes.down;
            
            // 更新燈號圖示 (亮燈效果)
            document.getElementById('aiWaveLightUpIcon').textContent = votes.up > 0 ? '📈' : '⚫';
            document.getElementById('aiWaveLightNeutralIcon').textContent = votes.neutral > 0 ? '↔️' : '⚫';
            document.getElementById('aiWaveLightDownIcon').textContent = votes.down > 0 ? '📉' : '⚫';
            
            // 更新燈號背景亮度
            document.getElementById('aiWaveLightUp').style.background = votes.up > 0 ? 
                'rgba(16, 185, 129, 0.4)' : 'rgba(16, 185, 129, 0.1)';
            document.getElementById('aiWaveLightNeutral').style.background = votes.neutral > 0 ? 
                'rgba(245, 158, 11, 0.4)' : 'rgba(245, 158, 11, 0.1)';
            document.getElementById('aiWaveLightDown').style.background = votes.down > 0 ? 
                'rgba(239, 68, 68, 0.4)' : 'rgba(239, 68, 68, 0.1)';
            
            // 更新最終結果顯示
            const finalLightResult = document.getElementById('aiWaveFinalLightResult');
            if (finalVerdict === 'up') {
                finalLightResult.textContent = '📈 上升浪 - 順勢操作';
                finalLightResult.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.1))';
                finalLightResult.style.color = '#10b981';
                finalLightResult.style.border = '2px solid #10b981';
            } else if (finalVerdict === 'down') {
                finalLightResult.textContent = '📉 下降浪 - 觀望減碼';
                finalLightResult.style.background = 'linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0.1))';
                finalLightResult.style.color = '#ef4444';
                finalLightResult.style.border = '2px solid #ef4444';
            } else {
                finalLightResult.textContent = '↔️ 整理浪 - 等待突破';
                finalLightResult.style.background = 'linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(245, 158, 11, 0.1))';
                finalLightResult.style.color = '#f59e0b';
                finalLightResult.style.border = '2px solid #f59e0b';
            }
            
            // 更新簡短摘要
            let lightSummary = `AI 三方分析完成（${results.length}/3）| 平均信心度 ${avgConf}% | `;
            if (finalVerdict === 'up') {
                lightSummary += '處於上升浪，可考慮順勢操作，注意反轉風險';
            } else if (finalVerdict === 'down') {
                lightSummary += '處於下降浪，建議觀望或減碼，等待修正完成';
            } else {
                lightSummary += '處於整理浪，方向不明，建議等待突破確認';
            }
            document.getElementById('aiWaveFinalLightSummary').textContent = lightSummary;
        }

        // ===== iPad 平板專用模式 =====
        let isTabletMode = false;

        // 切換平板模式
        function toggleTabletMode() {
            isTabletMode = !isTabletMode;
            document.body.classList.toggle('tablet-mode', isTabletMode);
            
            const btn = document.getElementById('tabletModeBtn');
            if (btn) {
                btn.innerHTML = isTabletMode 
                    ? '🖥️ 桌面模式' 
                    : '📱 iPad模式';
            }
            
            // 儲存設定
            localStorage.setItem('tabletMode', isTabletMode ? 'true' : 'false');
            
            showToast(isTabletMode ? '📱 已切換為 iPad 平板模式' : '🖥️ 已切換為桌面模式');
        }

        // 載入平板模式設定
        function loadTabletMode() {
            const saved = localStorage.getItem('tabletMode');
            if (saved === 'true') {
                isTabletMode = true;
                document.body.classList.add('tablet-mode');
                const btn = document.getElementById('tabletModeBtn');
                if (btn) {
                    btn.innerHTML = '🖥️ 桌面模式';
                }
            }
        }

        // 自動偵測 iPad
        function detectiPad() {
            const isIPad = /iPad/.test(navigator.userAgent) || 
                (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const screenWidth = window.screen.width;
            const screenHeight = window.screen.height;
            
            // 12.9" iPad Pro 解析度約 1024x1366 或 2048x2732
            if (isIPad || (screenWidth >= 1024 && screenWidth <= 1400 && screenHeight >= 700)) {
                document.body.classList.add('auto-tablet');
            }
        }

        // 頁面載入時載入 API 金鑰
        document.addEventListener('DOMContentLoaded', function() {
            loadApiKeys();
            loadTabletMode();
            detectiPad();
        });
    </script>

    <!-- iPad 平板模式切換按鈕 -->
    <button id="tabletModeBtn" class="tablet-mode-toggle" onclick="toggleTabletMode()">
        📱 iPad模式
    </button>
</body>
</html>
